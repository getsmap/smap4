var sMap={config:{},db:{},moduleConfig:{}};sMap.langDict={"sv-SE":{errNoBaseNorOverlays:"Config-filen innehåller inga lager (varken overlays eller baselayers).",errMapNotInit:"Kartan kunde inte initieras.",errWebParamLayerNotFound:"Lagret som angavs i URL:en finns inte.",errBaselayerDoesNotExist:"Kan inte ändra till angivet baslager eftersom det inte finns.",tooManyStyleSheets:"Det är för många stylesheets <link /> inlänkade från index-filen - IE klarar max 31 st.",warnLangNotSupportedByFramework:"Angivet språk stöds inte av alla sMap-moduler och/eller sMap.langDict (se sMap.js)."},en:{errNoBaseNorOverlays:"The config file does not contain any layers (neither overlays nor baselayers).",errMapNotInit:"The map could not be initialized",errWebParamLayerNotFound:"The layer in the URL does not exist.",errBaselayerDoesNotExist:"Cannot set baselayer since it does not exist.",tooManyStyleSheets:"There are too many stylesheets <link /> linked in from the index file - IE can take a max. of 31 stylesheets.",warnLangNotSupportedByFramework:"The language is not supported by all sMap-modules and/or sMap.langDict (see sMap.js)."}};sMap.cmd={addtoolbardiv:function(a){sMap.divController.addToolbarDiv(a)},removetoolbardiv:function(a){sMap.divController.removeToolbarDiv(a)},addsidedivright:function(a){sMap.divController.addSideDivRight(a)},removesidedivright:function(a){sMap.divController.removeSideDivRight(a)},addsidedivleft:function(a){sMap.divController.addSideDivLeft(a)},removesidedivleft:function(a){sMap.divController.removeSideDivLeft(a)},addmodules:function(a){a.modules=a.modules||null;sMap.moduleController.addModules(a.modules)},removemodules:function(a){sMap.moduleController.removeModules(a.modules)},translatemodules:function(a){a.lang=a.lang||null;sMap.Lang.translateModules(a.lang)},activate:function(b){var a=sMap.map.getControlsByClass(b.module).length?sMap.map.getControlsByClass(b.module)[0]:null;if(a){a.activate()}},deactivate:function(b){var a=sMap.map.getControlsByClass(b.module).length?sMap.map.getControlsByClass(b.module)[0]:null;if(a){a.deactivate()}},addlayerwithconfig:function(a){sMap.layer.addLayerWithConfig(a.config)},addlayer:function(a){sMap.layer.addLayer(a.layer)},removelayer:function(a){sMap.layer.removeLayer(a.layer)},showlayer:function(a){sMap.layer.showLayer(a.layerName)},hidelayer:function(a){sMap.layer.hideLayer(a.layerName)},hidealllayers:function(){sMap.layer.hideAllLayers()},setbaselayer:function(a){sMap.layer.setBaseLayer(a.layerName)},getLayerConfig:function(b){var a=sMap.cmd.getLayerConfigsBy("name",b);if(a){return a[0]}else{return a}},getLayerConfigsBy:function(key,value){var keyArr=key.split("."),matches=[],layers=sMap.config.layers.overlays.concat(sMap.config.layers.baselayers||[]);for(var i=0,len=layers.length;i<len;i++){var t=layers[i];var val=null;if(keyArr.length){try{val=eval("t."+key)}catch(e){}}if(val){if(val.toUpperCase()===value.toUpperCase()){matches.push(t)}}}return matches},getParamsAsObject:function(){return sMap.webParams.getParamsAsObject()},getParamsAsString:function(a){return sMap.webParams.getParamsAsString(a)},getStartingParamsAsObject:function(){return sMap.webParams.getStartingParamsAsObject()},loading:function(b,d){d=d||{};if($.browser.msie&&parseInt($.browser.version)<8){return}var c=this;if($.browser.msie&&parseInt($.browser.version)<9){return false}if(b&&b===true){this.aboutToShow=true;if(!this.loader){if(CanvasLoader){var a=new CanvasLoader("mapDiv");this.loader=a;a.setDiameter(88);a.setDensity(55);a.setRange(0.7);a.setSpeed(3)}else{return false}}if(d.color){this.loader.setColor(d.color)}else{this.loader.setColor("#444444")}this.loader.show();if(d.bg&&d.bg===true){if(!this.loaderBg){this.loaderBg=$('<div id="smap-loader-bg" />');$("body").append(this.loaderBg)}this.loaderBg.show();setTimeout(function(){c.loaderBg.addClass("smap-loaderbg-visible")},1)}}else{this.aboutToShow=false;if(this.loader){setTimeout(function(){if(d.fast){c.loader.hide();c.loaderBg.removeClass("smap-loaderbg-visible");c.loaderBg.hide()}else{if(!c.aboutToShow){c.loader.hide();if(c.loaderBg){c.loaderBg.removeClass("smap-loaderbg-visible");setTimeout(function(){c.loaderBg.hide()},400)}}}},400)}}}};sMap.DivController=OpenLayers.Class({initialize:function(a){this.map=a},bindOnWindowResize:function(){var a=this;$(window).on("resize",function(){a.map.updateSize()})},addToolbarDiv:function(c){if($("#toolbarDiv").length){return}var a=$("<div id='toolbarDiv' />"),b=c.height||20;$("#smapDiv").prepend(a)},removeToolbarDiv:function(g){if($("#toolbarDiv").length==0){return}var d=$("#toolbarDiv").outerHeight();$("#toolbarDiv").empty().remove();var c=[$("#mapDiv"),$("#sideDivLeft"),$("#sideDivRight")];for(var b=0,a=c.length;b<a;b++){var h=c[b];if(h.length){$(h).css({top:sMap.util.trimCSS($(h).css("top"))-d+"px"});$(h).outerHeight($(h).outerHeight()+d)}}$("#smapDiv").children().each(function(){});$(window).resize();this.map.updateSize()},removeSideDivLeft:function(a){if($("#sideDivLeft").length==0){return}$("#sideDivLeft").empty().remove()},removeSideDivRight:function(c){var a=$("#sideDivRight");if(a.length==0){return}var b=a.outerWidth();a.empty().remove();$("#mapDiv").width($("#mapDiv").width()+b);$(window).resize()},hideSideDivRight:function(b){var a=$("#sideDivRight");if(a.length==0){return}a.hide()},addSideDivRight:function(b){if($("#sideDivRight").length){return}var a=$("<div id='sideDivRight' />");$("#smap-map-container").append(a)},addSideDivLeft:function(a){if($("#sideDivLeft").length){return}var b=$("<div id='sideDivLeft' />");$("#smapDiv").append(b)},CLASS_NAME:"sMap.DivController"});sMap.Events=OpenLayers.Class(OpenLayers.Events,{initialize:function(){OpenLayers.Events.prototype.initialize.apply(this,arguments)},funcBoundToEvent:function(k,d,a){var l=this.listeners[k],e=null,a=a.toString(),h=d.CLASS_NAME?d.CLASS_NAME:null,m=null,j=null,b=null;for(var c=0,g=l.length;c<g;c++){e=l[c].func;m=l[c].obj;j=m.CLASS_NAME?m.CLASS_NAME:null;b=e.toString()==a;if(h&&j&&h===j&&b){return true}}return false},triggerEvent:function(g,b,c){var e=this.listeners[g];if(!e||e.length==0){return undefined}if(c==null){c={}}c.object=this.object;c.element=this.element;if(!c.type){c.type=g}c.caller=b;e=e.slice();var h;for(var d=0,a=e.length;d<a;d++){var j=e[d];h=j.func.apply(j.obj,[c]);if((h!=undefined)&&(h==false)){break}}if(!this.fallThrough){OpenLayers.Event.stop(c,true)}return h},CLASS_NAME:"sMap.Events"});sMap.Lang={code:null,lang:{},defaultCode:"sv-SE",getCode:function(){if(!sMap.Lang.code){sMap.Lang.code=this.defaultCode}return sMap.Lang.code},setCode:function(b){var d;if(!sMap.config||!sMap.config.modules){d=b||sMap.Lang.defaultCode;sMap.Lang.code=d;return}if(!b){b=(OpenLayers.Util.getBrowserName()=="msie")?navigator.userLanguage:navigator.language}var c=b.split("-");c[0]=c[0].toLowerCase();var e=this.frameworkSupportsLang(c[0]);if(e.length==0){d=c[0]}if(c[1]){var a=c[0]+"-"+c[1].toUpperCase();e=this.frameworkSupportsLang(a);if(e.length==0){d=a}}if(e.length){debug.warn(sMap.langDict[sMap.Lang.defaultCode].warnLangNotSupportedByFramework+" Code: "+b+" is not supported by: "+e.join(", "));d=sMap.Lang.defaultCode}if(!d){OpenLayers.Console.warn("Failed to find sMap.Lang.lang."+c.join("-")+" dictionary, falling back to default language");d=sMap.Lang.defaultCode}debug.log("Now using lang code: "+d);sMap.Lang.code=d},frameworkSupportsLang:function(g){var c=sMap.config.modules||[];var b,h,a,j,k=[];for(var d=0,e=c.length;d<e;d++){b=sMap.Lang.lang;a=c[d].init.prototype.CLASS_NAME;MODULE_NAME=a.replace("sMap.Module.","");j=MODULE_NAME.split(".");for(var d=0,e=j.length;d<e;d++){b=b[j[d]]}if(typeof b[g]!="object"){k.push(a)}}if(!sMap.langDict[g] instanceof Object){k.push("SMAP-CORE")}return k},translate:function(b,a){var d=sMap.Lang.lang[sMap.Lang.getCode()];var c=d&&d[b];if(!c){c=b}if(a){c=OpenLayers.String.format(c,a)}return c},translateModules:function(a){if(a&&typeof(a)=="string"){sMap.Lang.setCode(a)}a=sMap.Lang.getCode();sMap.moduleController.removeModules();sMap.moduleController.addModules()}};OpenLayers.i18n=sMap.Lang.translate;sMap.Layer=OpenLayers.Class({layersLoading:0,addedLayers:[],initialize:function(b,a){a=a||{};this.map=b;this.map.events.register("removelayer",this,function(){var g=this.map.layers,e=null;for(var d=0,c=g.length;d<c;d++){e=g[d];if(e.zIndex){e.setZIndex(e.zIndex)}}})},addLayer:function(c){var g="loadstart",a="loadend",e=["Google"];if(!sMap.events.mapInitiated){e.push("WMS")}var b=$.inArray(c.CLASS_NAME.split(".")[2],e)===-1;if(c.protocol){b=false}if(b===true){c.events.register(g,this,function(){this.registerLoadingProgress(1);if(!this.triggeredStartedLoading){this.triggeredStartedLoading=true;sMap.cmd.loading(true,{bg:false});sMap.events.triggerEvent("layersstartedloading",this,{layer:c})}});var d=function(h){this.registerLoadingProgress(-1)};c.events.register(a,this,d)}else{this.registerLoadingProgress(0)}this.map.addLayer(c);if(c.zIndex){c.setZIndex(c.zIndex)}this.addedLayers.push(c.name);sMap.events.triggerEvent("layervisible",this,{layer:c})},addLayerWithConfig:function(m){m=m||{};if(!m.layerType){return false}m.options=m.options||{};m.options.isBaseLayer=m.options.isBaseLayer||false;if($.inArray(m.name,this.addedLayers)!==-1){return false}var a=m.layerType?m.layerType.toUpperCase():null,u=null;if(a==="WMS"){m.options=m.options||{};m.options.transitionEffect=m.options.transitionEffect||"resize";if(m.filter){var o,k=m.filter.version;if(!k){o=new OpenLayers.Format.Filter.v1_1_0()}else{switch(k){case"1.1.0":o=new OpenLayers.Format.Filter.v1_1_0();break;case"1.0.0":o=new OpenLayers.Format.Filter.v1_0_0();break;default:o=new OpenLayers.Format.Filter.v1_1_0()}}m.params.filter=new OpenLayers.Format.XML().write(o.write(m.filter))}u=new OpenLayers.Layer.WMS(m.name,m.URL,m.params,m.options);if(m.params.format=="image/jpeg"){u.params.FORMAT="image/jpeg"}}else{if(a==="TILECACHE"){m.options=m.options||{};m.options.transitionEffect=m.options.transitionEffect||"resize";u=new OpenLayers.Layer.TileCache(m.name,m.URL,m.layer,m.options)}else{if(a==="VECTOR"){var c=m.geomType?m.geomType.toUpperCase():"point";var p=this.makeStyleMap(m.style,c);var b=$.extend(true,{},(m.options||{}),{rendererOptions:{yOrdering:true,zIndexing:true},styleMap:p,strategies:m.strategies,protocol:m.protocol});b.isBaseLayer=b.isBaseLayer||false;u=new OpenLayers.Layer.Vector(m.name,b);if(!m.protocol){var s=m.format?m.format.toUpperCase():null;var n=null;if(s=="GEOJSON"){n=new OpenLayers.Format.GeoJSON()}else{if(s=="GEORSS"){n=new OpenLayers.Format.GeoRSS()}else{if(s=="WKT"){n=new OpenLayers.Format.WKT()}else{if(s){n=s}else{debug.warn("Lagret: "+m.name+" har inget angivet/passande format. Ändra detta i config-filen.");return}}}}var d=m.URL;this.map.events.register("zoomend",this,function(i){u.redraw()});var e,r,q,h,g;$.ajax({url:config.proxy?config.proxy+d:d,context:this,dataType:"text",success:function(w){var i=n.read(w);if(m.shiftCoords){for(q=0,len=i.length;q<len;q++){r=i[q];h=r.geometry.x;g=r.geometry.y;r.geometry.x=g;r.geometry.y=h}}if(m.transformFrom){var v=new OpenLayers.Projection(m.transformFrom),t=new OpenLayers.Projection(this.map.projection);for(q=0,len=i.length;q<len;q++){r=i[q];r.geometry.transform(v,t)}}u.addFeatures(i);sMap.events.triggerEvent("vectorloaded",this,{layerName:u.name})},error:function(t,i,v){debug.log("Layer request error "+i)},complete:function(){}})}}else{if(a=="GOOGLE"){u=new OpenLayers.Layer.Google(m.name,m.options)}else{if(a=="OSM"){m.options=m.options||{};m.options.transitionEffect=m.options.transitionEffect||"resize";u=new OpenLayers.Layer.OSM(m.name)}else{if(a=="ARCGISCACHE"){u=new OpenLayers.Layer.ArcGISCache(m.name,m.URL,m.options);u.maxExtent=this.map.maxExtent}else{if(a==="TMS"){m.options=m.options||{};m.options.transitionEffect=m.options.transitionEffect||"resize";u=new OpenLayers.Layer.TMS(m.name,m.URL,m.options)}else{if(a==="WMTS"){var j=m.options.resolutions?m.options.resolutions.length:this.map.resolutions.length;var l=m.matrixIds?m.matrixIds:new Array(j);if(m.matrixSetTops&&m.matrixSetTops.length){for(var q=0;q<j;++q){l[q]={identifier:m.matrixSet+":"+q,topLeftCorner:new OpenLayers.LonLat(m.matrixSetLeft,m.matrixSetTops[q])}}}u=new OpenLayers.Layer.WMTS({name:m.name,url:m.URL,layer:m.layer,style:m.style,matrixSet:m.matrixSet,matrixIds:l,format:m.options.format||"image/jpg",attribution:m.options.attribution||"",transitionEffect:m.options.transitionEffect||"resize",buffer:m.options.buffer||0,isBaseLayer:m.options.isBaseLayer||true,options:m.options})}else{return}}}}}}}}if(m.displayInLayerSwitcher){u.displayInLayerSwitcher=true;u.options.displayInLayerSwitcher=true}u.selectable=m.selectable||false;this.addLayer(u)},removeLayer:function(b){var a=this.addedLayers.indexOf(b.name);this.addedLayers.splice(a,1);this.map.removeLayer(b);if(b){sMap.events.triggerEvent("layerhidden",this,{layer:b});b.destroy();b=null}},addOverlays:function(d){for(var c=0,a=d.length;c<a;c++){var b=d[c];if(b.startVisible===true){this.addLayerWithConfig(b)}}},showLayer:function(a){var c=this.map.getLayersByName(a)[0];if(!c){var b=sMap.cmd.getLayerConfig(a);this.addLayerWithConfig(b);c=this.map.getLayersByName(a)[0]}if(c.getVisibility()!==true){c.setVisibility(true);c.visibility=true;sMap.events.triggerEvent("layervisible",this,{layer:c})}},hideLayer:function(a){var b=this.map.getLayersByName(a)[0];if(b&&b.getVisibility()){b.setVisibility(false);sMap.events.triggerEvent("layerhidden",this,{layer:b})}},hideAllLayers:function(){var h=sMap.config.layers.overlays,j=[],g=null,c=null,b=null,e=null;for(var d=0,a=h.length;d<a;d++){b=this.map.getLayersByName(h[d].name);g=b.length?b[0]:null;if(g&&g.getVisibility()&&!g.isBaseLayer&&g.displayInLayerSwitcher){j.push(g.name)}}for(var d=0,a=j.length;d<a;d++){c=j[d];this.hideLayer(c)}},setBaseLayer:function(a){var b=this.map.getLayersByName(a)[0];if(b){this.map.setBaseLayer(b)}else{debug.error(sMap.lang.errBaselayerDoesNotExist+" layerName: "+a)}},addBaselayers:function(d){if(!d||!d.length){this.map.allOverlays=true;return}for(var c=0,a=d.length;c<a;c++){var b=d[c];this.addLayerWithConfig(b);if(!this.startingBaselayerName){this.startingBaselayerName=b.name}}this.map.setBaseLayer(this.map.getLayersByName(this.startingBaselayerName)[0])},registerLoadingProgress:function(a){this.layersLoading+=a;if(this.layersLoading<=0){sMap.events.triggerEvent("layersloaded",this,{});sMap.cmd.loading(false);sMap.events.layersLoaded=true;this.triggeredStartedLoading=false}},makeStyleMap:function(l,j){l=l||{};j=j||"point";j=j.toUpperCase();var k=l["default"]||{},d=l.select||{},m={},b={};var e={POINT:200,LINE:100,POLYGON:0};if(j=="POINT"){m={pointRadius:5,strokeOpacity:1,strokeWidth:1,fillOpacity:1,fillColor:"#ffffff",zIndex:e[j],graphicXOffset:0,graphicYOffset:0,zIndex:e[j]};b={pointRadius:7,strokeOpacity:1,fillOpacity:1,fillColor:"#33ffff",strokeColor:"#33ffff",strokeWidth:2,graphicXOffset:0,graphicYOffset:0,zIndex:e[j]}}else{if(j=="LINE"){m={strokeOpacity:1,strokeWidth:2,zIndex:e[j]};b={strokeWidth:10,strokeColor:"#33ffff",zIndex:e[j]}}else{if(j=="POLYGON"){m={strokeOpacity:1,fillOpacity:0.5,strokeWidth:2,zIndex:e[j]};b={strokeOpacity:1,fillOpacity:0.5,strokeWidth:2,strokeColor:"#33ffff",fillColor:"#33ffff",zIndex:e[j]}}}}var c=$.extend({},m,k),a=$.extend({},b,d);var h=c.rules||null,g=a.rules||null;var i=new OpenLayers.StyleMap({"default":new OpenLayers.Style(c,h),select:new OpenLayers.Style(a,g)});return i},CLASS_NAME:"sMap.Layer"});sMap.Map=OpenLayers.Class({EVENT_TRIGGERS:["modulesadded","beforemodulesactivated","aftermodulesactivated","layersadded","layersstartedloading","layersloaded","maploaded","creatingwebparams","beforeapplyingwebparams","afterapplyingwebparams","layervisible","layerhidden"],EVENT_LISTENERS:["addmodules","removemodules","translatemodules","activate","deactivate","showlayer","hidelayer","setbaselayer","addlayerwithconfig","addlayer","removelayer","addsidedivleft","addsidedivright","addtoolbardiv","removesidedivleft","removesidedivright","removetoolbardiv"],jqThemes:{"flashy-gray":"lib/jquery-ui-1.8.18.custom/css/flashy-gray/jquery-ui-1.8.18.custom.css","full-gray":"lib/jquery-ui-1.8.18.custom/css/full-gray/jquery-ui-1.10.1.custom.min.css","full-gray-flat":"lib/jquery-ui-1.8.18.custom/css/full-gray-flat/jquery-ui-1.10.3.custom.min.css","gray-flat":"lib/jquery-ui-1.8.18.custom/css/gray-flat/jquery-ui-1.10.3.custom.min.css","gray-blue":"lib/jquery-ui-1.8.18.custom/css/gray-blue/jquery-ui-1.10.1.custom.min.css",orange:"lib/jquery-ui-1.8.18.custom/css/orange/jquery-ui-1.10.1.custom.min.css",kristianstad:"lib/jquery-ui-1.8.18.custom/css/kristianstad/jquery-ui-1.10.2.custom.min.css"},initialize:function(c,b){this.mapTag=c||null;this.addLibs();var b=null;var a=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters());var d=a.CONFIG||"configs/config.js";if(d.search(/\//gi)===-1){d="configs/"+d}if(d){$.ajax({url:d,dataType:"script",async:true,context:this,success:function(){b=window.config;this.onConfigLoaded(a,b)},error:function(g,e,h){if(e==="parsererror"){debug.error("Config-filen lästes in men kunde inte tolkas p g a ett fel i den.")}debug.error(g+":"+e+":"+h)}})}},addLibs:function(){var e=[{src:"lib/heartcode-canvasloader-min.js",constraint:function(){if($.browser.msie&&parseInt($.browser.version)<9){return false}else{return true}}}],d=null,c;for(var b=0,a=e.length;b<a;b++){c=e[b];if(c.constraint&&c.constraint()===false){continue}else{d=document.createElement("script");d.type="text/javascript";d.src=c.src;$("head").append(d)}}},onConfigLoaded:function(b,c){var a=this;if(c instanceof Object){sMap.config=c}if(!sMap.config instanceof Object){debug.warn("You have not specified a valid config object for the map.")}this.config=sMap.config;sMap.db.browser=$.browser;sMap.events=new sMap.Events(this,null,null);this.addSmapEventTypes();var d=this.validateConfig(sMap.config);if(c.proxyHost){OpenLayers.ProxyHost=c.proxyHost}var g=b.LANG||sMap.Lang.getCode();sMap.langCode=g;sMap.lang=sMap.langDict[g];sMap.Lang.setCode(g);if(d===true){if(c.onConfigLoaded&&typeof(c.onConfigLoaded)==="function"){c.onConfigLoaded(c,e)}else{e.call(this)}}else{debug.error(sMap.lang.errMapNotInit)}function e(){c.jqTheme=c.jqTheme||"full-gray";var j=a.jqThemes[c.jqTheme];if($.browser.msie&&parseInt($.browser.version)<=8&&document.createStyleSheet){document.createStyleSheet(j)}else{var n=$('<link rel="stylesheet" type="text/css"></link>');n.attr("href",j);$("head").append(n)}var m=sMap.config.layers.overlays;for(var l=0,h=m.length;l<h;l++){var k=m[l];if(!(k instanceof Object)){alert("Det verkar som att det finns ett komma för mycket i config-filens overlays-vektor")}if(k.layerType.toUpperCase()=="WMS"){a.createLegendURL(k)}}a.main()}},createLegendURL:function(a){if(!a.style){a.style={}}if(!a.style["default"]){a.style["default"]={}}if(a.style["default"].externalGraphic===undefined){a.style["default"].externalGraphic=OpenLayers.Util.urlAppend(a.URL,"request=GetLegendGraphic&format=image/png&width=20&height=20&layer="+a.params.layers)}a.style.select=a.style.select||{};if(!a.dontUseDefaultExternalGraphic){if(a.style.select.externalGraphic==undefined){a.style.select.externalGraphic=a.style["default"].externalGraphic}}},main:function(){this.addProjectionDefs();sMap.events.layersLoaded=(config.layers.overlays.length||config.layers.baselayers.length)?false:true;sMap.events.modulesAdded=(config.modules.length)?false:true;sMap.events.register("layersloaded",this,function(a){sMap.events.layersLoaded=true;this.checkIfMapLoaded()});sMap.events.register("modulesadded",this,function(a){sMap.events.modulesAdded=true;this.checkIfMapLoaded()});this.createDivs(this.mapTag);this.createMap(this.config);sMap.webParams=new sMap.WebParams(this.map);sMap.layer=new sMap.Layer(this.map);sMap.divController=new sMap.DivController(this.map);sMap.divController.bindOnWindowResize();sMap.moduleController=new sMap.ModuleController(this.map);sMap.layer.addBaselayers(sMap.config.layers.baselayers);sMap.layer.addOverlays(sMap.config.layers.overlays);sMap.events.triggerEvent("layersadded",this,{});sMap.moduleController.addModules(this.config.modules);sMap.webParams.applyParams();sMap.events.mapInitiated=true},addSmapEventTypes:function(){var d=this.EVENT_TRIGGERS,c=this.EVENT_LISTENERS;if(c.length){for(var b=0,a=c.length;b<a;b++){sMap.events.addEventType(c[b]);var e=sMap.cmd[c[b]];if(!e){var g=this.CLASS_NAME+" has EVENT_LISTENER(S) "+c[b]+" registered\nbut no method with same name.";debug.warn(g)}else{sMap.events.register(c[b],this,e)}}}if(d.length){for(var b=0,a=d.length;b<a;b++){sMap.events.addEventType(d[b])}}},addmodule:function(a){a.config=a.config||null;this.moduleController.addModule(a.module,a.config)},removemodule:function(a){sMap.moduleController.removeModule(a.module)},checkIfMapLoaded:function(){if(sMap.events.mapLoaded===true){return}if(sMap.events.layersLoaded===true&&sMap.events.modulesAdded===true){sMap.events.mapLoaded=true;sMap.events.triggerEvent("maploaded",this,{});if($.browser.msie&&parseInt($.browser.version)<8){$(".smap-init-loading").empty().remove()}else{$(".smap-init-loading").addClass("invisible");$(".smap-init-loading").empty();setTimeout(function(){$(".smap-init-loading").empty().remove();$(window).resize()},1000)}}},validateConfig:function(config){var ok=false;var nrOfStyleSheets=document.getElementsByTagName("link").length;if(nrOfStyleSheets>31){debug.error(sMap.lang.tooManyStyleSheets);ok=false}else{ok=true}var overlays=config.layers.overlays,baselayers=config.layers.baselayers;if((!overlays||!overlays.length)&&(!baselayers||!baselayers.length)){debug.error(sMap.lang.errNoBaseNorOverlays);ok=false}for(var i=0,len=overlays.length;i<len;i++){var t=overlays[i];if(!(t instanceof Object)){alert("Det verkar som att det finns ett komma för mycket i config-filens overlays-vektor")}if(!t.name){var dispName=encodeURIComponent(t.displayName);debug.warn("Layer with index "+i+' does not have a name in its config. Using the displayName instead: "'+dispName+'"');t.name=dispName}}for(var i=0,len=baselayers.length;i<len;i++){var t=baselayers[i];if(!(t instanceof Object)){alert("Det verkar som att det finns ett komma för mycket i config-filens baselayers-vektor")}if(!t.name){debug.warn("Layer does not have a name in its config. Using the displayName instead: "+t.displayName);t.name=encodeURIComponent(t.displayName)}}var modules=config.modules;for(var i=0,len=modules.length;i<len;i++){var t=modules[i];t.init=t.init&&typeof(t.init)=="string"?eval(t.init):t.init}if(config.proxyHost&&config.proxyHost instanceof Object&&config.proxyHost[document.domain]){config.proxyHost=config.proxyHost[document.domain]||null}return ok},createDivs:function(c){var b=$("<div id='mapDiv' />"),d=$("<div id='smapDiv' />"),a=$('<div id="smap-map-container" />');$(c).append(d);d.append(a);a.append(b)},createMap:function(c){var b=c.maxExtent,a=c.resolutions;this.map=new OpenLayers.Map("mapDiv",{projection:c.projection,displayProjection:c.displayProjection,resolutions:a,maxResolution:c.maxResolution||"auto",numZoomLevels:c.numZoomLevels||"auto",zoomMethod:c.zoomMethod===null?null:OpenLayers.Easing.Quad.easeOut,controls:[new OpenLayers.Control.Attribution()],units:c.units,maxExtent:b instanceof Object?new OpenLayers.Bounds(b.w,b.s,b.e,b.n):"auto"});this.map.addControl(new OpenLayers.Control.Navigation({handleRightClicks:true,documentDrag:true,zoomBoxEnabled:true}));$(this.map.viewPortDiv).add("#mapDiv").addClass("smapCursorHand");sMap.map=this.map},addProjectionDefs:function(){Proj4js.defs["EPSG:4326"]="+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";Proj4js.defs["EPSG:3857"]="+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs";Proj4js.defs.GOOGLE=Proj4js.defs["EPSG:3857"];Proj4js.defs["EPSG:900913"]=Proj4js.defs["EPSG:3857"];Proj4js.defs["EPSG:3008"]="+proj=tmerc +lat_0=0 +lon_0=13.5 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";Proj4js.defs["EPSG:3006"]="+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";Proj4js.defs["EPSG:3021"]="+proj=tmerc +lat_0=0 +lon_0=15.8062845294444 +k=1.00000561024+x_0=1500064.274 +y_0=-667.711 +ellps=GRS80 +units=m"},CLASS_NAME:"sMap.Map"});sMap.ModuleController=OpenLayers.Class({toBeActivated:0,modulesAdded:false,modules:[],controlsToBeActivated:[],initialize:function(a){this.map=a},addModules:function(b){b=b||sMap.config.modules;for(var d=0,a=b.length;d<a;d++){var c=b[d];var e=typeof c.init=="String"?c.init:c.init.prototype.CLASS_NAME;this.addModule(e,c.config)}sMap.events.register("modulesadded",this,function(k){var h=this.controlsToBeActivated;sMap.events.triggerEvent("beforemodulesactivated",this,{modules:this.controlsToBeActivated});for(var j=0,g=h.length;j<g;j++){h[j].activate()}sMap.events.triggerEvent("aftermodulesactivated",this,{modules:this.controlsToBeActivated})});sMap.events.triggerEvent("modulesadded",this,{});sMap.events.modulesAdded=true},removeModules:function(b){for(var c=0,a=b.length;c<a;c++){this.removeModule(b[c])}},getFileConfig:function(d){var c=typeof d=="string"?d:d.prototype.CLASS_NAME;var e=c.split(".");var b=e[e.length-1];var a="modules/Module/"+b+"/"+b+"_conf.js";$.ajax({type:"GET",dataType:"script",async:false,url:a});return module_config},addModule:function(constructor,config){var className=typeof constructor=="string"?constructor:constructor.prototype.CLASS_NAME;if(typeof constructor=="string"){constructor=eval(constructor)}if(!className){debug.error("Module "+className+" does not exist.");return}var ctrl=new constructor(config);this.map.addControl(ctrl);if(config.initType=="control"){return}if(ctrl.activateFromStart===true){this.controlsToBeActivated.push(ctrl)}this.modules.push(ctrl)},removeModule:function(a){this.map.removeControl(a);a.destroy()},CLASS_NAME:"sMap.ModuleController"});sMap.util={getScaleFromResolution:function(b){var a=sMap.map.getUnits();scale=OpenLayers.Util.getScaleFromResolution(b,a);return scale},createUniqueId:function(a){this.nbr=!this.nbr;a=a||"";this.nbr=typeof this.nbr==="undefined"?0:this.nbr+1;return a+this.nbr},disableMapInteraction:function(a){$(a).dblclick(function(b){OpenLayers.Event.stop(b)});$(a).mousedown(function(b){OpenLayers.Event.stop(b)});$(a).click(function(b){OpenLayers.Event.stop(b)})},getNearestFeature:function(e,h){if(e.length){var a=new OpenLayers.Geometry.Point(h.lon,h.lat);var d,g,j;var b=Number.MAX_VALUE;for(var c=0;c<e.length;++c){d=e[c];if(d.geometry){j=a.distanceTo(d.geometry,{edge:false});if(j<b){b=j;g=d;if(b==0){break}}}}return g}},extractAttributes:function(attributes,text){function extractAttribute(a,txt){var index=txt.search(/\${/g);if(index!==-1){var extractedAttribute="";var attr=text.substring(index+2);var endIndex=0;if(attr.substring(0,8)==="function"){endIndex=sMap.util.getFunctionEnd(attr)}else{endIndex=attr.search(/\}/g)}attr=attr.substring(0,endIndex);if(attr.substring(0,8)==="function"){var theFunc=attr.replace("function","function f");eval(theFunc);extractedAttribute=f.call(this,a)}else{extractedAttribute=a[attr]||""}txt=txt.replace("${"+attr+"}",extractedAttribute)}return txt}var index=text.search(/\${/g);while(index!==-1){text=extractAttribute(attributes,text);index=text.search(/\${/g)}return text},getFunctionEnd:function(e){var c=1,b=false,d=e.search(/\{/g);e=e.substring(d+1);var a=0;for(a=0,len=e.length;a<len;a++){if(e.charAt(a)==="{"){c+=1}else{if(e.charAt(a)==="}"){c-=1}}if(c===0){b=true;a=a+d+2;break}}if(!b){a=-1}return a},addQMark:function(a){if(a.indexOf(a.length-1)!="?"){a+="?"}return a},addSlash:function(a){if(a.indexOf(a.length-1)!="/"){a+="/"}return a},getGeomType:function(c){var b=c.getArea(),a=c.getLength();if(b==0&&a==0){return"point"}else{if(b==0&&a>0){return"line"}else{if(b>0&&a>0){return"polygon"}else{return null}}}},getMapOrigo:function(){return $("#mapDiv").position()},trimCSS:function(a){a=a.replace("px","").replace("em","").replace("pt","");return parseFloat(a)},paramsObjToString:function(b){var d="";for(var a in b){var c=b[a];d=d+"&"+a+"="+c}d=d.substring(1);return d},indexOf:function(b,d){if(navigator.appName=="Microsoft Internet Explorer"){for(var c=0,a=b.length;c<a;c++){if(b[c]==d){return c}}return -1}else{return b.indexOf(d)}},getParameterValueFromURL:function(b,e){b=b.toLowerCase();e=e.toLowerCase();var d=null;var a=b.search(e+"=");if(a!=-1){var c=b.split(e+"=")[1];d=c.split("&")[0]}return d},infoDialog:function(d,b){var a={resizable:true};$.extend(a,b);var c=d.dialog(a);return c},createDialog:function(c,a){a=a||{};var b={titleText:"",position:[68,40],minWidth:50,minHeight:50,modal:false,draggable:true};a=$.extend(true,b,a);c.dialog({autoOpen:false,title:a.title||a.titleText,closeOnEscape:a.closeOnEscape===false?false:true,bgiframe:true,width:a.width,height:a.height,minWidth:a.minWidth,minHeight:a.minHeight,maxHeight:a.maxHeight,modal:a.modal,resizable:a.resizable,draggable:a.draggable,position:a.position,buttons:a.buttons,dragStart:function(g,d){},dragStop:function(g,d){if(a.dragStop!=null){a.dragStop.call(g,d)}},focus:a.onFocus,close:a.onClose,show:a.onShow,open:function(g,d){if($.browser.msie){$("#smapDiv").hide().show()}if(a.onOpen){a.onOpen(g,d)}}})},takeAwayPx:function(b){var a=null;if(b&&b.length){var c=b.substring(0,b.length-2);a=parseInt(c)}return a},rightStrip:function(c,a){var b=null;if(c.length>=a){b=c.substring(0,c.length-a)}else{b=c}return b},projectPoint:function(g,c,a,h){g=g.toUpperCase();c=c.toUpperCase();var e=new Proj4js.Point(a,h);var b=new Proj4js.Proj(g);var d=new Proj4js.Proj(c);Proj4js.transform(b,d,e);return e},showMouseMoveText:function(c){var e="util-cursordiv";var b,a;this.onMouseMove=this.onMouseMove||function(d){$("."+e).css({left:d.pageX-b+14+"px",top:d.pageY-a+20+"px"}).show()};var h=$("<div class='"+e+"'><p></p></div>");h.find("p").append(c);$("#smapDiv").append(h);h.hide();var g=sMap.util.getMapPosition();b=g.x;a=g.y;$("#smapDiv, .olMapViewport").mousemove(this.onMouseMove)},hideMouseMoveText:function(){var a="util-cursordiv";$("."+a).empty().remove();$("#smapDiv").unbind("mousemove",this.onMouseMove)},getMapPosition:function(){var e=$("#sideDivLeft").length?$("#sideDivLeft").width()+"px":"0px",a=$("#pageDiv").css("top");var d=sMap.util.takeAwayPx(e),g=sMap.util.takeAwayPx(a),b=$("#toolbar").length>0?$("#toolbar").height():0;var c=g+b;return{x:d,y:c}},addDialogMinimizeButton:function(h,k){k=k||{};k.untoggleOnClose=!k.untoggleOnClose?true:k.untoggleOnClose;var c=$('<a class="ui-dialog-titlebar-minimize ui-corner-all" role="button"><span class="ui-icon ui-icon-triangle-1-n">minimize</span></a>');h.prev().find(".ui-dialog-title").after(c);h.isVisible=true;var j=null,i=null;var b=h.dialog("option","resizable");var g=function(){if(h.isVisible){j=h.dialog("option","height");if(($.browser.msie&&parseInt($.browser.version)<8)!==true){i=h.css("padding");h.data("oldPadding",i);h.css("padding","0.01em")}h.hide(0,function(){h.dialog("option","height",0);h.dialog("option","resizable",false);c.find("span").removeClass("ui-icon-triangle-1-n").addClass("ui-icon-triangle-1-s")});h.parent().css("opacity","0.8").find(".ui-dialog-buttonpane").hide()}else{h.show(0,function(){h.dialog("option","height",j);i=h.data("oldPadding");if(i){h.css("padding",i)}if(b){h.dialog("option","resizable",true)}c.find("span").removeClass("ui-icon-triangle-1-s").addClass("ui-icon-triangle-1-n")});h.parent().css("opacity","1").find(".ui-dialog-buttonpane").show()}h.isVisible=!h.isVisible};var a=function(){$(this).addClass("ui-state-hover")};var d=function(){$(this).removeClass("ui-state-hover")};h.prev().dblclick(g);c.click(g).mouseenter(a).mouseleave(d);h.toggleDialog=g;if(k.untoggleOnClose){var e=function(){if(!h.isVisible){g()}};h.bind("dialogclose",e)}h.on("dialogdragstart",function(){$(this).children().hide();$(this).parent().css({filter:"alpha(opacity=70)",opacity:"0.7"})});h.on("dialogdragstop",function(){$(this).parent().css({filter:"alpha(opacity=100)",opacity:"1"});$(this).children().show()})}};sMap.WebParams=OpenLayers.Class({initialize:function(a){this.map=a},getParams:function(){return this.getParamsAsString()},getParamsAsString:function(c){var b=this.getParamsAsObject(),a="",d=null,e=null;for(d in b){e=b[d];a=a+"&"+d.toLowerCase()+"="+e}a=a.substring(1);if(c===true){a=sMap.config.rootURL+"?"+a}return a},getParamsAsObject:function(){var d={};var k=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters());var c=this.map.getCenter();var a=d.CENTER=[c.lon,c.lat];var m=d.ZOOM=this.map.getZoom();var e=sMap.config.layers.overlays;for(var g=0,j=e.length;g<j;g++){var l=e[g];var h=l&&l.name&&this.map.getLayersByName(l.name).length?this.map.getLayersByName(l.name)[0]:null;if(h&&h.getVisibility()===true){if(!d.OL){d.OL=[]}if($.inArray(h.name,d.OL)==-1){d.OL.push(h.name)}}}e=sMap.config.layers.baselayers;for(var g=0,j=e.length;g<j;g++){var l=e[g];var h=this.map.getLayersByName(l.name)[0];if(h&&h.getVisibility()===true){d.BL=h.name;break}}if(k.WIDTH){d.WIDTH=k.WIDTH}if(k.HEIGHT){d.HEIGHT=k.HEIGHT}var b=sMap.Lang.getCode();if(k.LANG||(b!=sMap.Lang.defaultCode)){d.LANG=b}if(k.CONFIG){d.CONFIG=k.CONFIG}sMap.db.webParams=d;sMap.events.triggerEvent("creatingwebparams",this,{});sMap.db.webParams=OpenLayers.Util.upperCaseObject(sMap.db.webParams);return sMap.db.webParams},getStartingParamsAsObject:function(){return OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters())},processParams:function(a){a=a||{};a=$.extend({},a);if(a.MAPTYPE){a.BL=a.MAPTYPE;delete a.MAPTYPE}if(a.OVERLAYS){a.OL=a.OVERLAYS;delete a.OVERLAYS}if(a.ZOOMLEVEL){a.ZOOM=a.ZOOMLEVEL;delete a.ZOOMLEVEL}if(a.ADDMARKER){a.FEATURES=a.ADDMARKER.replace(/=/g,"%3D");delete a.ADDMARKER}return a},applyParams:function(a){a=a||this.getStartingParamsAsObject();a=this.processParams(a);if(typeof a=="string"){a=OpenLayers.Util.upperCaseObject(a)}sMap.db.startingWebParamsObject=a;sMap.events.triggerEvent("beforeapplyingwebparams",this,{});this.applyDefaultParams(a);sMap.events.triggerEvent("afterapplyingwebparams",this,{params:a})},applyDefaultParams:function(e){e=e||this.getParamsAsObject();this.map.zoomToMaxExtent();var l=parseInt(e.ZOOM);if(l&&l>0){this.map.zoomTo(l)}if(e.LANG){sMap.Lang.setCode(e.LANG||"sv-SE")}if(e.CENTER){if(typeof e.CENTER==="string"){e.CENTER=e.CENTER.split(",")}this.map.setCenter(new OpenLayers.LonLat(parseFloat(e.CENTER[0]),parseFloat(e.CENTER[1])),null,false,false)}if(e.BL){this.map.setBaseLayer(e.BL)}if(e.OL){var j=e.OL instanceof Array?e.OL:e.OL.split(","),c=[];for(var d=0,h=j.length;d<h;d++){var g=j[d];var m=sMap.cmd.getLayerConfig(g);if(!m){debug.warn(sMap.lang.errWebParamLayerNotFound)}else{m.startVisible=true;c.push(m)}}sMap.layer.addOverlays(c)}if(this.map.allOverlays===true&&!e.BL&&!e.OL){var a=sMap.config.layers.overlays;if(!a||!a.length){debug.error(sMap.lang.errNoBaseNorOverlays);return}var m=a[0];m.startVisible=true;sMap.layer.addOverlays([m])}if(!e.ZOOM&&!e.CENTER){var k=sMap.config.defaultExtent;if(k){this.map.zoomToExtent(new OpenLayers.Bounds(k.w,k.s,k.e,k.n),false)}else{this.map.zoomToMaxExtent()}}},CLASS_NAME:"sMap.WebParams"});OpenLayers.Control.DeleteFeature=OpenLayers.Class(OpenLayers.Control,{initialize:function(b,a){OpenLayers.Control.prototype.initialize.apply(this,[a]);this.layer=b;this.handler=new OpenLayers.Handler.Feature(this,b,{click:this.clickFeature})},clickFeature:function(a){if(a.fid==undefined){this.layer.destroyFeatures([a])}else{a.state=OpenLayers.State.DELETE;this.layer.events.triggerEvent("afterfeaturemodified",{feature:a});a.renderIntent="select";this.layer.drawFeature(a)}sMap.events.triggerEvent("featuredeleted",this,{})},setMap:function(a){this.handler.setMap(a);OpenLayers.Control.prototype.setMap.apply(this,arguments)},CLASS_NAME:"OpenLayers.Control.DeleteFeature"});OpenLayers.Handler.ModDrag=OpenLayers.Class(OpenLayers.Handler.Drag,{initialize:function(c,b,a){OpenLayers.Util.extend(this,a);OpenLayers.Handler.Drag.prototype.initialize.apply(this,arguments)},dragstart:function(b){var a=true;this.dragging=false;if(OpenLayers.Event.isLeftClick(b)||OpenLayers.Event.isSingleTouch(b)){this.started=true;this.start=b.xy;this.last=b.xy;OpenLayers.Element.addClass(this.map.viewPortDiv,"olDragDown");this.down(b);this.callback("down",[b.xy]);OpenLayers.Event.stop(b);if(!this.oldOnselectstart){this.oldOnselectstart=document.onselectstart?document.onselectstart:OpenLayers.Function.True}document.onselectstart=OpenLayers.Function.False;a=!this.stopDown}else{this.started=false;this.start=null;this.last=null}return a},mousedown:function(a){this.keyMaskPressed=this.checkModifiers(a)==1?true:false;return this.dragstart(a)},CLASS_NAME:"OpenLayers.Handler.ModDrag"});OpenLayers.Handler.ModBox=OpenLayers.Class(OpenLayers.Handler.Box,{initialize:function(c,b,a){OpenLayers.Util.extend(this,a);OpenLayers.Handler.Box.prototype.initialize.apply(this,arguments);this.dragHandler=new OpenLayers.Handler.ModDrag(this,{down:this.startBox,move:this.moveBox,out:this.removeBox,up:this.endBox},{keyMask:this.keyMask})},CLASS_NAME:"OpenLayers.Handler.ModBox"});sMap.Module=OpenLayers.Class({modulesLocation:"modules/Module/",ROOT:null,id:null,map:null,div:null,type:null,allowSelection:false,displayClass:"",title:"",autoActivate:false,activateFromStart:false,active:null,handler:null,eventListeners:null,events:null,EVENT_TYPES:["activate","deactivate"],EVENT_LISTENERS:["modulesadded"],EVENT_TRIGGERS:[],initialize:function(a){this.MODULE_NAME=this.getModuleName();this.ROOT=this.modulesLocation+this.MODULE_NAME+"/";var b=this.getFileConfig();$.extend(true,b,a);$.extend(true,this,b);this.addSmapEventTypes();this.events=new OpenLayers.Events(this,null,this.EVENT_TYPES);if(this.eventListeners instanceof Object){this.events.on(this.eventListeners)}if(this.id==null){this.id=OpenLayers.Util.createUniqueID(this.CLASS_NAME+"_")}this.storeLang()},getFileConfig:function(){return sMap.moduleConfig[this.MODULE_NAME]||{}},addSmapEventTypes:function(){var d=this.EVENT_TRIGGERS,c=this.EVENT_LISTENERS;if(c.length){for(var b=0,a=c.length;b<a;b++){sMap.events.addEventType(c[b]);var e=this[c[b]];if(!e){var g="Module "+this.CLASS_NAME+" has EVENT_LISTENER(S) "+c[b]+" registered\nbut no method with same name.";debug.warn(g)}else{sMap.events.register(c[b],this,e)}}}if(d.length){for(var b=0,a=d.length;b<a;b++){sMap.events.addEventType(d[b])}}},getModuleName:function(){var a=this.CLASS_NAME.replace("sMap.Module.","");return a},storeLang:function(){this.langCode=sMap.Lang.getCode();var d=this.MODULE_NAME.split(".");var c=sMap.Lang.lang;for(var b=0,a=d.length;b<a;b++){c=c[d[b]]}this.lang=c[this.langCode]},destroy:function(){if(this.events){if(this.eventListeners){this.events.un(this.eventListeners)}this.events.destroy();this.events=null}this.eventListeners=null;var g=this.EVENT_LISTENERS;if(g.length){for(var d=0,a=g.length;d<a;d++){var b=g[d];var e=this[b];sMap.events.unregister(b,this,e)}}if(this.handler){this.handler.destroy();this.handler=null}if(this.handlers){for(var c in this.handlers){if(this.handlers.hasOwnProperty(c)&&typeof this.handlers[c].destroy=="function"){this.handlers[c].destroy()}}this.handlers=null}if(this.map){this.map.removeControl(this);this.map=null}},setMap:function(a){this.map=a;if(this.handler){this.handler.setMap(a)}},drawContent:function(){return true},modulesadded:function(a){if(this.drawContent){this.drawContent()}},draw:function(a){this.drawThisDiv();return this.div},drawThisDiv:function(a){if(this.div==null){this.div=OpenLayers.Util.createDiv(this.id);this.div.className=this.displayClass;if(!this.allowSelection){this.div.className+=" olControlNoSelect";this.div.setAttribute("unselectable","on",0);this.div.onselectstart=OpenLayers.Function.False}}if(a!=null){this.position=a.clone()}this.moveTo(this.position);$(this.div).attr("z-index","1000");return this.div},moveTo:function(a){if((a!=null)&&(this.div!=null)){this.div.style.left=a.x+"px";this.div.style.top=a.y+"px"}},activate:function(){if(this.active){return false}if(this.handler){this.handler.activate()}this.active=true;if(this.map){OpenLayers.Element.addClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active")}this.events.triggerEvent("activate");return true},deactivate:function(){if(this.active){if(this.handler){this.handler.deactivate()}this.active=false;if(this.map){OpenLayers.Element.removeClass(this.map.viewPortDiv,this.displayClass.replace(/ /g,"")+"Active")}this.events.triggerEvent("deactivate");return true}return false},CLASS_NAME:"sMap.Module"});OpenLayers.Control.TYPE_BUTTON=1;OpenLayers.Control.TYPE_TOGGLE=2;OpenLayers.Control.TYPE_TOOL=3;var params=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters());if(params.CONFIG&&params.CONFIG.search("aldreboende")!==-1){document.domain="malmo.se"}var showWithIds=function(b){b=b||null;var a=sMap.map.getControlsByClass("sMap.Module.Aldreboenden")[0];if($.browser.msie){sMap.aldreboendeTempIds=b;setTimeout('var mod=sMap.map.getControlsByClass("sMap.Module.Aldreboenden")[0];mod.showWithIds.call(mod, sMap.aldreboendeTempIds);delete sMap["aldreboendeTempIds"];',200)}else{a.showWithIds.call(a,b)}};if(parent&&params.CONFIG&&params.CONFIG.search("aldreboende")!==-1){parent.showWithIds=showWithIds}sMap.Module.Aldreboenden=OpenLayers.Class(sMap.Module,{urlService:location.protocol+"//webapps05.malmo.se/aldreboenden/api/1.0/nursing_homes",attributes:["id","name","url","permalink","photos","geo_position_x","geo_position_y"],inList:[],styles:{"default":{graphicWidth:19,graphicHeight:41,externalGraphic:"img/legend/icon_pil_rod.png",graphicXOffset:-9,graphicYOffset:-31,fillOpacity:1,strokeOpacity:1,cursor:"pointer"},select:{graphicWidth:19,graphicHeight:41,externalGraphic:"img/legend/icon_pil_rod.png",graphicXOffset:-9,graphicYOffset:-31,fillOpacity:1,strokeOpacity:1,cursor:"pointer"}},EVENT_LISTENERS:["popupadded"],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Aldreboenden.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Aldreboenden.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=new OpenLayers.Style();this.layer=new OpenLayers.Layer.Vector("aldreboenden",{rendererOptions:{yOrdering:true},styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style($.extend({},a.defaultStyle,this.styles["default"])),select:new OpenLayers.Style($.extend({},a.defaultStyle,this.styles.select))}),selectable:true,popupHTML:"<span class='aldreboenden-popup'><a href='${permalink}' target='_top'><h3>${name}</h3></a><div><div class='aldreboenden-popup-divleft'><a target='_top' href='${img_large}'><img src='${img_thumbnail}'></img></a></div><div style='display: inline;' class='aldreboenden-popup-divright'><div class='aldreboenden-popup-headerlink'><a style='display: inline;' href='${permalink}' target='_top'>Visa boendet</a></div><div style='display: inline;'><input class='aldreboenden-thepopupcheckbox' type='checkbox'></input><label class='aldreboenden-checkboxlabel'>Lägg till i Min lista</label></div></div></div></span>"});sMap.events.triggerEvent("addlayer",this,{layer:this.layer});var b=sMap.cmd.getStartingParamsAsObject();var c=b.IDS||null;this.fetchInitialData(c);this.updateList();$(parent.document).find("a[href='#tab-element-map']").click(function(){var d=sMap.map.getLayersByName("aldreboenden")[0];d.redraw()})},showWithIds:function(e){e=e||null;if(!this.layer){alert("no layer found");return}if(this.layer.features.length){sMap.events.triggerEvent("unselect",this,{});this.layer.removeAllFeatures()}if(e&&e instanceof Array&&e.length==0){this.map.zoomToMaxExtent();return}if(!e){if(this.features&&this.features.length){this.layer.addFeatures(this.features)}}else{e=$.map(e,function(h){return parseInt(h)});var g=null,b=this.features||[],d=[];if(b&&b.length){for(var c=0,a=b.length;c<a;c++){g=b[c];if($.inArray(g.attributes.nursing_id,e)!=-1){d.push(g)}}this.layer.addFeatures(d)}}if(this.layer.features.length){this.map.zoomToExtent(this.layer.getDataExtent())}},popupadded:function(h){var l=this;var a=$(h.popup.contentDiv).parent().find(".olPopupCloseBox");var k=sMap.util.trimCSS(a.css("right")),i=sMap.util.trimCSS(a.css("top")),d=-12,c=-8;if($.browser.msie&&parseFloat($.browser.version)<9){d+=6;c+=6}a.css({right:(k+d)+"px",top:(i+c)+"px"});this.updateList();$(".aldreboenden-checkboxlabel").click(function(){var e=$(".aldreboenden-thepopupcheckbox").prop("checked");$(".aldreboenden-thepopupcheckbox").prop("checked",!e);$(".aldreboenden-thepopupcheckbox").change()}).parent().css({"white-space":"nowrap"});$(".aldreboenden-thepopupcheckbox").change(function(){var e=$(this).prop("checked");l.onCheckChange(e)});var g=this.getSelectedFeature();var j=$.inArray(g.attributes.nursing_id,this.inList)!=-1;$(".aldreboenden-popup").find("input[type='checkbox']").prop("checked",j);var b=h.popup;b.minSize=new OpenLayers.Size(300,120);b.maxSize=new OpenLayers.Size(300,250);b.updateSize()},onCheckChange:function(b){b=b||false;var a=this.getSelectedFeature();if(b){this.changeList(a.attributes.nursing_id,true);this.updateCookie()}else{this.changeList(a.attributes.nursing_id,false);this.updateCookie()}parent.incomingUpdate()},getSelectedFeature:function(){return this.layer.selectedFeatures.length?this.layer.selectedFeatures[0]:null},updateCookie:function(){$.cookie("nursing_homes_compare",this.inList.join("|"),{expires:365,domain:"malmo.se",path:"/"})},updateList:function(){var b=$.cookie("nursing_homes_compare");if(!b){b="";this.inList=[]}else{var a=b.split("|");this.inList=$.map(a,function(c){return parseInt(c)})}},changeList:function(a,c){c=c||false;a=parseInt(a);if(c===true&&$.inArray(a,this.inList)==-1){this.inList.push(a)}else{var b=$.inArray(a,this.inList);this.inList.splice(b,1)}},fetchInitialData:function(a){$.ajax({url:this.urlService,context:this,data:{fields:this.attributes.join(",")},dataType:"jsonp",cache:true,jsonpCallback:"foo",success:function(b){this.fetchFeatures(b.nursing_homes);this.showWithIds(a)}})},fetchFeatures:function(c){var h,g,j,d={},b=[];for(var e=0,a=c.length;e<a;e++){h=c[e];h.nursing_id=h.id;d={};$.extend(d,h);d.img_thumbnail=h.photos.thumbnail.url;d.img_large=h.photos.large.url;d.name=decodeURIComponent(h.name);if($.inArray(h.nursing_id,this.inList)!=-1){d.inlist=true}else{d.inlist=false}g=new OpenLayers.Geometry.Point(h.geo_position_x,h.geo_position_y);j=new OpenLayers.Feature.Vector(g,d);b.push(j)}this.features=b},CLASS_NAME:"sMap.Module.Aldreboenden"});sMap.moduleConfig.Aldreboenden={activateFromStart:false};sMap.Lang.lang.Aldreboenden={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.BaselayerSwitcher=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["setbaselayer"],EVENT_TRIGGERS:["setbaselayer"],cats:null,initialize:function(a){a=a||{};this.dropDownOnSingle=a.dropDownOnSingle;this.buttonWidth=a.buttonWidth;this.dropDownWidth=a.dropDownWidth;this.EVENT_LISTENERS=sMap.Module.BaselayerSwitcher.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.BaselayerSwitcher.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a]);this.delim="___"},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){$(this.div).empty().remove();delete this.div;this.div=$("<div />");$("#mapDiv").append(this.div);if(this.map.allOverlays===true){return false}this.addBaselayerSwitcher()},setbaselayer:function(a){if(a.caller===this){return true}this.switchBaseLayerButton(a.layerName)},replaceOddChars:function(b,a){if(a===true){b=b.replace(/_/g," ");b=b.replace(/ZZ/g,".");b=b.replace(/CoMMa/g,",")}else{b=b.replace(/ /g,"_");b=b.replace(/\./g,"ZZ");b=b.replace(/\,/g,"CoMMa")}return b},addBaselayerSwitcher:function(){var a=$("<div id='baselayerDiv' class='baselayerDiv' />");$(this.div).append(a);$(this.div).css({position:"absolute",top:"5px",right:"8px",height:"auto","z-index":"1007"});var k={};for(var r=0,s=sMap.config.layers.baselayers.length;r<s;r++){var l=sMap.config.layers.baselayers[r];var g=this.replaceOddChars(l.category);if(!k[g]){k[g]=[]}k[g].push(l)}this.cats=k;var u=null;var d=this.toggleDropDown;var v=this.delim;for(var h in k){u=$("<div class='ui-widget-content ui-state-default baselayer-button' />");var w="bLayerSwitcher"+this.delim+h;u.attr("id",w);var p=this.replaceOddChars(h,true);u.text(p);u.prop("z-index","1008");a.prepend(u);var y=k[h];if(y.length>1||(y.length==1&&this.dropDownOnSingle===true)){var c=this.makeDropDown(h,y);$(this.div).append(c);c.prop("z-index","1007");c.hide()}}var m=0;a.find("div").each(function(){m=Math.max(m,$(this).width())});a.find("div").each(function(){$(this).css("min-width",m)});var j=this.getButtonPosition;var e=this.getDropDownDiv;var v=this.delim;var o=this;var q=0;a.find("div").each(function(){var n=$(this);var t=o.getButtonPosition(n,q);var i=$(this).prop("id").split(v)[1];var z=e(i);z.css("right",t+"px");q+=1});var o=this;var e=this.getDropDownDiv;a.find("div").each(function(){$(this).click(function(n){o.pressButton.call(o,this)});var b=$(this).prop("id").split(v)[1];var i=e(b);if(i.length){$(this).mouseenter(function(){w=$(this).prop("id");var n=w.split(v)[1];if($(this).hasClass("baselayer-button-clicked")===true){$(this).addClass("dropDownHover")}else{$(this).addClass("dropDownHover-notClicked")}d(n,true)});$(this).mouseleave(function(){var n=$(this).prop("id").split(v)[1];$(this).removeClass("dropDownHover");$(this).removeClass("dropDownHover-notClicked");d(n,false)})}});$(this.div).dblclick(function(b){OpenLayers.Event.stop(b)});$(this.div).mousedown(function(b){OpenLayers.Event.stop(b)});var x=null;if(!sMap.cmd.getStartingParamsAsObject().BL){x=this.map.baseLayer.name;var u=this.getButton(x);this.pressButton.call(this,u);$(u).removeClass("dropDownHover")}else{x=sMap.cmd.getStartingParamsAsObject().BL;var u=this.getButton(x);this.markButton(u)}this.pressRadioButton(x);$(u).removeClass("dropDownHover");sMap.events.triggerEvent("setbaselayer",this,{layerName:x})},getDropDownDiv:function(a){var c=a.replace(/ /,"_");var b=sMap.map.getControlsByClass("sMap.Module.BaselayerSwitcher")[0];var d=$("#bLayerDropDown"+b.delim+c);return d},toggleDropDown:function(c,g){var b=sMap.map.getControlsByClass("sMap.Module.BaselayerSwitcher")[0];var d=b.delim;var a="bLayerDropDown"+d+c;var e=$("#"+a);if(g===true){e.show()}else{if(g===false){e.hide()}}d=null,b=null},getButton:function(c){var b=null;var g=null;for(var e=0,a=sMap.config.layers.baselayers.length;e<a;e++){var d=sMap.config.layers.baselayers[e];if(c.toLowerCase()==d.name.toLowerCase()){b=d.category;break}}if(b!=null){var h="bLayerSwitcher"+this.delim+this.replaceOddChars(b);g=$("#"+h)}return g},pressButton:function(c){this.markButton(c);var a=$(c).prop("id").split(this.delim)[1];var g=this.replaceOddChars(a);var e=this.cats[g];var d=e[0].name;sMap.events.triggerEvent("setbaselayer",this,{layerName:d});var h=$(this.div).find("[id*=bLayerInput]");h.each(function(){$(this).prop("checked",false)});if(e.length>1||(e.length==1&&this.dropDownOnSingle===true)){this.pressRadioButton(d);$(c).addClass("dropDownHover")}},markButton:function(a){$(a).siblings().each(function(){$(this).removeClass("baselayer-button-clicked");$(this).removeClass("ui-state-active");$(this).removeClass("dropDownHover")});$(a).addClass("baselayer-button-clicked");$(a).addClass("ui-state-active");$(a).removeClass("dropDownHover-notClicked")},pressRadioButton:function(c){var e=sMap.map.getControlsByClass("sMap.Module.BaselayerSwitcher")[0];var h=$(e.div).find("[id*=bLayerInput]");h.each(function(){$(this).prop("checked",false)});var g="bLayerInput"+e.delim+c;var d=$("#"+g);d.prop("checked",true);var a=e.getButton(c);$(a).addClass("dropDownHover");$(a).removeClass("dropDownHover-notClicked")},makeDropDown:function(g,j){var k=null,a=null,d=null,h;var c=$("<div class='bLayerSwitcher-dropDown' />");c.prop("id","bLayerDropDown"+this.delim+g);for(var b=0,e=j.length;b<e;b++){k=j[b];a=$("<div />");a.prop("id","bLayerRow"+this.delim+k.name);d=$("<span />");d.html(k.displayName);d.prop("id","bLayerLabel"+this.delim+k.name);h=$("<input type='radio' />");h.prop("id","bLayerInput"+this.delim+k.name);a.append(h);a.append(d);a.click(function(n){var m=sMap.map.getControlsByClass("sMap.Module.BaselayerSwitcher")[0];var l=$(this).prop("id").split(m.delim)[1];m.pressRadioButton(l);sMap.events.triggerEvent("setbaselayer",this,{layerName:l});var i=m.getButton(l);m.markButton(i)});c.append(a)}c.mouseenter(function(){var m=sMap.map.getControlsByClass("sMap.Module.BaselayerSwitcher")[0];var l=$(this).prop("id").split(m.delim)[1];var i=$("#bLayerSwitcher"+m.delim+l);if(i.hasClass("baselayer-button-clicked")===true){i.addClass("dropDownHover")}else{i.addClass("dropDownHover-notClicked")}$(this).show()});c.mouseleave(function(){var m=sMap.map.getControlsByClass("sMap.Module.BaselayerSwitcher")[0];var l=$(this).prop("id").split(m.delim)[1];var i=$("#bLayerSwitcher"+m.delim+l);i.removeClass("dropDownHover");i.removeClass("dropDownHover-notClicked");$(this).hide()});return c},getButtonPosition:function(a,d){var c=sMap.util.takeAwayPx(a.css("padding-left"))+sMap.util.takeAwayPx(a.css("padding-right"));var e=(d)*a.outerWidth();var g=e;return g},switchBaseLayerButton:function(c){var a=this.getButton(c);this.markButton(a);this.pressRadioButton(c)},CLASS_NAME:"sMap.Module.BaselayerSwitcher"});sMap.moduleConfig.BaselayerSwitcher={activateFromStart:false,buttonWidth:90};sMap.Lang.lang.BaselayerSwitcher={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.Blixten=OpenLayers.Class(sMap.Module,{prefix:"blixten-",searching:null,defaultBuffer:null,minBuffer:null,maxBuffer:null,featureNS:"malmows",EVENT_LISTENERS:["blixtenrequest","selected","unselected"],EVENT_TRIGGERS:["blixtenrequest","blixtenfeaturesfound"],DEACTIVATE_MODULES:["sMap.Module.MeasureDialog"],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Blixten.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Blixten.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}for(var b=0,a=this.DEACTIVATE_MODULES.length;b<a;b++){var c=this.map.getControlsByClass(this.DEACTIVATE_MODULES[b]);if(c.length){c[0].deactivate()}}if(!($.browser.msie&&parseInt($.browser.version)<9)){$("#toolbar-maindiv").off("dblclick").on("dblclick",function(g){if(g.altKey){var d=$("<img src='img/apic.png' width='300' height='300'></img>");d.css({position:"absolute","z-index":"2000",right:"-300px",top:"100px",opacity:"0"});$("#mapDiv").append(d);d.animate({right:"1px",opacity:"1"},500,function(){$(this).animate({right:"-300px",opacity:"0"},500,function(){$(this).empty().remove()})})}})}sMap.events.triggerEvent("deactivate",this,{module:"sMap.Module.Select"});if(!this.map.getLayersByName(this.layer.name).length){this.map.addLayer(this.layer)}if(!this.drawPointControl){this.drawPointControl=new OpenLayers.Control.DrawFeature(this.layer,OpenLayers.Handler.Point)}this.map.addControl(this.drawPointControl);this.drawPointControl.activate();this.showDialog();return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}$("#toolbar-maindiv").off("dblclick");this.drawPointControl.deactivate();this.map.removeControl(this.drawPointControl);this.layer.destroyFeatures();if(this.dialogDiv.dialog("isOpen")){return this.hideDialog()}sMap.events.triggerEvent("activate",this,{module:"sMap.Module.Select"});return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=this;var b="addtoolbutton";if(this.addToToolsMenu){b="addtomenu"}sMap.events.triggerEvent(b,this,{index:this.toolbarIndex,label:this.lang.toolButtonText,iconCSS:"ui-icon-info",tagID:"button-blixten",bindActivation:true,on:this.activate,off:this.deactivate,left:this.left,right:this.right,margin:this.margin,menuId:this.addToToolsMenu});this.layer=new OpenLayers.Layer.Vector("blixtenlayer",{zIndex:this.zIndex,styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style(this.styles["default"]),select:new OpenLayers.Style(this.styles.select),temporary:new OpenLayers.Style(this.styles.temporary)}),rendererOptions:{yOrdering:true,zIndexing:true}});this.map.addLayer(this.layer);this.layer.setZIndex(this.zIndex);this.layer.events.register("sketchcomplete",this,function(c){this.loading(true);setTimeout(function(){a.drawPointControl.deactivate();a.layer.destroyFeatures();a.doRequest(c.feature.geometry)},100);return false});this.radiusUnits=this.defaultBuffer;this.changeFeatureRadius();this.map.events.register("zoomend",this,this.changeFeatureRadius)},loading:function(a){a=a||false;if(a===true){OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait");sMap.cmd.loading(true,{text:this.lang.textLoading,bg:true})}else{OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait");sMap.cmd.loading(false,{fast:true})}},doRequest:function(j){if(this.searching===true){return}if(!this.anim&&this.useAnimation){this.anim=$("<img src='modules/Module/Blixten/img/Lightning_bolt.gif' id='blixten-anim' />");$(this.map.viewPortDiv).append(this.anim);var k=this.map.getViewPortPxFromLonLat(new OpenLayers.LonLat(j.x,j.y));this.anim.css({left:parseInt(k.x)-10+"px",top:parseInt(k.y)-83+"px"})}if(this.anim){this.anim.show()}var l=this.dialogDiv.find("input[type='checkbox']").prop("checked");var d=[];if(l!==true){var g=null,n=null;var a=sMap.config.layers.overlays;for(var e=0,h=a.length;e<h;e++){n=a[e]||{};if(n.blixtable&&n.layerType.toUpperCase()=="WMS"){g=n.name&&this.map.getLayersByName(n.name).length?this.map.getLayersByName(n.name)[0]:null;if(!g){sMap.events.triggerEvent("addlayerwithconfig",this,{config:n});g=this.map.getLayersByName(n.name)[0];g.setVisibility(false)}d.push(g)}}}else{var m=this.getBlixtableLayers();m=m.WMS||[];for(var e=0,h=m.length;e<h;e++){if(m[e].blixtable){d.push(m[e])}}}sMap.events.triggerEvent("blixtenrequest",this,{geometry:j,layers:d});var c=OpenLayers.Geometry.Polygon.createRegularPolygon(j,this.radiusUnits,20,0);var b=new OpenLayers.Feature.Vector(c);this.layer.addFeatures([b])},getBlixtableLayers:function(){var e=sMap.map.layers,g={};for(var d=0,b=e.length;d<b;d++){var c=e[d];if(c.getVisibility()&&c.calculateInRange()&&c.blixtable){var a=c.CLASS_NAME.split(".")[2];if(!g[a]){g[a]=[]}g[a].push(c)}}return g},getPixelRadiusFromUnits:function(c){if(!this.map.getResolution){return null}var a=this.map.getResolution();if(!a){return null}var b=c/a;b=b<1?1:parseInt(Math.round(b));return b},changeFeatureRadius:function(){var a=this.getPixelRadiusFromUnits(this.radiusUnits);if(!a){return false}var b=this.layer.styleMap.styles;b["default"].defaultStyle.pointRadius=a;b.temporary.defaultStyle.pointRadius=a},showDialog:function(){if(!this.dialogDiv){this.makeDialog()}this.dialogDiv.dialog("open");return true},hideDialog:function(){this.dialogDiv.dialog("close");return true},makeDialog:function(){this.dialogDiv=$("<div id='"+this.prefix+"dialogdiv' />");var i=this;this.dialogDiv.dialog({title:this.lang.dialogTitle,position:this.dialogPosition,width:325,height:364,resizable:true,close:function(){i.layer.setZIndex(i.zIndex);i.deactivate()}});sMap.util.addDialogMinimizeButton(this.dialogDiv);var h=$("<label class='"+this.prefix+"dialoglabel' id='"+this.prefix+"labelintro1'>"+this.lang.introText1+"</label>"),g=$("<label class='"+this.prefix+"dialoglabel' id='"+this.prefix+"labelintro2'>"+this.lang.introText2+"</label>"),e=$("<label class='"+this.prefix+"dialoglabel' id='"+this.prefix+"labelintro3'>"+this.lang.introText3+"</label>");this.dialogDiv.append(h).append(g).append(e);var c=$("<fieldset id='"+this.prefix+"sliderdiv' />"),b=$("<legend>"+this.lang.labelRadius+"</legend>"),d=$("<input size='3' id='"+this.prefix+"radiusentry' disabled />"),j=$("<label>"+this.lang.bufferUnit+"</label>"),a=$("<div id='"+this.prefix+"sliderradius' />");this.dialogDiv.append(c);c.append(b).append(d).append(j).append(a);d.val(this.defaultBuffer);var i=this;a.slider({min:this.minBuffer,max:this.maxBuffer,range:false,step:this.step||null,value:d.val(),slide:function(l,k){i.radiusUnits=k.value==0?1:k.value;d.val(i.radiusUnits);i.changeFeatureRadius()}});this.dialogDiv.parent().mouseenter(function(m){var k=i.map.getControlsByClass("OpenLayers.Control.DrawFeature");if(k.length){k[0].deactivate();var l=i.map.getLayersByName("selectLayer");if(l.length){l[0].setZIndex(i.zIndex)}}});this.dialogDiv.parent().mouseleave(function(l){var k=i.map.getControlsByClass("OpenLayers.Control.DrawFeature");if(k.length){k[0].activate()}})},makeWmsParams:function(g){var c=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.DWITHIN,distanceUnits:"m",distance:parseInt(this.radiusUnits),value:g});var a="1.0.0";var d=new OpenLayers.Format.XML(),b=new OpenLayers.Format.Filter({version:a});filterXml=d.write(b.write(c));var e={filter:filterXml,service:"WFS",version:a,request:"getfeature",srsName:this.map.projection,format:"text/geojson",maxFeatures:10000,outputFormat:"json"};return e},counter:0,checkCounter:function(){if(this.counter<=0){this.afterFetch(this.responseData)}},blixtenrequest:function(w){var g=w.geometry,l=w.layers,q=this;this.searching=true;if(!l||!l.length){this.afterFetch();return}this.counter=1;this.responseData=[];var x,d,o;var y=this.makeWmsParams(g);var c=[],b={};var k=function(i,j){d="http://geoserver.smap.se/geoserver/wfs";var e=i.join();$.extend(y,{typename:e});$.ajax({url:sMap.config.proxyHost+encodeURIComponent(d),type:"POST",dataType:"text",data:y,context:q,error:function(z,A,t){debug.log("Erroneous response from WMS-request: "+A)},success:function(F){var G=new OpenLayers.Format.GeoJSON();var A=G.read(F);for(var B=0,z=A.length;B<z;B++){var E=A[B];var D=this.featureNS+":"+E.fid.split(".")[0];var C=j[D];E.layerName=C.name}this.responseData=this.responseData.concat(A)},complete:function(){this.counter-=1;this.checkCounter()}})};if(window.Worker){var h=new Worker("modules/Module/Blixten/Blixten_worker.js");h.addEventListener("message",function(j){var i=j.data;c=i.layersArr;b=i.layersDict;k(c,b);h.terminate()},false);var p=$.map(l,function(j,e){return j.name});h.postMessage({configLayers:$.extend(true,{},sMap.config.layers),layerNames:p})}else{for(var s=0,u=l.length;s<u;s++){x=l[s];o=sMap.cmd.getLayerConfig(x.name);var v=o.params.layers;var n=v.split(","),m=null;for(var r=0,a=n.length;r<a;r++){m=n[r];b[m]=o}if($.inArray(v,c)===-1){c.push(v)}}k(c,b)}},selected:function(a){this.layer.setZIndex(this.zIndex)},unselected:function(a){this.layer.setZIndex(this.zIndex)},fetchedResult:function(){},afterFetch:function(a){this.loading(false);this.searching=false;if(this.anim){this.anim.hide()}if(!a||!a.length){alert("Hittade inga objekt!");this.drawPointControl.activate()}else{sMap.events.triggerEvent("blixtenfeaturesfound",this,{features:a});this.layer.setZIndex(this.zIndex)}},CLASS_NAME:"sMap.Module.Blixten"});sMap.moduleConfig.Blixten={activateFromStart:false,defaultBuffer:200,minBuffer:100,maxBuffer:500,step:100,dialogPosition:[50,100],zIndex:697,styles:{"default":{strokeDashstyle:"solid",pointRadius:10,fillColor:"#00f",strokeColor:"#fff",strokeWidth:1,strokeOpacity:1,fillOpacity:0.4,graphicZIndex:697},select:{strokeDashstyle:"solid",pointRadius:10,fillColor:"#00f",strokeColor:"#fff",strokeWidth:1,strokeOpacity:1,fillOpacity:0.4,graphicZIndex:697},temporary:{strokeDashstyle:"solid",pointRadius:10,fillColor:"#00f",strokeColor:"#fff",strokeWidth:1,strokeOpacity:1,fillOpacity:0.4,graphicZIndex:697}}};sMap.Lang.lang.Blixten={"sv-SE":{toolButtonText:"Sök i kartan",dialogTitle:"Sök i kartan",introText1:"<p>Sök i kartan” hämtar information inom en angiven cirkel. Sökningen träffar alla översiktsplanelager och riksintressen.</p><p>Därutöver hämtas följande underlag: naturvårdsplan, naturreservat uppmärksamhetsavstånd kring farliga verksamheter, skyddsområde för grundvattentäkt, gasledning, kraftledningar.</p><p>Ställ in önskad radie och klicka därefter i kartan.</p>",introText2:"",introText3:"",labelRadius:"Sökradie",bufferUnit:"m",legendShowAll:"2. Sök",labelBoxSearch:"Klicka i kartan!",legendClick:"2. Sökmetod",labelClick:"Välj sökmetod nedan. Klicka sedan i kartan för att söka. Resultatet visas i ett nytt fönster.",textLoading:"Var vänlig vänta. Sökning pågår."},en:{textLoading:"Searching for objects..."}};sMap.Module.BlixtenPopup2=OpenLayers.Class(sMap.Module,{prefix:"blixtenpopup-",delim:"__",nameField:"namn",urlField:"url",tooltipField:"tooltip",foundFeatures:[],EVENT_LISTENERS:["blixtenrequest","blixtenfeaturesfound","fetchedfeatures"],fetchedfeatures:function(b){var a=this.map.getControlsByClass("sMap.Module.Blixten")[0];if(a.active===true){if(!b.features.length){return false}sMap.events.triggerEvent("blixtenfeaturesfound",this,{features:b.features});setTimeout('$(".blixtenpopup-row-left:eq(0)").click();',20)}},EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.BlixtenPopup2.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.BlixtenPopup2.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){this.preProcessLayerConfig()},preProcessLayerConfig:function(){var d,c,b,e,a=sMap.config.layers.overlays;for(d=0,len=a.length;d<len;d++){c=a[d];if(c.blixtable){b=c.geomType||"polygon";switch(b){case"point":e={strokeWidth:12,strokeColor:"#000",strokeOpacity:0.2};break;case"line":e={strokeWidth:12,strokeColor:"#000",strokeOpacity:0.2};break;case"polygon":e={strokeWidth:12,strokeColor:"#000",fillOpacity:0,strokeOpacity:0.2};break;default:e={strokeWidth:12,strokeColor:"#000",fillOpacity:0,strokeOpacity:0.2}}if(c.style.select){delete c.style.select.rules}delete c.style.rules;c.style=c.style||{};$.extend(true,c.style["default"],e);$.extend(true,c.style["default"],e);$.extend(true,c.style.select,e);$.extend(true,c.style.select,e)}}},showDialog:function(){if(!this.dialogDiv){this.makeDialog()}this.removeRows();this.dialogDiv.dialog("open")},hideDialog:function(){if(this.dialogDiv){this.dialogDiv.dialog("close")}},destroyFeatures:function(c){for(var b=0,a=c.length;b<a;b++){c[b].destroy()}},updateSize:function(){var h=this.dialogDiv.dialog("option","width");height=this.dialogDiv.dialog("option","height");var e=h-(this.oldWidth||h);var b=this.rightDiv.width()+e;this.rightDiv.width(b);var i=height-this.oldHeight;var g=this.leftDiv.height()+i,d=this.rightDiv.height()+i,c=this.rowsDiv.height()+i,a=this.attrDiv.height()+i;this.leftDiv.height(g);this.rightDiv.height(d);this.rowsDiv.height(c);this.attrDiv.height(a);this.oldWidth=h;this.oldHeight=height},makeDialog:function(){var e=$(window).width()*0.5;var c=parseInt(e/1.5);var g=800,i=800,k=400,a=600;g=$(window).height()-50<g?$(window).height()-50:g;e=e>i?i:e;c=c>g?g:c;e=e<a?a:e;c=c<k?k:c;var b=$(window).width()-e-30,d=($(window).height()-c)/2;this.dialogDiv=$("<div id='"+this.prefix+"dialogdiv' />");var l=this;this.dialogDiv.dialog({title:this.lang.dialogTitle,resizable:true,autoOpen:false,position:[b,d],width:e,height:c,resizeStart:function(){$(this).children().hide();$(this).parent().css({filter:"alpha(opacity=70)",opacity:"0.7"})},resizeStop:function(m,h){$(this).parent().css({filter:"alpha(opacity=100)",opacity:"1"});$(this).children().show()},close:function(){sMap.events.triggerEvent("unselect",this,{});l.destroyFeatures(l.foundFeatures);l.foundFeatures=[];l.attrDiv.parent().find("iframe").remove();sMap.cmd.hidealllayers()}});sMap.util.addDialogMinimizeButton(this.dialogDiv);this.oldWidth=e;this.oldHeight=c;this.dialogDiv.parent().mouseenter(function(n){var h=l.map.getControlsByClass("OpenLayers.Control.DrawFeature");if(h.length){h[0].deactivate();var m=l.map.getLayersByName("selectLayer");if(m.length){m[0].setZIndex(699)}}});this.dialogDiv.parent().mouseleave(function(m){var h=l.map.getControlsByClass("OpenLayers.Control.DrawFeature");if(h.length){h[0].activate()}});this.leftDiv=$("<div id='"+this.prefix+"leftdiv' unselectable='on' class='blixtenpopup-div unselectable' />");this.rightDiv=$("<div id='"+this.prefix+"rightdiv' class='blixtenpopup-div' />");this.rowsDiv=$("<div id='"+this.prefix+"rowsdiv-bottom' />");this.leftDiv.append(this.rowsDiv);function j(h){if(h.target==this){l.unselectAllRows();sMap.events.triggerEvent("unselect",this,{doNotDestroy:true});l.attrDiv.empty();l.attrDiv.parent().find("iframe").remove()}}this.rowsDiv.click(j);this.dialogDiv.append(this.leftDiv).append(this.rightDiv);this.attrDiv=$("<div id='"+this.prefix+"attrdiv' />");this.rightDiv.append(this.attrDiv)},showAttributes:function(a,b){this.attrDiv.empty();this.attrDiv.parent().find("iframe").remove();this.attrDiv.html(b);this.attrDiv.show()},getFeaturesWithFids:function(k){var h=null,g=this.foundFeatures,c=[];for(var e=0,a=g.length;e<a;e++){h=g[e];for(var d=0,b=k.length;d<b;d++){if(h.fid==k[d]){c.push(h)}}}return c},onRowClick:function(){var a=sMap.map.getControlsByClass("sMap.Module.BlixtenPopup2")[0];sMap.events.triggerEvent("unselect",a,{doNotDestroy:true});a.unselectAllRows();$(this).addClass(a.prefix+"rowselected");var g=$(this).data("fids"),d=null,c=null;if(g){c=a.getFeaturesWithFids(g);var e=c[0];d=e.attributes[a.urlField];var b=e.layerName;if(b){sMap.cmd.hidealllayers();sMap.events.triggerEvent("showlayer",this,{layerName:b})}}else{d=options.content||"Inget innehåll"}a.showInfo(d);sMap.events.triggerEvent("select",a,{features:c,doNotDestroy:true});return true},makeRow:function(b,a){var d=$("<div unselectable='on' class='unselectable "+a.className+"' />");var c=b.fids;d.data("fids",c);d.text(a.label);d.css(a.css);d.click(this.onRowClick);return d},showInfo:function(b){if(b.substring(0,4)=="http"){this.attrDiv.hide();this.attrDiv.empty();this.attrDiv.parent().find("iframe").remove();var a=$("<iframe scrolling='1' border='none' frameborder='0' width='100%' height='100%' />");a.attr("src",b);this.attrDiv.parent().append(a)}else{this.showAttributes({},b)}},addRow:function(j){var d=this.prefix;var i="Övrigt";var h=1;var c=j.blixtenPopupHeader||(j.category&&j.category.length>h?j.category[h]:i);var e={};if(c){e=j.category&&c?this.categories.headers[c]||{}:{}}var m=this.makeRow(j,{className:d+"row-left",label:j.displayName,css:j.css||{"background-color":e.color},content:j.content||null});var k=this;function g(n){return d+"rowheader-"+k._encodeHeader(n)}var b=this.rowsDiv.find("#"+g(c));if(!b.length){b=$("<div class='"+d+"row-left "+d+"rowheader' id='"+g(c)+"'>"+c+"</div>");var a=this.rowsDiv.find("#"+g(i));if(a.length){a.before(b)}else{this.rowsDiv.append(b)}}var l=b.nextUntil(".blixtenpopup-rowheader").last();if(!l.length){b.after(m)}else{l.after(m)}m.height(m.height())},_decodeHeader:function(a){return decodeURIComponent(a.replace(/--pr--/gi,"%"))},_encodeHeader:function(a){return encodeURIComponent(a).replace(/%/gi,"--pr--")},startingInfo:"<p>Tryck på en rad till vänster för att få mer information om varje enskilt objekt.</p>",addItems:function(c){var b=null;this.removeRows();this.showInfo(this.startingInfo);for(var a in c){b=c[a];if(b.hasNameField){this.addRow(b)}}this.addHoverEffect()},unselectAllRows:function(){var a=this.prefix+"rowselected";$("."+a).each(function(){$(this).removeClass(a)})},removeRows:function(){this.rowsDiv.empty()},addHoverEffect:function(){var a=this;$("."+this.prefix+"row-left:not(."+this.prefix+"rowheader)").mouseenter(function(){$(this).addClass(a.rowHoverClass)});$("."+this.prefix+"row-left:not(."+this.prefix+"rowheader)").mouseleave(function(){$(this).removeClass(a.rowHoverClass)})},blixtenrequest:function(b){if(this.treeDiv){var a=this.treeDiv.dynatree("getRoot");a.removeChildren()}if(this.attrDiv){this.attrDiv.empty();this.attrDiv.parent().find("iframe").remove()}this.hideDialog()},blixtenfeaturesfound:function(j){var a=j.features,b=[],h=null,d=null,k={},l=null;this.foundFeatures=a;this.showDialog();for(var c=0,g=a.length;c<g;c++){h=a[c];h.attributes[this.nameField]=h.attributes[this.nameField]||"Ett lager";h.attributes[this.urlField]=h.attributes[this.urlField];h.attributes[this.tooltipField]=h.attributes[this.tooltipField]||"Some tooltip";d=h.layerName;if(d){l=k[d]||sMap.cmd.getLayerConfig(d);l.fids=l.fids||[];l=$.extend({},l);l.fids.push(h.fid);if(l.dialogContent){h.attributes[this.urlField]=l.dialogContent}if(h.attributes[this.urlField]&&h.attributes[this.urlField]!=""){l.hasNameField=true}k[d]=k[d]||l}}this.addItems(k)},CLASS_NAME:"sMap.Module.BlixtenPopup2"});sMap.moduleConfig.BlixtenPopup2={activateFromStart:false,rowHoverClass:"blixtenpopup-hover",dialogPosition:["right","bottom"]};sMap.Lang.lang.BlixtenPopup2={"sv-SE":{dialogTitle:"Sökresultat",tooltipFile:"Klicka på texten för mer information.",headerTop:"Generella riktlinjer",headerBottom:"Områdesspecifika riktlinjer"},en:{dialogTitle:"Search results",tooltipFile:"Click on the text for more info.",headerTop:"Generic specifications",headerBottom:"Specific specifications"}};sMap.Module.ConfigSelector=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["afterapplyingwebparams"],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.ConfigSelector.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.ConfigSelector.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){this.addDropDown()},addDropDown:function(){var b=this,a=this.dropDownItems,d="<option value='def'>"+this.lang.defaultSelecttext+"</option>";for(var e in a){d=d+"<option value='"+e+"'>"+a[e].name+"</option>"}var c=$("<select name='themes' id='configSelectorDdl'>"+d+"</select>");sMap.events.triggerEvent("addselect",b,{selectObject:c,index:b.toolbarIndex});$("#configSelectorDdl").change(function(){var g=$(this).find("option:selected").val();if(g!="def"){b.changeConfig(g)}else{b.afterapplyingwebparams()}})},changeConfig:function(h){var e=sMap.cmd.getParamsAsObject(),c=e.OL?e.OL:[];if(this.dropDownItems[h].file){e.CONFIG=this.dropDownItems[h].file}if(!this.keepZoom){e.CENTER=null;e.ZOOM=null}if(this.dropDownItems[h].bl){e.BL=this.dropDownItems[h].bl}else{if(!this.keepBackground){e.BL=null}}if(this.dropDownItems[h].ol||this.dropDownItems[h].ol==""){e.OL=this.dropDownItems[h].ol}else{if(!this.keepOverlays){e.OL=null}}if(!this.keepFeatures){e.FEATURES=null}if(!this.keepOpacities){e.OP=null}else{var d=e.OL?e.OL.split(","):[],l=e.OP?e.OP:[],o=l.length>0?l[0]:null;for(var k=0;k<d.length;k++){var n=false;for(var g=0;g<c.length;g++){if(d[k]==c[g]){o+=","+l[g+1];n=true}}if(!n){o+=",100"}}e.OP=o}var a="",m=null,b=null;for(m in e){b=e[m];if(b){a=a+"&"+m.toLowerCase()+"="+b}}a=a.substring(1);a=sMap.config.rootURL+"?"+a;document.location=a},setDropDown:function(d){var g=$("#configSelectorDdl"),c=sMap.db.startingWebParamsObject.OL?sMap.db.startingWebParamsObject.OL:"",b=this.dropDownItems;for(var e in b){var a=b[e].ol?b[e].ol:"";if(b[e].file==d&&(a==c||(b[e].ol==null))){g.val(e)}}},afterapplyingwebparams:function(){var a=sMap.db.startingWebParamsObject.CONFIG;if(a){this.setDropDown(a)}},CLASS_NAME:"sMap.Module.ConfigSelector"});sMap.moduleConfig.ConfigSelector={activateFromStart:false,dropDownItems:{},toolbarIndex:15,keepZoom:true,keepBackground:true,keepOverlays:true,keepOpacities:false,keepFeatures:true};sMap.Lang.lang.ConfigSelector={"sv-SE":{defaultSelecttext:"Snabbval....."},en:{defaultSelecttext:"Select map"}};sMap.Module.CopyLink=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["updatelinkentries","showlink"],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.CopyLink.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.CopyLink.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true&&this.linkDiv&&this.linkDiv.length){this.updatelinkentries();return}$(this.div).empty().remove();this.div=null;if($(this.div).children().length==0){var a=this;this.linkDiv=this.makeCopyLinkDiv("copylink-maindiv");$("#mapDiv").append(this.linkDiv);this.map.events.register("moveend",this,function(){a.updatelinkentries()});this.map.events.register("zoomend",this,function(){a.updatelinkentries()})}$(this.linkDiv).show();a.updatelinkentries();return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){$(this.linkDiv).hide();return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){$(this.linkDiv).empty().remove();return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a="addtoolbutton";if(this.addToToolsMenu){a="addtomenu"}sMap.events.triggerEvent(a,this,{index:this.toolbarIndex,label:this.labelButton?this.lang.labelText:null,hoverText:this.lang.labelText,iconCSS:"btncopylink",tagID:"button-copylink",left:this.left,right:this.right,menuId:this.addToToolsMenu})},showlink:function(a){return this.activate(a)},copyLinkRow:function(c,b){var a=this,d=this.linkDiv;linkEntryContainer=$("<div class='copylink-subdiv'></div>"),linkLabel=$("<div class='copylink-labels'>"+b+"</div>"),c=$("<input type='text' id='"+c+"' class='copylink-entries' />");c.click(function(g){$(this).select()});c.select(function(h){var g=h.target.value;if(g.length>2083){alert(a.lang.tooLongURL)}});linkEntryContainer.append(linkLabel).append(c);d.append(linkEntryContainer);return d},chooseShortener:function(a){if(a=="toDb"){this.shortenLinks()}else{if(a=="bitLy"){this.sMaply()}else{alert("error!")}}},createSpinner:function(a){var c=document.getElementById(a);if(!this.spinAnimation){var b={lines:8,length:4,width:2,radius:4,color:"#000",speed:1,trail:60,left:1,shadow:false};var d=new Spinner(b)}else{var d=this.spinAnimation;$("#"+a).empty().show()}d.spin(c);this.spinAnimation=d;return d},sMaply:function(){var a=this,c=$("#copylink-shortenmsg"),d=sMap.cmd.getParamsAsString(true);if(window.location.host=="localhost"||window.location.host=="localhost:8888"){d="http://www.google.se";alert("Shortening via bit.ly can not be done on localhost! Instead "+d+" will be used for test!")}var b=sMap.config.proxyHost?sMap.config.proxyHost+a.bitLyPath:a.bitLyPath;var e=a.createSpinner("copylink-shortenmsg");$.ajax({url:b,data:{longUrl:encodeURIComponent(d)},type:"POST",error:function(h,g){if(e){e.stop()}c.text(a.lang.failureMsg)},success:function(h){var g=h;sMap.events.triggerEvent("updatelinkentries",a,{url:g});if(e){e.stop()}c.text(a.lang.successMsg).show().delay(3000).fadeOut("fast",function(){c.empty()})}})},shortenLinks:function(){var a=this,c=$("#copylink-shortenmsg"),e=sMap.cmd.getParamsAsObject(true),g=e.FEATURES;if(!g){c.text(a.lang.noFeaturesMsg).show().delay(3000).fadeOut();return}var d=a.createSpinner("copylink-shortenmsg");var b=sMap.config.proxyHost?sMap.config.proxyHost+a.saveToDbPath:a.saveToDbPath;$.ajax({url:b,data:{longString:g},type:"POST",error:function(i,h){if(d){d.stop()}c.text(a.lang.failureMsg)},success:function(i){e.FEATURES="short";e.id=i;var h="";$.each(e,function(j,k){h=h+"&"+j.toLowerCase()+"="+k});h=h.substring(1);h=sMap.config.rootURL+"?"+h;sMap.events.triggerEvent("updatelinkentries",a,{url:h});if(d){d.stop()}c.text(a.lang.successMsg).show().delay(3000).fadeOut("fast",function(){c.empty()})}})},makeCopyLinkDiv:function(a){var b=this,i=$("<div id='"+a+"' />"),e=this.cats;i.addClass("ui-widget-content");b.linkDiv=i;var h=$("<input id='copylink-btn' type='button' value='"+b.lang.closeBtn+"' />");h.button();$.each(e,function(j,l){if(l==true){var k=b.lang[j];b.copyLinkRow(j,k)}});i.append(h);if(b.shortenOption=="toDb"||b.shortenOption=="bitLy"){var g=$("<div id='copylink-shortendiv'></div>"),d=$("<input id='copylink-shortenbtn' type='button' value='"+b.lang.shortenURLBtn+"' />");d.button();var c=$("<div id='copylink-shortenmsg'></div>");d.click(function(j){b.chooseShortener(b.shortenOption)});g.append(d).append(c);i.append(g)}sMap.util.disableMapInteraction(i);$(i).hover(function(){b.map.viewPortDiv.oncontextmenu=OpenLayers.Function.True},function(){b.map.viewPortDiv.oncontextmenu=OpenLayers.Function.False});h.click(function(j){b.deactivate()});return i},updatelinkentries:function(c){if($(".copylink-entries").length>0&&$(".copylink-entries").is(":visible")){var a=null;if(c!==undefined){a=c.url}else{a=sMap.cmd.getParamsAsString(true)}if(a&&a.length>2048){a=this.lang.tooLongURL}var b=$(".copylink-entries");b.each(function(){if(this.tagName.toLowerCase()=="input"){if($(this).prop("id")=="copyLink"){$(this).val(a)}else{$(this).val('<iFrame width="500" height="500" frameborder="0" scrolling="no" src="'+a+'"></iFrame>')}}else{$(this).text(a)}})}},CLASS_NAME:"sMap.Module.CopyLink"});sMap.moduleConfig.CopyLink={labelButton:true,cats:{copyLink:true,embedLink:true},shortenOption:"toDb",saveToDbPath:"http://www.smap.se/cgi-bin/shorten/sMap_save.py",bitLyPath:"http://www.smap.se/cgi-bin/shorten/sMaply.py",activateFromStart:false};sMap.Lang.lang.CopyLink={"sv-SE":{labelText:"Kopiera länk",copyLink:"Länk till karta (högerklicka och kopiera):",embedLink:"Bädda in på egen sida (högerklicka och kopiera):",closeBtn:"Stäng",tooLongURL:"Din länk är för lång för vissa webbläsare - ta bort ett eller flera ritade objekt.",shortenURLBtn:"Förkorta länkar",noFeaturesMsg:"Inget ritat, därför ingen förkortning!",failureMsg:"Internt fel, kontakta ansvarig",successMsg:"Klar"},en:{labelText:"Copy link",copyLink:"Link to current map (rightclick and copy)",embedLink:"Embed in own page (rightclick and copy)",closeBtn:"Close",tooLongURL:"Your URL is too long for some browsers - please remove some features.",shortenURLBtn:"Shorten links",noFeaturesMsg:"Nothing drawn, therefore no shortening!",failureMsg:"Internal error, contact administrator",successMsg:"Complete"}};sMap.Module.Draw=OpenLayers.Class(sMap.Module,{selectedFeature:null,EVENT_LISTENERS:["selected","unselected","creatingwebparams","afterapplyingwebparams","layervisible"],EVENT_TRIGGERS:["addtoolbutton","showlink","addlayer","select","unselect"],toolbarIndex:null,initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Draw.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Draw.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}if(!this.dialogDiv){this.dialogDiv=this.makeDialogContent();this.dialogDiv=this.makeDialog(this.dialogDiv)}this.dialogDiv.dialog("open");return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}if(this.dialogDiv&&this.dialogDiv.dialog("isOpen")===true){return this.dialogDiv.dialog("close")}if(this.panel){this.deactivateButtonsAndControls()}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=this.addToToolsMenu?"addtomenu":"addtoolbutton";sMap.events.triggerEvent(a,this,{index:this.toolbarIndex,iconCSS:"btndraw",label:this.lang.buttonText,tagID:"button-draw",menuId:this.addToToolsMenu})},layervisible:function(a){if(this.editLayer){this.editLayer.setZIndex(this.zIndex)}},addColorPicker:function(l){var h=$("<button id='draw-buttoncolorselect'>"+this.lang.btnColor+"</button>"),b=$("<div id='draw-divcolorselect' />"),a=this.colors;for(var g=0,j=a.length;g<j;g++){var e=a[g],k=$("<span />");k.css({"background-color":e});b.append(k);k.click(function(){var c=m.colorToHex($(this).css("background-color"));h.css({background:c,color:"#000"});m.editLayer.styleMap.styles.temporary.defaultStyle.fillColor=c;m.editLayer.styleMap.styles.temporary.defaultStyle.strokeColor=c})}b.height(Math.ceil(a.length/4)*22);var m=this;h.click(function(){$("#draw-divcolorselect").show()});var d=this.editLayer.styleMap.styles.temporary.defaultStyle.fillColor;h.css({"background-color":d});b.hover(function(){$(this).show()},function(){$(this).hide()});h.mouseleave(function(){$("#draw-divcolorselect").hide()});l.append(h).append(b);b.hide();return b},colorToHex:function(a){if(a.substr(0,1)==="#"){return a}a=a.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);return"#"+("0"+parseInt(a[1],10).toString(16)).slice(-2)+("0"+parseInt(a[2],10).toString(16)).slice(-2)+("0"+parseInt(a[3],10).toString(16)).slice(-2)},addSymbolPicker:function(m){var k=$("<button id='draw-buttonsymbolselect'>"+this.lang.btnSymbol+"</button>"),h=$("<div id='draw-divsymbolseleced' />"),c=$("<div id='draw-divsymbolselect' />"),p=$("<span id='draw-spannoimage'/>");p.text(this.lang.lblNoImage);c.append(p);p.click(function(){h.css({"background-image":"none"});o.restoreTempStyle()});var e=this.symbols,q={},n={},d={};for(var j=0,l=e.length;j<l;j++){var a=e[j].url,g=$("<img />"),b=0;n[a]=e[j].height?e[j].height:(e[j].size?e[j].size:this.defaultSymbolSize);d[a]=e[j].width?e[j].width:(e[j].size?e[j].size:this.defaultSymbolSize);b=d[a]>n[a]?d[a]:n[a];q[a]=e[j].size?e[j].size:(b?b:this.defaultSymbolSize);g.prop("src",a);g.css({height:n[a],width:d[a]});c.append(g);g.click(function(){var i=$(this).prop("src");h.css({"background-image":"url("+i+")",size:q[i],width:d[i],height:n[i]});o.setPointTempStyle()})}c.height(this.symbolPickerHeight);var o=this;k.click(function(){$("#draw-divsymbolselect").show()});c.hover(function(){$(this).show()},function(){$(this).hide()});k.mouseleave(function(){$("#draw-divsymbolselect").hide()});m.append(k).append(c).append(h);c.hide();k.hide();return c},setPointTempStyle:function(){var a=$("#draw-divsymbolseleced"),e=a[0].style.backgroundImage,g="",d=sMap.util.takeAwayPx(a[0].style.size);if(e.substring(4,5)=='"'){g=(sMap.util.rightStrip(e,2)).substring(5)}else{g=(sMap.util.rightStrip(e,1)).substring(4)}var b=null;for(var c=0;c<this.symbols.length;c++){if(this.symbols[c].url==g){b=c}}if(g!=""){this.editLayer.styleMap.styles.temporary.defaultStyle.externalGraphic=g;this.editLayer.styleMap.styles.temporary.defaultStyle.pointRadius=d/2;this.editLayer.styleMap.styles.temporary.defaultStyle.fillOpacity=1;this.editLayer.styleMap.styles.temporary.defaultStyle.graphicYOffset=this.symbols[b].offsety?this.symbols[b].offsety:null;this.editLayer.styleMap.styles.temporary.defaultStyle.graphicXOffset=this.symbols[b].offsetx?this.symbols[b].offsetx:null}},restoreTempStyle:function(){this.editLayer.styleMap.styles.temporary.defaultStyle.externalGraphic=null;this.editLayer.styleMap.styles.temporary.defaultStyle.pointRadius=this.defaultPointRadius;this.editLayer.styleMap.styles.temporary.defaultStyle.fillOpacity=this.defaultFillOpacity;this.editLayer.styleMap.styles.temporary.defaultStyle.graphicYOffset=null;this.editLayer.styleMap.styles.temporary.defaultStyle.graphicXOffset=null},showSymbolPicker:function(){var a=$("#draw-divsymbolseleced"),b=$("#draw-buttonsymbolselect");a.show();b.show()},hideSymbolPicker:function(){var a=$("#draw-divsymbolseleced"),b=$("#draw-buttonsymbolselect");a.hide();b.hide()},makeDialogContent:function(){var c=$("<div id='drawDialogDiv' class='mxDiv' />");var b=this.makeEditButtons();this.addColorPicker(b);this.addSymbolPicker(b);c.append(b);var d=this.makeDescrDiv();c.append(d);var a=this.makeButtons();c.append(a);return c},makeButtons:function(){var a=$("<div id='mxButtonDiv' />");var b=$("<button id='draw-opencopylink'>"+this.lang.btnCopylink+"</button>");b.click(function(){sMap.events.triggerEvent("showlink",this,{})});b.button();a.append(b);return a},makeEditButtons:function(){var b=this.buttons;this.initiateMarkerEditing(b);var a=$("<div id='mxEditBtnsDiv' />");var e=$("<div id='mxEditLbl' />");var d=$("<div id='mxEditStyle' />");var c=$("<span>"+this.lang.helpText+"</span>");c.css({width:"170px",display:"inline"});e.append(c);a.append(e);a.append(this.panel);return a},initiateMarkerEditing:function(a){this.addEditLayer();if(!this.panel){this.drawEditToolbar(a,null)}this.bindFeatureCompleteEvents()},addEditLayer:function(){var b=this.map.getLayersByName(this.drawLayerConfig.name).length==1?true:false;if(!b){var a=this.drawLayerConfig.style;this.editLayer=new OpenLayers.Layer.Vector(this.drawLayerConfig.name,{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style(a["default"]),select:new OpenLayers.Style(a.select),temporary:new OpenLayers.Style(a.temporary)}),projection:new OpenLayers.Projection(this.map.projection),selectable:true,displayInLayerSwitcher:this.drawLayerConfig.displayInLayerSwitcher});sMap.config.layers.overlays.push(this.drawLayerConfig);sMap.events.triggerEvent("addlayer",this,{layer:this.editLayer});this.showHideEditLayer()}},srcIconPointOff:"img/editTools/point_off.png",srcIconLineOff:"img/editTools/line_off.png",srcIconPolygonOff:"img/editTools/polygon_off.png",srcIconModifyOff:"img/editTools/polygon_off.png",srcIconDeleteOff:"img/editTools/delete_off.png",srcIconMoveOff:"img/editTools/polygon_off.png",srcIconPointOn:"img/editTools/point_on.png",srcIconLineOn:"img/editTools/line_on.png",srcIconPolygonOn:"img/editTools/polygon_on.png",srcIconModifyOn:"img/editTools/polygon_on.png",srcIconDeleteOn:"img/editTools/delete_on.png",srcIconMoveOn:"img/editTools/polygon_on.png",renderButton:function(a,c){c=c||false;var b="_off",d="_on";var e=a.attr("src");if(c!==true){b="_on";d="_off"}a.attr("src",e.replace(b,d))},drawEditToolbar:function(u,e){e=e||{};var n=this;this.panel=$("<div id='draw-panel' />");var s=$("<div class='draw-button' id='draw-btn-point'><img src='"+this.srcIconPointOff+"'></img></div>"),z=$("<div class='draw-button' id='draw-btn-line'><img src='"+this.srcIconLineOff+"'></img></div>"),k=$("<div class='draw-button' id='draw-btn-polygon'><img src='"+this.srcIconPolygonOff+"'></img></div>"),q=$("<div class='draw-button' id='draw-btn-modify'><img src='"+this.srcIconModifyOff+"'></img></div>"),b=$("<div class='draw-button' id='draw-btn-move'><img src='"+this.srcIconMoveOff+"'></img></div>"),o=$("<div class='draw-button' id='draw-btn-delete'><img src='"+this.srcIconDeleteOff+"'></img></div>");this.buttons={point:s,line:z,polygon:k,modify:q,move:b,"delete":o};var B=function(){var c=$(this).attr("id").split("-")[2];if(!$(this).data("active")){n.deactivateButtonsAndControls($(this));$(this).data("active",true);n.renderButton($(this).find("img"),true);n.controls[c].activate()}else{$(this).data("active",false);n.renderButton($(this).find("img"),false);n.controls[c].deactivate()}};var l=new OpenLayers.Control.DrawFeature(this.editLayer,OpenLayers.Handler.Polygon,{title:this.lang.hoverTextPolygon,multi:true});l.events.register("activate",this,function(c){this.restoreTempStyle()});var x=new OpenLayers.Control.DrawFeature(this.editLayer,OpenLayers.Handler.Point,{title:this.lang.hoverTextPoint,multi:false});x.events.register("activate",this,function(c){this.setPointTempStyle();this.showSymbolPicker()});x.events.register("deactivate",this,function(c){this.hideSymbolPicker()});var m=new OpenLayers.Control.DrawFeature(this.editLayer,OpenLayers.Handler.Path,{title:this.lang.hoverTextLine,multi:true});m.events.register("activate",this,function(c){this.restoreTempStyle()});var p=new OpenLayers.Control.DragFeature(this.editLayer,{title:this.lang.hoverTextMove,onComplete:function(){sMap.events.triggerEvent("updatelinkentries",this,{})}});var A=new OpenLayers.Control.ModifyFeature(this.editLayer,{title:this.lang.hoverTextModify,vertexRenderIntent:"select",displayClass:"olControlModifyFeature"});var h=new OpenLayers.Control.DeleteFeature(this.editLayer,{title:this.lang.hoverTextDelete});var v=new OpenLayers.Control.Button({title:this.lang.hoverTextStyle,type:OpenLayers.Control.TYPE_BUTTON,trigger:function(){if(n.selectedFeature){n.styleFeature([n.selectedFeature])}},displayClass:"olControlSaveFeatures"});var w=new OpenLayers.Control.Button({title:this.lang.hoverTextSave,type:OpenLayers.Control.TYPE_BUTTON,trigger:function(){n.saveEdits()},displayClass:"olControlSaveFeatures"});this.controls={point:x,line:m,polygon:l,move:p,modify:A,"delete":h,style:v,save:w};var g=[];for(var d in this.useButtons){if(this.useButtons[d]===true){var j=this.controls[d];var a=this.buttons[d];g.push(j);a.click(B).mouseenter(function(){n.renderButton($(this).find("img"),true)}).mouseleave(function(){if(!$(this).data("active")){n.renderButton($(this).find("img"),false)}});this.panel.append(a)}}if(g.length){this.map.addControls(g)}for(var r=0,t=g.length;r<t;r++){var y=g[r];y.events.register("activate",this,function(c){this.unselectFeatures()})}},styleFeature:function(m){var l=m,j=this.editLayer.styleMap.styles.temporary.defaultStyle,e=j.fillColor,d=j.externalGraphic,a=j.graphicYOffset,b=j.graphicXOffset,n=j.pointRadius,k=j.fillOpacity,c=this.editLayer.styleMap.styles["default"].defaultStyle;if(true){for(var h=0;h<l.length;h++){var g={};if(d){g={pointRadius:n,fillOpacity:k,externalGraphic:d,graphicYOffset:a,graphicXOffset:b,cursor:"pointer"}}if(!d){g={pointRadius:n,fillColor:e,fillOpacity:k,graphicName:this.defaultGraphicName,strokeWidth:this.defaultStrokeWidth,strokeColor:e,strokeOpacity:this.defaultStrokeOpacity,cursor:"pointer"}}l[h].style=g}this.editLayer.redraw()}},bindFeatureCompleteEvents:function(){this.editLayer.events.register("featureadded",this,function(b){if(this.autoDeactivateTool){this.deactivateButtonsAndControls()}var a=b.feature;this.showHideEditLayer();this.styleFeature([a]);a.attributes.info="";a.attributes.editable=true;a.attributes.orgid=a.id;this.selectFeature(a);sMap.events.triggerEvent("updatelinkentries",this,{});OpenLayers.Event.stop(b)});this.editLayer.events.register("beforefeaturemodified",this,function(a){this.checkEditable(a);this.selectFeature(a.feature)});this.editLayer.events.register("featuremodified",this,function(a){this.unselectFeatures();sMap.events.triggerEvent("updatelinkentries",this,{})});this.editLayer.events.register("beforefeatureremoved",this,function(a){this.checkEditable(a)});this.editLayer.events.register("featureremoved",this,function(a){this.showHideEditLayer();this.unselectFeatures();sMap.events.triggerEvent("updatelinkentries",this,{})})},checkEditable:function(a){if(!a.feature.attributes.editable){}},selectFeature:function(a){var b=a.clone();b.layerName=this.drawLayerConfig.name;sMap.events.triggerEvent("select",this,{features:[b]})},showHideEditLayer:function(){if(this.editLayer.features.length>0&&!this.editLayer.visibility){sMap.events.triggerEvent("showlayer",this,{layerName:this.editLayer.name})}if(this.editLayer.features.length==0&&this.editLayer.visibility){sMap.events.triggerEvent("hidelayer",this,{layerName:this.editLayer.name})}},unselectFeatures:function(){sMap.events.triggerEvent("unselect",this,{})},selected:function(b){var a=b.selectedFeatures.length?b.selectedFeatures[0]:null;if(a){if(a.attributes.editable||this.editLinkFeatures){this.selectedFeature=this.editLayer.getFeatureById(a.attributes.orgid);this.addButtonsToPopup();$("#mxDescrEntry").prop("disabled",false);$("#mxDescrEntry").focus();this.updateTextField(a.attributes.info)}}},unselected:function(a){$("#mxDescrEntry").prop("disabled",true);this.updateTextField(this.lang.descrEntryText);this.selectedFeature=null;sMap.events.triggerEvent("updatelinkentries",this,{})},getSelectedFeature:function(){var a=null;if(selectLayer.features.length>0){a=selectLayer.features[0]}return a},updateTextField:function(a){a=a||"";$("#mxDescrEntry").val(a);$("#mxDescrEntry").focus()},makeDescrDiv:function(){a=this;var d=$("<div id='mxDescrDiv' />");var b=$("<div id='mxDescrLbl' class='mxLbl' />");b.text(this.lang.descrLblText);var c=$("<textarea id='mxDescrEntry' />");d.append(b);d.append(c);c.prop("disabled",true);c.text(this.lang.descrEntryText);var a=this;c.keyup(function(g){a.selectedFeature.attributes.info=this.value;$("#draw-text").text($(this).val());sMap.events.triggerEvent("updatelinkentries",this,{})});return d},deactivateButtonsAndControls:function(b){var a=this,c=null;if(b){c=b.siblings()}else{c=this.panel.children()}c.each(function(){$(this).data("active",false);var d=$(this).attr("id").split("-")[2];a.controls[d].deactivate();a.renderButton($(this).find("img"),false)})},makeDialog:function(b){var a=this;sMap.util.createDialog(b,{titleText:this.lang.headerText,position:this.dialogStartPosition,width:this.width,height:this.height,onClose:function(){a.deactivate.call(a)},onOpen:null});return b},defineClickPopupButton:function(b){var a=this;$("#btnEditObject").click(function(c){a.dialogDiv.dialog("open");$("#mxDescrEntry").focus();c.preventDefault()});$("#mxBtnErase").click(function(d){var c=a.getSelectedFeature()||null;if(c!=null){var g=a.editLayer.getFeatureById(c.attributes.orgid);a.editLayer.destroyFeatures([g]);a.unselectFeatures()}})},addButtonsToPopup:function(){var d=this.getSelectedFeature()||null;if(d&&d.popup){var g="<div id='btnEditObject' class='smapBtn'>"+this.lang.popupBtnEdit+"</div>";var c="<div id='mxBtnErase' class='smapBtn'>"+this.lang.popupBtnDelete+"</div>";var b=d.popup.contentHTML||"";if(b.search("btnEditObject")==-1){var e="<div id='btnCont' class='btnCont'>"+g+c+"</div>";b=b+e;d.popup.setContentHTML(b);d.popup.updateSize();var a=$(".olFramedCloudPopupContent").width();this.addPopupSize(35);$("#btnCont").width(a);this.defineClickPopupButton(d)}}},addPopupSize:function(c){var b=$(".olFramedCloudPopupContent").height();$(".olFramedCloudPopupContent").height(b+c);var a=this.getSelectedFeature();a.popup.updateSize();a.popup.draw()},creatingwebparams:function(){var e=$.inArray(this.drawLayerConfig.name,sMap.db.webParams.OL||[]);if(e>-1){sMap.db.webParams.OL.splice(e,1)}var s=this.editLayer,o="";if(s){var d=s.features;var C="$$",h="££",p="¤¤";var B=null,v=null,a="",g=null,D="",A="",l="";var m=Math.pow(10,this.decimals);for(var x=0,z=d.length;x<z;x++){B=d[x];if(B.attributes.info||B.attributes.info==""){var r=B.geometry.getVertices();for(var u=0,t=r.length;u<t;u++){var q=r[u];q.x=Math.round(q.x*m)/m;q.y=Math.round(q.y*m)/m}var y=B.geometry.toString(),c=null,b=null,E=null;var F=encodeURIComponent(y);o=o+F+C;v=B.attributes.info?B.attributes.info.replace(/,/g,h):"";v=v.replace(/\n/g,p);v=encodeURIComponent(v);a=a+v+C;g=B.attributes.measurement?"1":"0";D=D+g+C;if(B.style){var e=0;if(B.style.externalGraphic){for(var w=0;w<this.symbols.length;w++){if(B.style.externalGraphic==this.symbols[w].url){e=w}}A="s"+e}else{for(var u=0;u<this.colors.length;u++){if(B.style.strokeColor==this.colors[u]){e=u}}A="c"+e}}else{A=0}l=l+A+C}}if(o!=""){var z=C.length;o=sMap.util.rightStrip(o,z)+","+sMap.util.rightStrip(a,z)+","+sMap.util.rightStrip(D,z)+","+sMap.util.rightStrip(l,z);o=$.base64.encode(o).replace(/=/g,"%3D");sMap.db.webParams.features=o}}},extractRGB:function(d){if(d){var j=d.indexOf("(")+1,c=d.indexOf(",",j),h=parseInt(d.substring(j,c)),e=0,a=0;j=c+1;c=d.indexOf(",",j);e=parseInt(d.substring(j,c));j=c+1;c=d.indexOf(")");a=parseInt(d.substring(j,c));var i=[h,e,a];return i}},fetchFromDb:function(c){var a=this;var b=sMap.config.proxyHost?sMap.config.proxyHost+this.fetchFromDbPath:this.fetchFromDbPath;$.ajax({url:b,data:{get_id:c},type:"POST",error:function(e,d){alert("Fel! Kontakta ansvarig")},success:function(d){a.drawTheFeatures.call(a,d)}});return false},drawTheFeatures:function(g){var k=g;if(k&&k.length>=1){k=k.replace(/%3D/g,"=");var h=k||"";var s=h.substring(h.length-1,h.length);if(s=="\n"){h=h.substr(0,h.length-1)}var b=$.base64.decode(h);var u=b.split(",");var v=u[0];var a=u[1];var o=u[2];var e=u[3]?u[3]:"0";var r="$$";var d=/££/g;var c=/¤¤/g;var p=(v.search(r)!=-1)?v.split(r):[v];var l=(a.search(r)!=-1)?a.split(r):[a];var q=(o.search(r)!=-1)?o.split(r):[o];var t=(e.search(r)!=-1)?e.split(r):[e];var n=null,j=null;for(var m=0;m<p.length;m++){p[m]=decodeURIComponent(p[m]).replace(d,",");j=l[m]?decodeURIComponent(l[m]):null;if(j){j=j.replace(d,",");j=j.replace(c,"\n")}l[m]=j}this.markerWktArr=p;this.markerTextArr=l;this.measureArr=q;this.addEditLayer();this.addMarkers(this.markerWktArr,this.markerTextArr,this.measureArr,t);if(!this.dialogDiv&&this.editLinkFeatures){this.dialogDiv=this.makeDialogContent();this.dialogDiv=this.makeDialog(this.dialogDiv)}if(this.selectLinkFeatures){this.selectFeature(this.editLayer.features[this.editLayer.features.length-1])}this.showHideEditLayer()}},afterapplyingwebparams:function(){var a=sMap.db.startingWebParamsObject.FEATURES;if(a=="short"){this.fetchFromDb(sMap.db.startingWebParamsObject.ID)}else{this.drawTheFeatures(a)}},addMarkers:function(n,q,j,b){var m=this.editLayer;var h=null,l=null,o=null,d=null,a=null;for(var g=0;g<n.length;g++){l=n[g];o=q[g]?q[g]:"";measureText=j[g]?j[g]:"0";a=b[g]?b[g]:"0";var p=new OpenLayers.Geometry.fromWKT(l);h=new OpenLayers.Feature.Vector(p);h.attributes.info=o;if(parseInt(measureText)==1){var d=markerEditingCtrl.measureFeatureToString.call(markerEditingCtrl,h);h.attributes.measurement=d;var c=["div",null,"measurement","popup-measure"];if(h.popUpHeaders&&h.popUpHeaders.length>0){h.popUpHeaders.push(c)}else{h.popUpHeaders=[c]}}if(a!=0){var e=null,k=parseInt(a.substring(1));if(a.substring(0,1)=="s"){e={pointRadius:this.symbols[k].size?this.symbols[k].size/2:this.defaultSymbolSize/2,fillOpacity:1,externalGraphic:this.symbols[k].url,graphicYOffset:this.symbols[k].offsety?this.symbols[k].offsety:null,graphicXOffset:this.symbols[k].offsetx?this.symbols[k].offsetx:null,cursor:"pointer"}}if(a.substring(0,1)=="c"){e={pointRadius:this.defaultPointRadius,fillColor:this.colors[k],fillOpacity:this.defaultFillOpacity,graphicName:this.defaultGraphicName,strokeWidth:this.defaultStrokeWidth,strokeColor:this.colors[k],strokeOpacity:this.defaultStrokeOpacity,cursor:"pointer"}}h.style=e}m.addFeatures([h]);m.features[g].attributes.orgid=m.features[g].id}},CLASS_NAME:"sMap.Module.Draw"});sMap.moduleConfig.Draw={activateFromStart:false,toolbarIndex:1,addToToolsMenu:false,decimals:0,dialogStartPosition:[300,100],width:240,height:400,useButtons:{point:true,line:true,polygon:true,move:false,modify:false,"delete":false,style:false},autoDeactivateTool:true,selectLinkFeatures:true,editLinkFeatures:false,colors:["#ffffff","#c0c0c0","#808080","#000000","#ff0000","#800000","#ffff00","#808000","#00ff00","#008000","#00ffff","#008080","#0000ff","#000080","#ff00ff","#800080","#ff5b00","#ff1493","#4b0082","#adff2f"],symbols:[{url:"http://www.smap.se/mapsymbols/camping_mini.png",size:20},{url:"http://www.smap.se/mapsymbols/hotell_mini.png"},{url:"http://www.smap.se/mapsymbols/stuga_mini.png",size:20},{url:"http://www.smap.se/mapsymbols/vandrarhem_mini.png",size:20},{url:"http://www.smap.se/mapsymbols/overnatt_mini.png"},{url:"http://www.smap.se/mapsymbols/Ikoner/Transport/Buss.png",size:37,width:33,height:37,offsety:-32},{url:"http://www.smap.se/mapsymbols/Ikoner/Transport/Busshallplats.png",size:37,width:33,height:37,offsety:-32},{url:"http://www.smap.se/mapsymbols/Ikoner/Transport/Flyg.png",size:37,width:33,height:37,offsety:-32},{url:"http://www.smap.se/mapsymbols/Ikoner/Transport/Parkering.png",size:37,width:33,height:37,offsety:-32},{url:"http://www.smap.se/mapsymbols/Ikoner/Transport/Tag.png",size:37,width:33,height:37,offsety:-32},{url:"http://www.smap.se/mapsymbols/Ikoner/Kultur/Konsert.png",size:37,width:33,height:37,offsety:-32},{url:"http://www.smap.se/mapsymbols/Ikoner/Kultur/Museum.png",size:38,width:33,height:38,offsety:-33},{url:"http://www.smap.se/mapsymbols/Ikoner/Kultur/Teater.png",size:38,width:33,height:38,offsety:-33},{url:"http://www.smap.se/mapsymbols/Ikoner/Utbildning/Forskola.png",size:38,width:33,height:38,offsety:-33},{url:"http://www.smap.se/mapsymbols/Ikoner/Utbildning/Grundskola.png",size:37,width:33,height:37,offsety:-32},{url:"http://www.smap.se/mapsymbols/Ikoner/Utbildning/Gymnasium.png",size:37,width:33,height:37,offsety:-32},{url:"http://www.smap.se/mapsymbols/Ikoner/Utbildning/EftergymnUtb.png",size:37,width:33,height:37,offsety:-32}],symbolPickerHeight:200,defaultSymbolSize:20,defaultFillOpacity:0.3,defaultPointRadius:6,defaultGraphicName:"square",defaultStrokeWidth:4,defaultStrokeOpacity:1,drawLayerConfig:{name:"theDrawLayer",displayName:"Ritalager",layerType:"vector",geomType:"point",selectable:true,displayInLayerSwitcher:false,legend:{url:"img/icon_edit.png"},popup:"<span id='draw-text' class='popup-text1'>${info}</span>",style:{"default":{pointRadius:6,fillColor:"#ff5b00",fillOpacity:0.3,graphicName:"square",strokeWidth:4,strokeColor:"#ff5b00",strokeOpacity:1,cursor:"pointer",externalGraphic:"img/geometries/polygon.png"},temporary:{pointRadius:6,fillColor:"#ff5b00",fillOpacity:0.3,graphicName:"square",strokeWidth:4,strokeColor:"#ff5b00",strokeOpacity:1,cursor:"pointer"},select:{pointRadius:6,fillColor:"#00FFFF",fillOpacity:0.3,strokeOpacity:1,graphicName:"circle",strokeWidth:4,strokeColor:"#00FFFF",cursor:"pointer"}}},zIndex:697,fetchFromDbPath:"http://www.smap.se/cgi-bin/shorten/sMap_show.py"};sMap.Lang.lang.Draw={"sv-SE":{buttonText:"Rita",headerText:"Ritaverktyg",helpText:"Välj verktyg nedan och markera i kartan. Avsluta med dubbelklick.",moreHelpLinkText:"Hjälp",hoverTextPoint:"Punkt",hoverTextLine:"Linje",hoverTextPolygon:"Yta",hoverTextMove:"Flytta",hoverTextModify:"Ändra",hoverTextDelete:"Radera",descrLblText:"Beskriv markering",descrEntryText:"Skapa eller markera ett objekt för att ändra texten",popupBtnEdit:"Redigera",popupBtnDelete:"Radera",btnColor:"Välj färg",btnSymbol:"Välj symbol",lblNoImage:"Ingen bild",btnCopylink:"Skapa länk till karta"},en:{buttonText:"Draw",headerText:"Draw tools",helpText:"Select a tool and draw in the map. Finish with doubleclick.",moreHelpLinkText:"Help",hoverTextPoint:"Point",hoverTextLine:"Line",hoverTextPolygon:"Area",hoverTextMove:"Move",hoverTextModify:"Edit",hoverTextDelete:"Delete",descrLblText:"Describe object",descrEntryText:"Create or mark an object to change text",popupBtnEdit:"Edit",popupBtnDelete:"Delete",btnColor:"Color",btnSymbol:"Symbol",lblNoImage:"No image",btnCopylink:"Create link to map"}};sMap.Module.Email=OpenLayers.Class(sMap.Module,{_working:false,EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Email.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Email.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}this.createEpostDialog();return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}if(this.ePostDialog&&this.ePostDialog.dialog){$("#email").validationEngine("hideAll");this.ePostDialog.dialog("destroy");this.ePostDialog.empty().remove();this.ePostDialog=null}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){if(this.addToToolsMenu){sMap.events.triggerEvent("addtomenu",this,{index:this.toolbarIndex,label:this.lang.labelBtnEpost,iconCSS:"icon-epost",tagID:"button-epost",menuId:this.addToToolsMenu})}else{sMap.events.triggerEvent("addtoolbutton",this,{index:this.toolbarIndex,label:this.lang.labelBtnEpost,iconCSS:"icon-epost",tagID:"button-epost"})}},createEpostDialog:function(){var a=this;var c=$("<div class='ePost-dialogDiv' id='email-dialog' />");this.ePostDialog=c;$("body").append(c);this.createEpostForm();var b=this.ePostDialog.outerWidth()<300?300:this.ePostDialog.outerWidth();this.ePostDialog.outerWidth(b);sMap.util.createDialog(this.ePostDialog,{modal:false,draggable:true,resizable:false,width:271,height:"auto",position:"center",titleText:this.lang.ePostDialogTitle,closeOnEscape:false,onOpen:function(e){},buttons:[{text:this.lang.sendButton,click:function(){a.validateEmail();var g=$("#epostform");var i=g.find("id");var e=g.find("valid");var h=g.attr("valueMissing");a.sendEmail()}}]});this.ePostDialog.dialog("open");$("input[id='email']").focusout(function(){a.validateEmail()});var d=$(".ui-dialog-titlebar-close");d.click(function(){a.deactivate()})},createEpostForm:function(){var h=$("<form id='epostform' method='post' action='submit.action' />");this.ePostDialog.append(h);var d=$("<fieldset />");h.append(d);var g=$("<label for='epostto'>"+this.lang.labelTo+"</label>");d.append(g);var i=$("<input type='email' id='epostto' class='validate[required, custom[email]]' name='email'>");this.receiverTo=i;d.append(i);var a=$("<label for='epostsubject'>"+this.lang.labelSubject+"</label>");d.append(a);var c=$("<input type='text' id='epostsubject' value='"+this.lang.subjText+"'>");d.append(c);var e=$("<label for='epostmsg'>"+this.lang.labelMsg+"</label>");d.append(e);var b=$("<textarea id='epostmsg' class='text ui-widget-content ui-corner-all'></textarea>");b.text(sMap.cmd.getParamsAsString(true));d.append(b)},destroyEpostDialog:function(){if(this.ePostDialog){this.ePostDialog.dialog("destroy");this.ePostDialog.empty().remove();this.ePostDialog=null}},addSendBtn:function(){var c=this;var b=$("<div id='epost-btnpanel' align='right' />"),a=$("<button id='epost-sendbtn'><b>"+this.lang.sendButton+"</b></button>");b.append(a);this.ePostDialog.append(b);a.click(function(){c.validateEmail();var e=$("#epostform");var h=e.find("id");var d=e.find("valid");var g=e.attr("valueMissing");c.sendEmail();c.ePostDialog.dialog("close");c.deactivate()});a.button()},validateEmail:function(){var a=$("#epostform").validationEngine()},sendEmail:function(){if(this._working){return false}sMap.cmd.loading(true,{text:this.lang.sending});var e=this.ePostDialog;var b=e.find("#epostto").val(),a=e.find("#epostsubject").val(),c=e.find("#epostmsg").val();this._working=true;$.ajax({type:"POST",url:sMap.config.proxyHost+this.eMailURL,context:this,data:{toEmail:b,subject:a,msg:c},dataType:"text",error:function(d,h,g){debug.log(h)},success:function(g,h,d){this.ePostDialog.dialog("close");this.deactivate();alert("Mailet har skickats!")},error:function(d,g,h){alert("Ett fel har uppstått. Error: "+g)},complete:function(){sMap.cmd.loading(false);this._working=false}})},CLASS_NAME:"sMap.Module.Email"});sMap.moduleConfig.Email={activateFromStart:false,eMailURL:"http://kartor.smap.se/cgi-bin/email/smapSendEmail.py?",eMailTo:"toEmail=",eMailSubject:"subject=",eMailMsg:"msg="};sMap.Lang.lang.Email={"sv-SE":{labelText:"Tryck här",labelBtnEpost:"E-Post",ePostDialogTitle:"E-Post",labelTo:"Mottagarens e-postadress:",labelCC:"Kopia ",labelFrom:"Från",labelSubject:"Ämne:",labelMsg:"Meddelande:",sendButton:"Skicka",requiredField:"Krävs!",labelAddresses:"E-postadresser",subjText:"Länk från sMap",sending:"Skickar"},en:{labelText:"Press here",labelBtnEpost:"E-Mail",ePostDialogTitle:"E-Mail",labelTo:"To",labelCC:"CC",labelFrom:"From",labelSubject:"Subject",labelMsg:"Message",sendButton:"Send",requiredField:"Required!",labelAddresses:"Email addresses",subjText:"Link from sMap",sending:"Skickar"}};sMap.Module.ExtractClick=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.ExtractClick.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.ExtractClick.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}sMap.events.triggerEvent("unselect",this,{});sMap.util.showMouseMoveText(this.lang.mouseMoveText);sMap.events.triggerEvent("deactivate",this,{module:"sMap.Module.Select"});this.addClickControl();return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}if(this.dialog){this.dialog.dialog("destroy");this.dialog.empty().remove()}sMap.util.hideMouseMoveText();sMap.events.triggerEvent("activate",this,{module:"sMap.Module.Select"});return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a="addtoolbutton";if(this.addToToolsMenu){a="addtomenu"}sMap.events.triggerEvent(a,this,{index:this.toolbarIndex,label:this.displayName,hoverText:this.hoverText,iconCSS:"ui-icon-pencil",tagID:"btn-extractclick",left:this.left,right:this.right,menuId:this.addToToolsMenu})},addClickControl:function(){var a=this;this.handler=new OpenLayers.Handler.Point(this,{done:function(m){sMap.util.hideMouseMoveText();sMap.cmd.loading(true);var c=this.radius||1;var d=new OpenLayers.Bounds(m.x-c,m.y-c,m.x+c,m.y+c);var e=this.map.getViewPortPxFromLonLat(new OpenLayers.LonLat(m.x,m.y));var j={service:"WFS",srsName:this.map.projection,typeName:this.wfsName,version:this.wfsVersion,request:"GetFeature",format:"text/geojson",outputFormat:"json",maxFeatures:1,bbox:d.toBBOX()};var h=$.Deferred();h.done(function(o){var q,p={};for(q=0,len=o.length;q<len;q++){$.extend(p,o[q].attributes)}a.onFeaturesFound(p)});h.fail(function(i){alert("Ett fel uppstod i kommunikationen med tjänsten.\nMeddelande: "+i)});var k,l,b=0,g=[],n=this.wfsNames;for(k=0,len=n.length;k<len;k++){j.typeName=n[k];b+=1;$.ajax({type:"POST",url:sMap.config.proxyHost+this.wfsService,data:j,dataType:"text",context:this,success:function(p){var o=new OpenLayers.Format.GeoJSON();var i=o.read(p);g=g.concat(i[0]);b-=1;if(b<=0){sMap.cmd.loading(false);h.resolve(g)}},error:function(i){sMap.cmd.loading(false);h.reject(i)},complete:function(){}})}}},{persist:true});this.handler.activate()},onFeaturesFound:function(c){c=c||{};var m=this.map.getControlsByClass("sMap.Module.ExtractClick")[0];if(!fs||!fs.length){return}if(m.dialog){try{m.dialog.dialog("destroy");m.dialog=null}catch(j){m.dialog=null}}var l=c.fnr,i=c.fastighet,h=c.easting||this.clickedLonLat.lon,b=c.northing||this.clickedLonLat.lat;if(!l){alert("Hittade inget fastighetsnummer för platsen");return}var a=m.redirectUrl.charAt(m.redirectUrl.length-1)!=="?"?m.redirectUrl+"?":m.redirectUrl;a=a+"fnr="+l;if(!m.dialog){var k=$("<div id='extract-click-dialog' />");m.dialog=k;k.dialog({title:"Skapa FNR",autoOpen:false,width:315,height:"auto",modal:false,close:function(){if($(this).dialog){$(this).dialog("destroy").empty().remove();m.dialog=null;m.deactivate()}},buttons:[{text:m.lang.labelContinue,click:function(){var d="http://sbkspace.malmo.se/nbk/nbkinsert.aspx?mNorthing="+b+"&mEasting="+h+"&fnr="+l+"&gdp="+gdp+"&pdp="+pdp;window.open(d,"_blank")}}]})}var g='<form><table><tr><td>Fastighet</td><td><input disabled id="ec-fastighet" type="text" value="'+(i||"-")+'"></input></td></tr><tr><td>Easting</td><td><input disabled id="ec-easting" type="text" value="'+h+'"></input></td></tr><tr><td>Northing</td><td><input disabled id="ec-northing" type="text" value="'+b+'"></input></td></tr><tr><td>Gällande detaljplan</td><td><input disabled id="ec-cur_dp_plan" type="text" value="'+gdp+'"></input></td></tr><tr><td>Pågående detaljplan</td><td><input disabled id="ec-dev_dp_plan" type="text" value="'+pdp+'"></input></td></tr></table></form>';m.dialog.append(g);m.dialog.dialog("open")},CLASS_NAME:"sMap.Module.ExtractClick"});sMap.moduleConfig.ExtractClick={activateFromStart:false,wfsService:"http://xyz.malmo.se/geoserver/wfs",wfsNames:["malmows:SMA_SUM_FASTYTA_P","malmows:SMA_PAGAENDE_PLANER_P","malmows:SMA_PLANOMR_P"],wfsVersion:"1.0.0",radius:1,redirectUrl:"http://sbkspace.malmo.se/nbk/nbkinsert.aspx",displayName:"",extractLayerConfig:null};sMap.Lang.lang.ExtractClick={"sv-SE":{btnText:"Skapa fastighetspunkt",mouseMoveText:"Klicka i kartan för att lägga till en punkt.",labelContinue:"Gå vidare"},en:{btnText:"Create building point",mouseMoveText:"Click somewhere on the map to add a point.",labelContinue:"Continue"}};sMap.Module.FeatureRequester=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["getfeatures"],EVENT_TRIGGERS:["fetchedfeatures","fetchedwfsfeatures","fetchedvectorfeatures"],foundFeatures:{},foundVectorFeatures:null,foundWfsFeatures:null,maxFeatures:10,userAlertedNoWFSFound:false,reqLayers:null,wfsCounter:null,requestCounter:null,initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.FeatureRequester.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.FeatureRequester.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){},getfeatures:function(d){if(this.requestOnProcess){return false}var c=d.layers||this.getSelectableLayers();var b=false;for(var a in c){if(c[a].length){b=true}}if(b===true){this.requestOnProcess=true;this.request(c,d.options)}},getSelectableLayers:function(){var e=sMap.map.layers,l={};for(var g=0,k=e.length;g<k;g++){var h=e[g];if(h.getVisibility()&&h.calculateInRange()&&h.selectable){var m=h.CLASS_NAME.split(".")[2];if(!l[m]){l[m]=[]}l[m].push(h)}}if(this.requestableLayers&&this.requestableLayers.length){var c={},b=this.requestableLayers,a=[];for(var m in l){a.push(m)}for(var d=0;d<a.length;d++){var m=a[d];var e=l[m];for(var g=0,k=e.length;g<k;g++){if($.inArray(e[g].name,b)!==-1){if(!c[m]){c[m]=[]}c[m].push(e[g])}}}l=c}return l},getLayersConfig:function(b){var e=[],g=null;for(var d=0,a=b.length;d<a;d++){g=sMap.cmd.getLayerConfig(b[d]);if(g.type.toUpperCase()=="WMS"){e.push(g)}}return e},countDown:function(b){b=b||{};this.requestCounter-=1;if(this.requestCounter<=0){if(this.userAlertedNoWFSFound!==true&&this.noWfsResponse.length>0){var e="";for(var c=0,a=this.noWfsResponse.length;c<a;c++){e+="\n- "+this.noWfsResponse[c]}alert("Fick inget WFS-svar från följande lager:\n"+e);this.userAlertedNoWFSFound=true}OpenLayers.Util.extend(this.foundFeatures,this.foundWfsFeatures);OpenLayers.Util.extend(this.foundFeatures,this.foundVectorFeatures);var d=this.flattenFeaturesObjToArray(this.foundFeatures);this.requestOnProcess=false;sMap.events.triggerEvent("fetchedfeatures",this,{features:d,select:b.select||false,bounds:b.bounds})}},flattenFeaturesObjToArray:function(e){var g=[],h=null;for(var c in e){var b=e[c];for(var d=0,a=b.length;d<a;d++){h=b[d];h.layerName=c;g.push(h)}}return g},request:function(a,d){d=d||{};this.reqLayers=a;this.foundFeatures={};this.foundVectorFeatures={};this.foundWfsFeatures={};this.noWfsResponse=[];a.WMS=a.WMS||[];a.Vector=a.Vector||[];this.wfsCounter=a.WMS.length||0;var c=(!a.Vector||a.Vector.length==0||!d.bounds)?0:1;var b=(!a.WMS||a.WMS.length==0)?0:1;this.requestCounter=c+b;this.requestedAllWFS=false;this.requestWMSLayers(a.WMS,d);if(d.bounds){this.requestVectorLayers(a.Vector,d.bounds,d)}},requestWMSLayers:function(d,m){m=m||{};var b={single:false,hover:false};m=$.extend({},b,m);this.typeNameTolayerName={};for(var e=0,h=d.length;e<h;e++){var g=d[e];var l=sMap.cmd.getLayerConfig(g.name);var j=l.getFeatureInfo||{};if(j&&j.URL&&m.bounds){var a=this.makeURL(j,m.bounds);this.requestWFSWithURL(a,m)}else{var k=OpenLayers.Protocol.WFS.fromWMSLayer(g);m.geometryName=j.geometryName||"the_geom";m.layerName=g.name;m.filter=l.filter;this.requestWFSWithProtocol(k,m)}}this.requestedAllWFS=true},makeURL:function(b,c){var e={service:b.service||"wfs",srs:this.map.projection,typename:b.layers,version:b.version||"1.0.0",request:"GetFeature",outputformat:"GML2",format:"text/xml",bbox:c.toBBOX(),maxfeatures:this.maxFeatures,width:this.map.getCurrentSize().w,height:this.map.getCurrentSize().h};var a=b.URL.charAt(b.URL.length-1)=="?"?b.URL:b.URL+"?";var d=sMap.util.paramsObjToString(e);return a+d},requestWFSWithURL:function(d,c){var b=this;var a=sMap.config.proxyHost?sMap.config.proxyHost+encodeURIComponent(d):d;$.ajax({url:a,type:"GET",dataType:"text",context:this,beforeSend:function(e){e.ieDocumentURI=d},success:function(j,h,o){var p=o.responseXML?(o.responseXML.documentURI?decodeURIComponent(o.responseXML.documentURI.toLowerCase()):o.ieDocumentURI):o.ieDocumentURI;var q=p.split("?");var e=q[q.length-1];var i=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters("?"+e));var l=new OpenLayers.Format.GML();if(j.search(/exception/gi)===-1){var g=l.read(j);if(g.length){var n=i.TYPENAME.toString();var m=sMap.cmd.getLayerConfigsBy("getFeatureInfo.layers",n);var k=m[0].name;this.foundWfsFeatures[k]=g}}else{debug.log("Server exception from WFS-layer: "+i.TYPENAME)}},error:function(){},complete:function(){this.wfsCounter-=1;this.checkCount.call(b,c)}})},typeNameTolayerName:{},requestWFSWithProtocol:function(i,k){k=k||{};var b=k.filter,a=k.bounds;if(a){var e=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,value:a});if(!b){b=e}else{b=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[e,b]})}}var j=this;var c="";i.format.geometryName=k.geometryName||"the_geom";var g=i.options.featurePrefix+":"+i.options.featureType;var h=false;if(k.filter){if(!this.typeNameTolayerName[g]){this.typeNameTolayerName[g]=[]}else{}this.typeNameTolayerName[g].push([k.filter,k.layerName]);if(h===true){j.wfsCounter-=1;return false}}else{this.typeNameTolayerName[g]=k.layerName}var d=i.read({maxFeatures:this.maxFeatures,filter:b,callback:function(A){j.wfsCounter-=1;if(A.success()){var m=A.features||[];if(m&&m.length&&m[0].geometry){var x=A.priv.responseText;var r=x.split('xsi:schemaLocation="');var v=r[1],n="";v=v.split(" ");for(var o=0;o<v.length;o++){var z=v[o].indexOf("typeName");if(z>0){n=v[o]}}n=OpenLayers.Util.upperCaseObject(OpenLayers.Util.getParameters(n));var y=this.typeNameTolayerName[n.TYPENAME.replace('"',"")],s=null,u=null;if(y instanceof Array){var l=null;for(var p=0,w=m.length;p<w;p++){u=m[p];for(var q=0,t=y.length;q<t;q++){l=y[q][0];if(l.evaluate(u.attributes)){s=y[q][1];if(!j.foundWfsFeatures[s]){j.foundWfsFeatures[s]=[]}j.foundWfsFeatures[s].push(u)}}}}else{s=y;j.foundWfsFeatures[s]=m}}}else{debug.warn("sMap-error: Could not request one of the WMS/WFS-layers. Check proxy and/or the getFeatureInfo property of the layer's config.")}j.checkCount.call(j,k)},scope:this})},checkCount:function(a){if(this.wfsCounter<=0&&this.requestedAllWFS===true){sMap.events.triggerEvent("fetchedwfsfeatures",this,{features:this.foundWfsFeatures});this.countDown(a)}},requestVectorLayers:function(g,a,o){if(!g||g.length==0){return false}if(!a||$.isEmptyObject(a)){return false}var m=a.toGeometry();for(var e=0,l=g.length;e<l;e++){var c=[],h=g[e];var b=h.features||[],k=null,j=null;for(var n=0,d=b.length;n<d;n++){k=b[n].clone();j=m.intersects(k.geometry);if(j===true){c.push(k)}}if(c.length){this.foundVectorFeatures[h.name]=c}}sMap.events.triggerEvent("fetchedvectorfeatures",this,{features:this.foundVectorFeatures});this.countDown(o)},CLASS_NAME:"sMap.Module.FeatureRequester"});sMap.moduleConfig.FeatureRequester={activateFromStart:false,maxFeatures:20};sMap.Lang.lang.FeatureRequester={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.GetFeatureInfo=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["featuredeleted"],EVENT_TRIGGERS:["addtomenu","addtoolbutton","showlayer","hidelayer","addlayer"],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.GetFeatureInfo.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.GetFeatureInfo.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}if(!this.infocontrol){this.addControl();this.addInfoLayer();this.addDeleteControl()}var a=this.getModule("Select");a.deactivate();if(!this.dialogDiv){this.dialogDiv=this.makeDialogContent();this.dialogDiv=this.makeDialog(this.dialogDiv)}this.dialogDiv.dialog("open");this.toggleDelete();return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}this.infocontrol.deactivate();this.deletecontrol.deactivate();var a=this.getModule("Select");a.activate();if(this.dialogDiv&&this.dialogDiv.dialog("isOpen")===true){return this.dialogDiv.dialog("close")}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=this.addToToolsMenu?"addtomenu":"addtoolbutton";sMap.events.triggerEvent(a,this,{index:this.toolbarIndex,label:a=="addtomenu"?this.lang.buttonText:null,hoverText:this.lang.buttonText,iconCSS:"ui-icon-plus",tagID:"button-getfeatureinfo"})},getModule:function(c){var a=sMap.moduleController.modules;for(var b=0;b<a.length;b++){if(a[b].MODULE_NAME==c){return a[b]}}},addControl:function(){var c=this.map.getLayersByName(this.getInfoLayer).length==1?true:false;if(!c){sMap.events.triggerEvent("showlayer",this,{layerName:this.getInfoLayer});sMap.events.triggerEvent("hidelayer",this,{layerName:this.getInfoLayer})}var a=this.map.getLayersByName(this.getInfoLayer),b=this,d=new OpenLayers.Control.WMSGetFeatureInfo({url:a.URL,layers:a,queryVisible:false,infoFormat:"text/plain",eventListeners:{getfeatureinfo:function(e){b.addInfoFeatures(e)}}});this.map.addControl(d);this.infocontrol=d},addInfoLayer:function(){var b=this.map.getLayersByName(this.infoLayerConfig.name).length==1?true:false;if(!b){var a=this.infoLayerConfig.style;this.infoLayer=new OpenLayers.Layer.Vector(this.infoLayerConfig.name,{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style(a["default"]),select:new OpenLayers.Style(a.select),temporary:new OpenLayers.Style(a.temporary)}),projection:new OpenLayers.Projection(this.map.projection),selectable:true,displayInLayerSwitcher:this.infoLayerConfig.displayInLayerSwitcher});sMap.config.layers.overlays.push(this.infoLayerConfig);sMap.events.triggerEvent("addlayer",this,{layer:this.infoLayer});this.infoLayer.setZIndex(this.zIndex);this.showHideInfoLayer()}},showHideInfoLayer:function(){if(this.infoLayer.features.length>0&&!this.infoLayer.visibility){sMap.events.triggerEvent("showlayer",this,{layerName:this.infoLayer.name})}if(this.infoLayer.features.length==0&&this.infoLayer.visibility){sMap.events.triggerEvent("hidelayer",this,{layerName:this.infoLayer.name})}},addInfoFeatures:function(a){var d=this.map.getLonLatFromPixel(a.xy),j="Ingen data",b=Math.pow(10,this.decimals);if(a.text.indexOf("no results")==-1){var l=a.text.split("\n");for(var i=0;i<(l.length);i++){var g=l[i].replace(/^\s*/,"").replace(/\s*$/,"").replace(/ = /,"=").replace(/'/g,"").split("=");if(g[1]==""){g[1]="Unknown"}if(g[0].indexOf(this.attributeName)!=-1){j=Math.round(g[1]*b)/b+" m"}}}var e=new OpenLayers.Geometry.Point(d.lon,d.lat),c={info:j},k=new OpenLayers.Feature.Vector(e,c),h=$("#gfi-addlabels").prop("checked");if(!h){this.clearPoints()}this.infoLayer.addFeatures([k]);this.listPoints();this.showHideInfoLayer()},clearPoints:function(){this.infoLayer.removeAllFeatures();this.listPoints()},addDeleteControl:function(){var a=new OpenLayers.Control.DeleteFeature(this.infoLayer,{title:"Tar bort punkter"});this.map.addControl(a);this.deletecontrol=a},toggleDelete:function(){var a=$("#gfi-digidiv :radio:checked").attr("id");if(a==="gfi-del"){this.infocontrol.deactivate();this.deletecontrol.activate()}else{this.infocontrol.activate();this.deletecontrol.deactivate()}},featuredeleted:function(){this.listPoints()},listPoints:function(){var d,c=$("#gfi-list"),a=Math.pow(10,this.decimals);c.html("");for(var b=0;b<this.infoLayer.features.length;b++){var e=this.infoLayer.features[b];d=Math.round(e.geometry.y*a)/a+","+Math.round(e.geometry.x*a)/a+","+e.attributes.info.replace("m","")+"<BR>";c.append(d)}},makeDialogContent:function(){var c=this,g=$("<div id='GetFeatureInfoDialogDiv' class='getFeatureInfoDiv' />"),i=$("<span>"+this.lang.descriptionText+"</span>");i.css({width:"170px",display:"inline"});g.append(i);var d=$("<div id='gfi-addlabelsdiv'><label for='gfi-addlabels'>"+this.lang.addPointsText+"</label><input id='gfi-addlabels' type='checkbox' name='gfiAdd' checked /></div>");g.append(d);var b="<span id='gfi-digidiv'> <input type='radio' id='gfi-dig' name='radio' checked='checked' value='dig'><label for='gfi-dig'>"+this.lang.addButtonText+"</label><input type='radio' id='gfi-del' name='radio'><label for='gfi-del' value='del'>"+this.lang.deleteButtonText+"</label></span>",h=$(b);h.buttonset();h.change(function(){c.toggleDelete()});g.append(h);var a=$("<button id='gfi-clear'>"+this.lang.clearButtonText+"</button>");a.click(function(){c.clearPoints()});a.button();g.append(a);if(this.listButton){var e=$("<div id='gfi-list' class='gfi-list' />");g.append(e)}return g},makeDialog:function(b){var a=this;b.dialog({autoOpen:false,title:this.lang.headerText,position:this.dialogStartPosition,width:this.width,height:this.height,resizable:true,close:function(){a.deactivate.call(a)},open:null});return b},CLASS_NAME:"sMap.Module.GetFeatureInfo"});sMap.moduleConfig.GetFeatureInfo={activateFromStart:false,toolbarIndex:8,addToToolsMenu:true,dialogStartPosition:[50,200],height:300,width:360,autoclear:true,getInfoLayer:"hojddata",attributeName:"GRAY_INDEX",decimals:1,listButton:true,infoLayerConfig:{name:"theInfoLayer",displayName:"Markhöjder",layerType:"vector",geomType:"point",selectable:true,displayInLayerSwitcher:true,selectAttributes:["${info}"],popup:"<div class='popup-header1'>Markhöjd</div><span id='info-text' class='popup-text1'>${info} RH2000</span>",style:{"default":{pointRadius:4,fillColor:"#000000",fillOpacity:1,graphicName:"cross",strokeWidth:0.3,strokeColor:"#000000",strokeOpacity:1,cursor:"pointer",label:"${info}",fontColor:"#000",fontSize:"14px",fontFamily:"Arial",fontWeight:"normal",labelAlign:"lb",labelXOffset:0,labelYOffset:5},temporary:{pointRadius:6,fillColor:"#ff5b00",fillOpacity:0.3,graphicName:"square",strokeWidth:4,strokeColor:"#ff5b00",strokeOpacity:1,cursor:"pointer"},select:{pointRadius:6,fillColor:"#00FFFF",fillOpacity:0.3,strokeOpacity:1,graphicName:"circle",strokeWidth:4,strokeColor:"#00FFFF",cursor:"pointer"}}},zIndex:696};sMap.Lang.lang.GetFeatureInfo={"sv-SE":{buttonText:"Markhöjder",headerText:"Höjddata RH2000",descriptionText:"Med detta verktyget klickar du kartan och får reda på höjdvärdet i RH2000. NH-data med 2m upplösning.",addPointsText:"Behåll gamla punkter",clearButtonText:"Radera alla",addButtonText:"Lägg till",deleteButtonText:"Radera",listButtonText:"Lista punkterna"},en:{buttonText:"Ground elevation",headerText:"Elevationdata RH2000",descriptionText:"Click in the map and get the elevation in RH2000. NNH-data with 2m resolution",addPointsText:"Keep old points",clearButtonText:"Clear all",addButtonText:"Add point",deleteButtonText:"Delete",listButtonText:"List points"}};sMap.Module.IntroDialog=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],isIe7:($.browser.msie&&parseInt($.browser.version)<8),EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.IntroDialog.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.IntroDialog.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}var a=this.checkboxDontShow&&$.cookie("smap_introdialog_dontshowagain")&&$.cookie("smap_introdialog_dontshowagain")==="1"?true:false;if(a===true){debug.log("User has cookie smap_introdialog_dontshowagain. Not showing intro dialog");return false}this._makeDialog();this.dialog.dialog("open");if(this.checkboxDontShow){this._addCheckbox()}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}this.dialog.dialog("close");return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){},_makeDialog:function(){if(!this.dialog){var a=this;this.dialog=$("<div id='introdialog-dialog'></div>");var b=$.extend(this.defaultDialogOptions,this.dialogOptions);b.close=function(){var d=$("#introdialog-checkboxdiv input").prop("checked");if(d===true){$.cookie("smap_introdialog_dontshowagain","1",{expires:365})}$(this).empty().remove();delete a.dialog;a.dialog=null};b.buttons=[{text:"Stäng",click:function(){$(this).dialog("close")}}];var c={background:this.dialogBGColor};this.dialog.dialog(b);sMap.util.addDialogMinimizeButton(this.dialog);this.dialog.css(c);this.dialog.parent().find(".ui-dialog-buttonpane").css(c);this.dialog.parent().css(c);this.dialog.append(this.contentHtml)}},_addCheckbox:function(){var a=$('<div id="introdialog-checkboxdiv"><input type="checkbox"></input><label>Visa inte information nästa gång</label></div>');this.dialog.parent().find(".ui-dialog-buttonset").prepend(a);if(!this.isIe7){a.find("label").click(function(){var b=$(this).prev();b.prop("checked",!b.prop("checked"))})}},CLASS_NAME:"sMap.Module.IntroDialog"});sMap.moduleConfig.IntroDialog={activateFromStart:true,contentHtml:"<div>Override this parameter in the module config</div>",checkboxDontShow:true,dialogOptions:{},dialogBGColor:"#efa",defaultDialogOptions:{title:"Välkommen",width:"auto",minWidth:370,minHeight:200,height:"auto",modal:false,autoOpen:false,position:"center"}};sMap.Lang.lang.IntroDialog={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.LinkTo=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.LinkTo.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.LinkTo.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},showIt:function(){var a=this;if(!this.dialog){window.open(this.content,"_blank")}else{if(!this.theDialog){var e=this.dialog instanceof Object?this.dialog:{},h=$("<div />");var b={title:"Dialog",width:"auto",autoOpen:true,height:"auto",close:function(){$(this).dialog("destroy");$(this).empty().remove();a.theDialog=null}};if(this.content){var i=this.content;if(typeof i==="string"&&(i.substring(0,7)==="http://"||i.substring(0,8)==="https://")){var g=$('<iframe width="700" height="99%" frameborder="0" marginheight="0" marginwidth="0" top="0px" left="0px"></iframe>');g.attr("src",i);h.append(g)}else{h.append(i)}}$.extend(b,e);this.theDialog=h;h.dialog(b)}else{this.theDialog.dialog("open")}}},hideIt:function(){if(this.theDialog){this.theDialog.dialog("close")}},drawContent:function(){var a=this;var b="addtoolbutton";if(this.addToToolsMenu){b="addtomenu"}sMap.events.triggerEvent(b,this,{index:this.toolbarIndex,label:this.displayName,hoverText:this.hoverText,iconCSS:"ui-icon-extlink",tagID:sMap.util.createUniqueId("linkto-button-"),left:this.left,right:this.right,menuId:this.addToToolsMenu,toggle:false,on:this.showIt})},CLASS_NAME:"sMap.Module.LinkTo"});sMap.moduleConfig.LinkTo={activateFromStart:false};sMap.Lang.lang.LinkTo={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.LayerTree=OpenLayers.Class(sMap.Module,{width:null,showFadedLinks:null,showCheckboxAfterTextIcon:null,enableTooltip:null,folderIcon:null,iconSelectableLayer:null,iconSelectableLayerActive:null,addPrintButton:null,printStyleSheetURL:null,configArr:null,layers:[],categories:{headers:{},layers:{}},EVENT_LISTENERS:["afterapplyingwebparams","layerhidden"],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.LayerTree.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.LayerTree.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a]);this.configArr=sMap.config.layers.overlays},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){$("#mapDiv").addClass("layertree-width")},getNameFromSpanID:function(a){return a.replace("layertree-label-","")},layerhidden:function(b){if(this.treeDiv){var a=this.treeDiv.dynatree("getTree").getNodeByKey(encodeURIComponent(b.layer.name));if(a){a.select(false)}}},getLayerNamesFromNodes:function(b){var a=this;return $.map(b,function(c){return a.getLayerNameFromNode.call(a,c)})},getLayerNameFromNode:function(d){var c=$(d.span);var b=c.find(".dynatree-title").attr("id");var a=this.getNameFromSpanID(b);return a},layerConfigs:{},cacheLayerConfigs:function(){var c,b,a=sMap.config.layers.overlays||[];for(c=0,len=a.length;c<len;c++){b=a[c];this.layerConfigs[b.name]=b}},create:function(){var c=this,e=null;this.cacheLayerConfigs();if(this.right){sMap.events.triggerEvent("addsidedivright",this,{width:this.width+8});e=$("#sideDivRight")}else{sMap.events.triggerEvent("addsidedivleft",this,{width:this.width+8});e=$("#sideDivLeft")}this.sideDiv=e;this.treeDiv=$("<div id='layertree' />");$(this.div).append(this.treeDiv);e.append(this.div);$(this.div).addClass("layertree-maindiv");this.treeDiv.dynatree({title:"Geodata",debugLevel:0,imagePath:sMap.config.proxyHost,autoCollapse:false,activeVisible:true,noLink:false,clickFolderMode:1,fx:{height:"toggle",duration:200},checkbox:true,selectMode:3,onDeactivate:function(g){},onActivate:function(g){},onSelect:function(g,i){var h=[];function k(m){var l=m.getChildren();if(l){$(l).each(function(){var n=this;if(n.data.isFolder===true){k(n)}else{h.push(n)}})}else{h.push(m)}}k(i);var j=c.getLayerNamesFromNodes.call(c,h);c.changeVisibility(j,g)},children:[],onClick:function(l,k){var i=$(k.target).hasClass("dynatree-title"),m=$(k.target).hasClass("dynatree-checkbox");var j=$(l.span).find(".dynatree-checkbox").length>0;var n=l.isSelected();if(i){var h=null;if(j){h=!l.isSelected();l.select(h)}else{h=!l.bExpanded}var g=(!l.bExpanded&&h)||(l.bExpanded&&!h)?true:false;if(g){l.toggleExpand()}}else{if(m){if(n&&l.bExpanded){l.toggleExpand()}else{if(!n&&!l.bExpanded){l.toggleExpand()}}}}},onDblClick:function(h,g){},onCustomRender:function(i){var s=i.data.title,g=i.data.key,x=i.data.tooltip?"title='"+i.data.tooltip+"'":"",q=i.data.isFolder;var w=c.getLayerConfig(g);var p="layertree-texticon";textLink="",layersConf=c.categories.layers,headersConf=c.categories.headers;var v=i.getParent(),n=null;if(v){n=v.data.title}var h=q===true?c.getHeaderCat(s,n):(layersConf&&layersConf[s]?layersConf[s]:{});if(!h instanceof Object){if(c.showFadedLinks){p+=" layertree-notexticon";textLink="<img id='layertree-textlink-"+encodeURIComponent(s)+"' class='"+p+"' src='img/icon_externlank.png'></img>"}}else{if(!h.url){p+=" layertree-notexticon"}textLink="<img id='layertree-textlink-"+encodeURIComponent(s)+"' class='"+p+"' src='img/icon_externlank.png'></img>"}if(c.iconSelectableLayer&&w&&w.selectable&&textLink.length){textLink=$(textLink);textLink.attr("src",c.iconSelectableLayer);textLink=textLink.appendTo($("<div />")).parent().html()}var u="",j="";if(w){var m=(w.style&&w.style["default"]&&w.style["default"].externalGraphic)?w.style["default"].externalGraphic:null;var l=w.legend&&w.legend.hover?w.legend.hover:{};u="<img class='layertree-legendimg' src='"+m+"' customhoverimg="+(l.url||"")+"></img>";j="id='layertree-label-"+w.name+"'"}else{if(c.folderIcon){u="<img src='"+c.folderIcon+"'></img>"}}var p="dynatree-title";if(h&&h.cssClass){p+=(" "+h.cssClass)}if(q===true){p+=" layertree-folder"}var o=x.length?" layertree-tooltip":"";var r="<span "+x+" "+j+" class='"+p+o+"'>"+s+"</span>";var k="";if($(i.span).find(".dynatree-checkbox").length==0&&c.showFadedCheckboxes){k="<span class='dynatree-checkbox-faded'></span>"}return textLink+k+u+r},onExpand:function(g,h){c.modifyNodes()}});this.addItems();var b=this.treeDiv.dynatree("getTree");b.renderInvisibleNodes();for(var d=0,a=this.startChecked.length;d<a;d++){b.selectKey(this.startChecked[d],true)}this.modifyNodes();this.addHeaderDiv()},getLayerConfig:function(a){return this.layerConfigs[a]||null},afterapplyingwebparams:function(a){this.create()},showTooltip:function(a){var b=$(this).attr("title");$(this).validationEngine("showPrompt",b,"load")},hideTooltip:function(a){$(this).validationEngine("hideAll")},changeVisibility:function(e,g){var b=null;for(var c=0,a=e.length;c<a;c++){b=e[c];var d=g===true?"showlayer":"hidelayer";sMap.events.triggerEvent(d,this,{layerName:b})}},addHeaderDiv:function(){var d=$("<div id='layertree-headerdiv' />"),a=null;d.addClass("ui-widget-header");if(this.toggleButton){a=$("<button>"+this.lang.btnSlideLabel+"</button>");d.append(a);a.button();var b=this;a.click(function(g){b.toggleSideDiv.call(b,g);return false})}if(this.turnOffButton){btnTurnOff=$("<button>"+this.lang.btnTurnOffLabel+"</button>");d.append(btnTurnOff);btnTurnOff.button();var b=this;btnTurnOff.click(function(g){sMap.cmd.hidealllayers()})}if(this.addPrintLegendButton){if(this.lbButtonToToolsMenu){sMap.events.triggerEvent("addtomenu",this,{index:this.lbToolbarIndex,iconCSS:"ui-icon-print",menuId:this.addLegendButtonToToolsMenu,label:this.lang.btnPrintLegends,tagID:"button-printlegend",on:this.printLegends})}else{sMap.events.triggerEvent("addtoolbutton",this,{index:this.lbToolbarIndex,iconCSS:"ui-icon-print",label:this.lang.btnPrintLegends,tagID:"button-printlegend",on:this.printLegends})}}if(this.addPrintButton){var c=$("<button id='blixten-btnlayertreeprint'>"+this.lang.btnPrint+"</button>");d.prepend(c);c.button();var b=this;c.click(function(){b.previewPrintLayers()})}if(this.right){d.addClass("headerdiv-right")}else{d.addClass("headerdiv-left")}$(this.div).prepend(d);if(a&&this.startToggled){a.click()}},addToggleButton:function(){var a=this;var b=$("<div id='layertree-expandbutton'>+</div>");$("#mapDiv").append(b);if(this.right){b.addClass("lt-expbutton-right")}else{b.addClass("lt-expbutton-left");$("#mapDiv").css("left","0px")}b.on("click",function(){a.toggleSideDiv();return false})},removeToggleButton:function(){var a=$("#layertree-expandbutton");a.empty().remove()},toggleSideDiv:function(d){var c=this.sideDiv,b=this,a=this.width;if(c.is(":visible")){if(this.right){c.addClass("ltree-hidden");setTimeout(function(){$("#mapDiv").removeClass("layertree-width");b.map.updateSize();c.hide();b.addToggleButton();$(window).resize()},300)}}else{if(this.right){this.removeToggleButton();c.show();setTimeout(function(){c.removeClass("ltree-hidden");$("#mapDiv").addClass("layertree-width");$(window).resize()},1)}}},modifyNodes:function(){var c=this;$(".dynatree-icon").remove();if(!this.showFadedLinks){$(".layertree-notexticon").remove()}$(".layertree-legendimg").click(function(){var i=decodeURIComponent($(this).siblings(".dynatree-title").attr("id").split("-")[2]);var j=c.getLayerConfig(i);var k=c.treeDiv.dynatree("getTree").getNodeByKey(encodeURIComponent(j.name));var h=k.isSelected()?false:true;k.select(h)});if(this.showCheckboxAfterTextIcon){$(".layertree-texticon").each(function(){var h=$(this).prev(".dynatree-checkbox");$(this).insertBefore(h)})}var g=$(".dynatree-checkbox");$(".layertree-texticon").not(".layertree-notexticon").unbind("click").click(function(i,h){c.toggleTextWindow.call(c,i.target)});g.siblings(".dynatree-title").unbind("mouseover").mouseover(function(){$(this).css("text-decoration","underline")}).unbind("mouseout").mouseout(function(){$(this).css("text-decoration","none")});$(".mainheader").parent().parent().css({border:"1px solid #ccc","border-width":"0px 1px 1px 1px",padding:"10px"});$(".mainheader").parent().next().css("margin-top","5px");$(".mainheader:first").parent().parent().css("border-width","1px 1px 1px 1px");$(".subheader").parent().parent().css({border:"1px solid #ccc","border-width":"0px 1px 1px 1px",padding:"10px"});$(".subheader").parent().next().css("margin-top","5px");$(".subheader:first").parent().parent().css("border-width","1px 1px 1px 1px");$(".layertree-texticon").each(function(){if(!$(this).hasClass("layertree-notexticon")){$(this).mouseenter(function(){$(this).addClass("layertree-texticon-hover")});$(this).mouseleave(function(){$(this).removeClass("layertree-texticon-hover")})}});if(this.enableTooltip){var e=this.right===true?42:3;$(".layertree-tooltip").tipTip({defaultPosition:this.right===true?"left":"right",edgeOffset:e})}var d=function(h){$(".layertree-legend-hover").css({left:h.pageX+20,top:h.pageY-50,display:"block"})};var a=function(){if(this.complete){if(!$.browser.msie&&(!this.naturalWidth||this.naturalWidth===0)){return false}var h=$(this).clone();h.hide();h.addClass("layertree-legend-hover");var i=h.attr("customhoverimg");if(i&&i.length>0){h.attr("src",i)}$("body").append(h);$(document).bind("mousemove",d)}};var b=function(){$(document).unbind("mousemove",d);$(".layertree-legend-hover").remove()};$(".layertree-legendimg").mouseenter(a).mouseleave(b);this.applyNodesConfig()},applyNodesConfig:function(){var a=function(i,g){if(i.color){var j=$(".layertree-folder:contains('"+g+"')").parent().parent();j.css({"background-color":i.color});j.find("."+i.cssClass).css("background-color","none !important")}if(i.bordercolor){var j=$(".layertree-folder:contains('"+g+"')").parent().parent();j.css("border-color",i.bordercolor)}};var d=this.categories.headers,b,c;for(b in d){c=d[b];a(c,b);var e=c.subheaders||{};for(b in e){c=e[b];a(c,b)}}},getDialogSize:function(){var b=700,g=500,e=$(window).height()-100,c=$(window).width()-200;var d=e,a=c;if(d>b){d=b}if(a>g){a=g}return{w:a,h:d}},toggleTextWindow:function(j){j=$(j);var l=decodeURIComponent(j.attr("id")).replace("layertree-textlink-","");var h=this.categories.layers||{},c=this.categories.headers||{};var e=c[l]||h[l];if(!e){$.each(c,function(r,s){e=s.subheaders[l]?s.subheaders[l]:e})}var k=e.url;var o="layertree-textwindow-"+$.base64.encode(l).replace(/=/gi,"").replace(/\+/gi,"").replace(/\-/gi,"");var q=$("#"+o);if(q.length){q.dialog("close");return}var i=$("<div class='layertree-textwindow' id='"+o+"' />");if(this.iconSelectableLayerActive&&this.iconSelectableLayer&&j.attr("src")===this.iconSelectableLayer){j.attr("src",this.iconSelectableLayerActive)}else{j.attr("src","img/icon_externlank_active.png")}var p=this.getDialogSize();var g=$(".layertree-textwindow").length;var b=parseInt($(window).width()/2-p.w/2);var a=this.dialogTitlePrefix?this.lang.dialogTitlePrefix+l:l;var n=this;i.dialog({title:a,position:[b+g*(-40),50+g*30],width:p.w,height:p.h,modal:false,autoOpen:false,close:function(){$(this).dialog("destroy");$(this).empty().remove();if(n.iconSelectableLayerActive&&n.iconSelectableLayer&&j.attr("src")===n.iconSelectableLayerActive){j.attr("src",n.iconSelectableLayer)}else{j.attr("src","img/icon_externlank.png")}},resizeStart:function(){$(this).children().hide();$(this).parent().css({filter:"alpha(opacity=70)",opacity:"0.7"})},resizeStop:function(s,r){$(this).parent().css({filter:"alpha(opacity=100)",opacity:"1"});$(this).children().show()}});sMap.util.addDialogMinimizeButton(i);if(this.addPrintLegendButton){var m=$('<button class="ltree-btn-miniprint">Skriv ut</button>');i.prev().find(".ui-dialog-title").after(m);i.prev().css({"white-space":"nowrap",padding:"0 1em"}).find(".ui-dialog-title").css({"margin-top":"7px"})}if(this.addPrintLegendButton){m.button({icons:{primary:"ui-icon-print"}});m.click(function(){var s=$(this).parent().next().find("iframe");var t=s.attr("src");this.miniPrintWin=window.open("","","left=400,top=200,width=600,height=600");var r=this;var u=$("<div />");u.load(config.proxyHost+t,function(){if($.browser.msie&&parseInt($.browser.version)<=9){r.miniPrintWin.document.write($(this).html())}else{$(this).appendTo($(r.miniPrintWin.document.body));r.miniPrintWin.print();r.miniPrintWin.close()}})})}i.hide();i.empty();if(k.substring(0,4)=="http"){var d=$('<iframe width="470" height="290" frameborder="0" scrolling="auto" marginheight="0" marginwidth="0"></iframe>');d.attr("src",k);i.append(d);if(navigator.userAgent.match(/(iPod|iPhone|iPad)/)){i.css({overflow:"auto","-webkit-overflow-scrolling":"touch"}).addClass("overthrow");d.attr("height","5000")}}else{i.html(k)}i.dialog("open")},addItems:function(){var d=this.configArr;var a={children:[]},r=null;this.startChecked=[];for(var h=0,l=d.length;h<l;h++){r=d[h];if(!r.displayInLayerSwitcher){continue}var m=a;var p=r.category||[];for(var e=0,o=p.length;e<o;e++){var n=p[e];var b=this.getFolder(m.children,n);if(b){m=b;continue}else{var k=this.getHeaderCat(n,m.title||null);var c={title:n,isFolder:true,children:[],expand:k.expand||false,color:k.color||null,hideCheckbox:k.hideCheckbox||false,tooltip:k.tooltip||null,icon:null};m.children.push(c);m=c}}var q={title:r.displayName,key:encodeURIComponent(r.name),hideCheckbox:r.hideCheckbox||false,tooltip:r.tooltip||null};if(r&&r.startVisible){this.startChecked.push(r.name)}if(!this.categories.layers){this.categories.layers={}}if(r.dialogContent){this.categories.layers[r.displayName]=this.categories.layers[r.displayName]||{};$.extend(this.categories.layers[r.displayName],{url:r.dialogContent,hideCheckbox:r.hideCheckbox||false})}m.children.push(q)}var g=this.treeDiv.dynatree("getRoot");g.addChild(a.children)},getFolder:function(b,c){for(var d=0,a=b.length;d<a;d++){var e=b[d].title;if(e==c){return b[d]}}return null},getHeaderCat:function(a,h){h=h||a;var d=null,c,g={},e=this.categories.headers;var b=function(j){g={};for(c in j){g=j[c];if(c===h){if(a===h){return g}else{if(g.subheaders&&g.subheaders[a] instanceof Object){g=g.subheaders[a];return g}}}}var i;for(c in j){g=j[c];var k=g instanceof Object?g.subheaders:null;if(!k||$.isEmptyObject(k)){continue}i=b(k);if(i){return i}else{continue}}return null};return b(e)||{}},printLegends:function(){var q=this;var p,h=sMap.config.layers.overlays,a,r,l=0,n=false,g=$("<div />"),o=$("<table />"),e,b='<style type="text/css" media="print">#btn-printwin {display:none;}</style>',k=function(){l-=1;if(n&&l<=0&&q.printLegendWin){}};g.append(b);for(var d=0,j=h.length;d<j;d++){p=h[d];e=this.map.getLayersByName(p.name).length?this.map.getLayersByName(p.name)[0].getVisibility():false;if(!e){continue}a=p.style&&p.style["default"].externalGraphic?p.style["default"].externalGraphic:null;if(p.legend&&p.legend.hover&&p.legend.hover.url){a=p.legend.hover.url}r=$("<tr><td></td><td>"+p.displayName+"</td></tr>");if(a){var c="<img src='"+a+"'></img>";r.find("td:first").append(c);l+=1}o.append(r);r.find("img").css({height:"45px"}).on("load",k);r.css({"font-size":"14px","font-weight":"bold"});r.find("td").css({border:"1px solid #aaa",padding:"2px 10px"})}if(o.children().length===0){alert("Inga lager tända");return false}g.append("<h1>"+this.lang.legendHeader+(sMap.config.mapName?sMap.config.mapName[sMap.langCode]:"...mapName missing in config")+"</h1>");g.append(o);n=true;if(this.printLegendWin){this.printLegendWin.focus();this.printLegendWin.close();this.printLegendWin=null}this.printLegendWin=window.open("","","left=400,top=200,width=600,height=400");this.winIsOpen=true;var m='<button id="btn-printwin" media="screen" style="padding:10px 20px;margin:20px;cursor:pointer;" >Skriv ut</button>';m.attr("onclick","print();");g.prepend(m);this.printLegendWin.document.write(g.html())},previewPrintLayers:function(){var p=this;var s=this.treeDiv.dynatree("getTree");var b=s.getSelectedNodes(),d=[];for(var e=0,h=b.length;e<h;e++){var c=b[e];var l=$(c.span);if(l.find(".layertree-notexticon").length===0){var k=l.find(".dynatree-title").attr("id");var a=p.getNameFromSpanID(k);var o=p.getLayerConfig(a);d.push(o)}}if(!this.printDialog){this.printDialog=$("<div id='layertree-dialogprintpreview'><div id='layertree-printpreviewinfo'>"+this.lang.printPreviewInfo+"</div></div>");this.printDialog.dialog({title:this.lang.btnPrint,position:"center",width:275,autoOpen:false,height:400,resizable:false,modal:true,close:function(){$(this).find("fieldset").find("legend").siblings().remove()},buttons:[{text:this.lang.btnPrint,click:function(){p.printLayers();$(this).dialog("close")}}]});var m=$("<fieldset id='layertree-printfieldset'><legend>"+this.lang.printLegendText+"</legend></fieldset>");this.printDialog.append(m)}if(this.printDialog.dialog("isOpen")){this.printDialog.dialog("close")}this.printDialog.dialog("open");var o=null,r=this.printDialog.find("fieldset");for(var e=0,h=d.length;e<h;e++){o=d[e];var q=$("<div class='layertree-printrow' />"),g=$("<input type='checkbox' checked='checked' />"),j=$("<label>"+o.displayName+"</label>");r.append(q);q.append(g).append(j);j.click(function(){var i=$(this).prev();i.prop("checked",!i.prop("checked"))});q.data("url",o.dialogContent)}},printLayers:function(){var b=this;sMap.cmd.loading(true,{text:this.lang.textLoadingPrint});var e=$(".layertree-printrow:has(input:checked)");var d=e.length;var a=$("<div />");var c=sMap.config.proxyHost||"";e.each(function(){var h=$(this).data("url");var g=$("<div />");a.append(g);g.css("border","1px solid #ccc");g.load(c+h,function(j,i,k){d-=1;if(d<=0){b.onPrintLoadDone(a)}})})},onPrintLoadDone:function(a){sMap.cmd.loading(false);var b=window.open("","layertreeprintwin","height=500,width=400,location=no,menubar=no,status=no,toolbar=no");b.document.write('<link rel="stylesheet" type="text/css" href="'+this.printStyleSheetURL+'"></link>');b.document.write(a.html());sMap.db.layertreeprintwin=b;setTimeout("var win = sMap.db.layertreeprintwin;win.focus();win.print();win.close();sMap.db.layertreeprintwin=null;win=null;",100)},CLASS_NAME:"sMap.Module.LayerTree"});sMap.moduleConfig.LayerTree={activateFromStart:true,width:360,right:true,toggleButton:true,toggleSpeed:350,startToggled:false,turnOffButton:true,iconSelectableLayer:"img/icon_externlank_info.png",iconSelectableLayerActive:"img/icon_externlank_active_info.png",showFadedLinks:false,showFadedCheckboxes:false,showCheckboxAfterTextIcon:true,enableTooltip:true,folderIcon:"img/folder_page.gif",dialogTitlePrefix:false,addPrintButton:false,printStyleSheetURL:"http://sbkspace.malmo.se/op/CSS/StyleSheet.css",addPrintLegendButton:true,lbButtonToToolsMenu:true,lbToolbarIndex:1};sMap.Lang.lang.LayerTree={"sv-SE":{header:"",expandButton:"Datalager",btnSlideLabel:"Göm",btnTurnOffLabel:"Släck alla lager",btnPrint:"Skriv ut",btnPrintLegends:"Skriv ut teckenförklaring",printLegendText:"Lager att skriva ut",printPreviewInfo:'Kryssa i de lager som du vill skriva ut och tryck sedan på "Skriv ut".',textLoadingPrint:"Förbereder utskrift...",dialogTitlePrefix:"Metadata för ",legendHeader:"Teckenförklaring för "},en:{header:"",expandButton:"Layers",btnSlideLabel:"Hide",btnTurnOffLabel:"Hide all layers",btnPrint:"Print",btnPrintLegends:"Print legend",printLegendText:"Layers to print",printPreviewInfo:'Check the layers you want to print and then press "Print".',textLoadingPrint:"Preparing for printing...",dialogTitlePrefix:"Metadata for ",legendHeader:"Legend for "}};sMap.Module.Legend=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Legend.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Legend.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){this._container=$('<div class="legend-container"><span class="close">&times;</span><h1>Teckenförklaring</h1></div>');this._container.on("click",function(){return false});this._container.find(".close").on("click",function(){$(this).parent().hide();return false});this._container.hide();$("#mapDiv").append(this._container);this._bindEvents()},_addLegendPic:function(c,b){var a=$("<div><label>"+c+'</label><img src="'+b+'"></img></div>');this._container.find("h1").after(a)},_removeLegendPic:function(a){this._container.find('img[src="'+a+'"]').parent().remove()},_bindEvents:function(){var a=function(d){var c=d.layer;if(c&&c.name){var b=sMap.cmd.getLayerConfig(c.name);if(!b.legend||!b.legend.hover||!b.legend.hover.url){return}var g=b.legend.hover.url;if(c.getVisibility()===true){debug.log("show layer");this._addLegendPic(b.displayName,g)}else{debug.log("hide layer");this._removeLegendPic(g)}}if(this._container.find("img").length===0){this._container.hide()}else{this._container.show()}};this.map.events.register("addlayer",this,a);this.map.events.register("changelayer",this,a);this.map.events.register("removelayer",this,a)},CLASS_NAME:"sMap.Module.Legend"});sMap.moduleConfig.Legend={activateFromStart:false};sMap.Lang.lang.Legend={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.Loading=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["loading","loadingdone","layersstartedloading","layersloaded"],EVENT_TRIGGERS:[],showBackground:false,layersstartedloading:function(a){if(this.container.is(":visible")!==true){this.loading({text:this.lang.loadingLayers,many:false,bg:false})}},layersloaded:function(){this.loadingdone({text:this.lang.loadingLayers})},animSrc:"img/ajax-loader-circle.gif",showBackground:null,initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Loading.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Loading.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=$("<div id='loading-spinner-div' />");this.container=a;if(this.showBackground){var b=$("<div id='loading-background' />");$("#mapDiv").append(b);b.hide();this.background=b}var d=$("<img src='"+this.animSrc+"'></img>");a.append(d);var c=$("<div id='loading-spinner-text' />");this.textContainer=c;a.append(c);$("#mapDiv").append(a);$("#loading-spinner-div").position({my:"center",at:"center",of:"#mapDiv"});$(window).resize(function(){$("#loading-spinner-div").position({my:"center",at:"center",of:"#mapDiv"})});a.hide()},show:function(){if(this.background){if(this.showBackground===true){this.background.show()}else{this.background.hide()}}this.container.show();$("#loading-spinner-div").position({my:"center",at:"center",of:"#mapDiv"})},hide:function(){if(this.background){this.background.hide()}this.container.hide()},loading:function(a){this.showBackground=a.bg||false;this.addText(a.text,a.many);this.checkStatus()},loadingdone:function(a){this.removeText(a.text||null);this.checkStatus()},addText:function(c,d){var b=this.textContainer.children(":contains('"+c+"')");var a=$("<div class='loading-texttag'>"+c+"</div>");if(b.length==0||d){this.textContainer.append(a)}},removeText:function(b){if(b){var a=this.textContainer.children(":contains('"+b+"')");a.first().remove()}else{this.textContainer.empty()}},checkStatus:function(){var a=this.textContainer.children().length;if(a>0){this.show()}else{this.hide()}},CLASS_NAME:"sMap.Module.Loading"});sMap.moduleConfig.Loading={activateFromStart:false,onlyIcon:true,showBackground:false};sMap.Lang.lang.Loading={"sv-SE":{labelText:"Tryck här",loadingLayers:"Laddar lager..."},en:{labelText:"Press here",loadingLayers:"Loading layers..."}};sMap.Module.MalmoHeader=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.MalmoHeader.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.MalmoHeader.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a='<!--[if IE]><meta content="IE=edge" http-equiv="X-UA-Compatible" /><![endif]-->    <!--[if lte IE 8]><script src="//assets.malmo.se/external/v4/html5shiv-printshiv.js" type="text/javascript"><\/script><![endif]-->    <link href="//assets.malmo.se/external/v4/masthead_standalone.css" media="all" rel="stylesheet" type="text/css"/>    <!--[if lte IE 8]><link href="//assets.malmo.se/external/v4/legacy/ie8.css" media="all" rel="stylesheet" type="text/css"/><![endif]-->    <noscript><link href="//assets.malmo.se/external/v4/icons.fallback.css" rel="stylesheet"></noscript>    <link rel="icon" type="image/x-icon" href="//assets.malmo.se/external/v4/favicon.ico" />';$("head").prepend(a);$("body").addClass("mf-v4 no-footer");$("body").addClass("test");$("body").append('<script src="//assets.malmo.se/external/v4/masthead_standalone_without_jquery.js"><\/script>');$("#smapDiv").css({"margin-top":"3.7em",height:"calc(100% - 3.7em)"})},CLASS_NAME:"sMap.Module.MalmoHeader"});sMap.moduleConfig.MalmoHeader={activateFromStart:false};sMap.Lang.lang.MalmoHeader={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.MeasureDialog=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["beforeprint"],EVENT_TRIGGERS:[],DEACTIVATE_MODULES:["sMap.Module.Blixten"],dialogStartPosition:null,controls:{},buttons:{},panel:null,beforeprint:function(){this.deactivate()},initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.MeasureDialog.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.MeasureDialog.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}for(var b=0,a=this.DEACTIVATE_MODULES.length;b<a;b++){var c=this.map.getControlsByClass(this.DEACTIVATE_MODULES[b]);if(c.length){c[0].deactivate()}}sMap.events.triggerEvent("deactivate",this,{module:"sMap.Module.Select"});this.panel=this.makeControls();this.dialogDiv=this.makeDialogContent();this.dialogDiv=this.makeDialog(this.dialogDiv);this.addButtonHoverEffect();if(this.showMeasureAtCursor===true){this.bindMouseMove.call(this)}this.eggifyIt();this.dialogDiv.dialog("open");return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(!this.active){return false}if(this.dialogDiv&&this.dialogDiv.dialog("isOpen")===true){return this.dialogDiv.dialog("close")}this.unEggifyIt();this.deactivateButtonsAndControls();$(this.dialogDiv).empty().remove();$("#measure-cursorDiv").hide();this.unBindMouseMove.call(this);sMap.events.triggerEvent("activate",this,{module:"sMap.Module.Select"});return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){if(this.addToToolsMenu){sMap.events.triggerEvent("addtomenu",this,{index:this.toolbarIndex,iconCSS:"btnmeasure",menuId:this.addToToolsMenu,label:this.lang.buttonText,tagID:"button-measure"})}else{sMap.events.triggerEvent("addtoolbutton",this,{index:this.toolbarIndex,iconCSS:"btnmeasure",label:this.lang.buttonText,tagID:"button-measure"})}},bindMouseMove:function(){this.cursorDiv=$("<div id='measure-cursorDiv' />");$("#smapDiv").append(this.cursorDiv);this.cursorDiv.hide();var b=sMap.util.getMapPosition();this.mapX=b.x;this.mapY=b.y;var a=this;this.onMouseMove=function(c){a.cursorDiv.css({left:c.pageX-a.mapX+14+"px",top:c.pageY-a.mapY+20+"px"})};$(this.map.viewPortDiv).mousemove(this.onMouseMove)},unBindMouseMove:function(){$(this.map.viewPortDiv).unbind("mousemove",this.onMouseMove)},toggleDialog:function(){if(this.active!==true){this.activate()}var a=this.dialogDiv.dialog("isOpen");if(a){this.dialogDiv.dialog("close")}else{this.dialogDiv.dialog("open")}},deactivateButtonsAndControls:function(b){var a=this,c=null;if(b){c=b.siblings()}else{c=this.panel.children()}c.each(function(){$(this).data("active",false);var d=$(this).data("type");a.controls[d].deactivate();a.renderButton($(this).find("img"),false)})},deactivateResultDiv:function(){this.resultDiv.html("");this.resultDiv.css(this.resultDivUnactiveCSS);this.toggleCursorDiv("hide")},getControlType:function(){var g={point:0,path:1,polygon:2};var d=null;for(var a in this.controls){var e=this.controls[a];if(e.active===true){var b=e.handler.CLASS_NAME.split(".")[2].toLowerCase();d=g[b];break}}return d},reportMeasure:function(g){var a=this.getControlType(),h=g.geometry;var c=g.measure,b=g.units;if(a==0){this.coordinates={x:h.x,y:h.y};var d=sMap.util.projectPoint(config.projection,this.currentProjection,h.x,h.y);var i=this.projections[this.currentProjection].decimals;this.displayCoordinates(d.x.toFixed(i),d.y.toFixed(i));return}else{if(b=="m"){c=c.toFixed(this.decimals_m)}else{c=c.toFixed(this.decimals_km)}}if(g.type==="measure"){var d=$("#measure-resultDiv input").offset();this.cursorDiv.css("z-index","5000");this.cursorDiv.animate({left:d.left+"px",top:(d.top)+"px"},500,function(){$(this).fadeOut(300,function(){$(this).css("z-index","1000")})})}else{this.toggleCursorDiv("show")}this.displayMeasure(a,b,c);this.resultDiv.css(this.resultDivActiveCSS)},toggleCursorDiv:function(a){if(this.showMeasureAtCursor===true){switch(a){case ("show"):this.cursorDiv.show();break;case ("hide"):this.cursorDiv.hide();break;default:break}}},displayMeasure:function(a,b,h){var d=$("<div />"),i=$("<div />");lblTag=$("<span />"),resultTag=$("<input readonly='readonly' type='text' />");if(a==0){if(this.coordsSearch==true){resultTag.removeProp("readonly")}var g=lblTag.clone(),e=resultTag.clone(),c=i.clone();lblTag.text("Latitud:");g.text("Longitud:");e.val("");b="";h="";c.append(g);c.append(e);c.append("<br/>");d.append(c)}else{if(a==1){lblTag.text(this.lang.labelLenght)}else{if(a==2){lblTag.text(this.lang.labelArea);b+="2"}}}resultTag.val(h+" "+b);i.append(lblTag);i.append(resultTag);d.append(i);this.resultDiv.html(d);if(this.showMeasureAtCursor===true){this.displayHtmlAtCursor(d)}},displayHtmlAtCursor:function(b){var a=b.clone();$(a).find("input").each(function(){var c=$("<span>"+$(this).val()+"</span>");$(this).replaceWith(c)});$(a).children().each(function(){$(this).removeClass()});$(this.cursorDiv).html(a)},displayCoordinates:function(h,g){var a=this.projections[this.currentProjection];var c=$("<div />"),k=$("<div />"),i=$("<div />"),j=$("<span>"+a.easting+"</span>"),d=$("<span>"+a.northing+"</span>"),e=$("<input readonly='readonly' type='text' value='"+h+"'></input>"),b=$("<input readonly='readonly' type='text' value='"+g+"'></input>");if(this.coordsSearch==true){e.removeProp("readonly");b.removeProp("readonly")}k.append(j);k.append(e);i.append(d);i.append(b);c.append(k);c.append(i);this.resultDiv.html(c)},projectCoordinate:function(b,a,e,d){var c=sMap.util.projectPoint(b,a,e,d);var g=this.projections[a].decimals;this.displayCoordinates(c.x.toFixed(g),c.y.toFixed(g))},coordsError:function(e){var c=this,b=null;if(e=="NaN"){b=c.lang.coordsNaN}else{b=c.lang.invalidCoords}var a=$("<div id='measure-errortext'>"+b+"</div>"),d=$("<div id='measure-errordiv' />"),g=$("<div id='measure-errorbtnclose'>"+c.lang.btnCloseTxt+"</div>");g.click(function(){$("#measure-resultDiv input").each(function(){$(this).val("")});d.remove()});d.append(a).append(g);$(this.map.viewPortDiv).append(d)},coordsFromUser:function(){var j=this,h=parseFloat($("#measure-resultDiv input").eq(0).val().replace(",",".")),d=parseFloat($("#measure-resultDiv input").eq(1).val().replace(",","."));if(isNaN(h)||isNaN(d)){j.coordsError("NaN");return}var i="EPSG:"+$("#measure-projectSelectTag").find("option:selected").prop("id").split("-")[1];var b=sMap.util.projectPoint(i,config.projection,h,d);var c=sMap.config.maxExtent;if(b.x>c.e||b.x<c.w||b.y>c.n||b.y<c.s){j.coordsError();return}var e=this.controls.point.handler;var g=new OpenLayers.LonLat(b.x,b.y);if(e.layer.features.length>1){e.layer.features[0].move(g)}else{var a=this.map.getPixelFromLonLat(g);e.createFeature(a);e.layer.features[0].move(g)}this.coordinates={x:b.x,y:b.y}},toggleProjectionButtons:function(c){var n=this;var g=this.btnUserCoords||null;if(c===true){if(g!=null&&g.not(":visible")){g.show()}if(!$("#measure-projectSelectTag").length){var k=$("<p id='measure-projHeader' />");k.text(this.lang.labelCoord);$(this.dialogDiv).append(k);if(n.coordsSearch==true){var i=$("<button id='measure-usercoords' title='"+n.lang.btnSearchTitle+"'>"+n.lang.btnSearch+"</button>");this.btnUserCoords=i;i.click(function(o){n.coordsFromUser()});$(this.dialogDiv).append(i);i.parent().keypress(function(o){if(o.keyCode==13){i.click()}})}var h=$("<select id='measure-projectSelectTag' />");var a=this.projections;var m=[];for(var l in a){var b=a[l].name;var d=l.split(":")[1];var e=this.map.projection==l?"selected":"";var j=$("<option id='measure-"+d+"' "+e+" >"+b+"</option>");h.append(j)}h.change(function(p){var o="EPSG:"+$(this).find("option:selected").prop("id").split("-")[1];n.currentProjection=o;if(n.coordinates){n.projectCoordinate(config.projection,o,n.coordinates.x,n.coordinates.y)}});$(this.dialogDiv).append(h)}else{$("#measure-projectSelectTag").show();$("#measure-projHeader").show()}this.currentProjection="EPSG:"+$("#measure-projectSelectTag").find(":selected").prop("id").split("-")[1];$(this.dialogDiv).dialog("option","height",n.height+75)}else{if(g!=null&&g.is(":visible")){g.hide()}$("#measure-projectSelectTag").hide();$("#measure-projHeader").hide();$(this.dialogDiv).dialog("option","height",n.height)}},hackHandlerStyle:function(control){if(this.style){var tempStyle=new OpenLayers.Style(this.style);var handler=eval(control.handler.CLASS_NAME);control.handler=new handler(control,control.callbacks,OpenLayers.Util.extend({layerOptions:{styleMap:tempStyle}},control.handlerOptions))}},makeControls:function(){var b=$("<div id='measure-panel' />");var g=new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{persist:true,immediate:true});var l=new OpenLayers.Control.Measure(OpenLayers.Handler.Polygon,{persist:true,immediate:true});this.controls.line=g;this.controls.polygon=l;this.map.addControl(g);this.map.addControl(l);var i=this.reportMeasure;var m=this;this.srcIconPointOff="img/editTools/point_off.png";this.srcIconLineOff="img/editTools/line_off.png";this.srcIconPolygonOff="img/editTools/polygon_off.png";this.srcIconPointOn="img/editTools/point_on.png";this.srcIconLineOn="img/editTools/line_on.png";this.srcIconPolygonOn="img/editTools/polygon_on.png";var n=$("<div class='measure-button' title='"+this.lang.titleLine+"'><img src='"+this.srcIconLineOff+"'></img></div>"),h=$("<div class='measure-button' title='"+this.lang.titleArea+"'><img src='"+this.srcIconPolygonOff+"'></img></div>");n.data("type","line");h.data("type","polygon");b.append(n).append(h);if(this.point===true){var o=new OpenLayers.Control.Measure(OpenLayers.Handler.Point,{persist:true});this.hackHandlerStyle(o);var d=$("<div class='measure-button' title='"+this.lang.titlePoint+"'><img src='"+this.srcIconPointOff+"'></img></div>");d.data("type","point");b.prepend(d);this.controls.point=o;this.map.addControl(o)}var a=function(){if(j.handler.CLASS_NAME=="OpenLayers.Handler.Point"){var c=m.controls.point.active;m.toggleProjectionButtons(c)}};for(var k in this.controls){var j=this.controls[k];j.handler.style=this.style?this.style:j.handler.style;j.events.register("measure",this,i);j.events.register("measurepartial",this,i);j.events.register("activate",j,function(c){a()});j.events.register("deactivate",j,function(c){a();m.deactivateResultDiv()})}this.hackHandlerStyle(g);this.hackHandlerStyle(l);var e=function(){var c=$(this).data("type");if(!$(this).data("active")){m.deactivateButtonsAndControls($(this));$(this).data("active",true);m.renderButton($(this).find("img"),true);m.controls[c].activate()}else{$(this).data("active",false);m.renderButton($(this).find("img"),false);m.controls[c].deactivate()}};b.find("img").each(function(){$(this).mouseenter(function(){m.renderButton($(this),true)});$(this).mouseleave(function(){if(!$(this).parent().data("active")){m.renderButton($(this),false)}})});b.find("div").each(function(){$(this).click(e)});return b},renderButton:function(a,c){c=c||false;var b="_off",d="_on";var e=a.attr("src");if(c!==true){b="_on";d="_off"}a.attr("src",e.replace(b,d))},makeDialogContent:function(){var a=$("<div id='measureDialogDiv' />");var b=$("<div id='measure-helpDiv' />");a.append(b);$(b).text(this.lang.helpText);this.resultDiv=$("<div id='measure-resultDiv' />");a.append(this.panel);a.append(this.resultDiv);this.resultDiv.css(this.resultDivUnactiveCSS);this.resultDiv.html("");return a},makeDialog:function(b){var a=this;sMap.util.createDialog(b,{titleText:this.lang.headerText,position:this.dialogStartPosition,width:this.width,height:this.height,onClose:function(){a.events.triggerEvent("dialogclosed",{control:a});a.deactivate.call(a)},onOpen:null});return b},addButtonHoverEffect:function(){var a=this.map;$(".olControlPanelMeasure").children().each(function(){$(this).data("allowHover",true);$(this).hover(function(h){var b=$(this).prop("class"),d=b.split("Item"),g=($(this).data("allowHover")===true);if((d[1])=="Inactive"&&g){var c=d[0]+"ItemActive";$(this).removeClass(b);$(this).addClass(c)}},function(h){var b=$(this).prop("class"),d=b.split("Item"),g=($(this).data("allowHover")===true);if(g===true){var c=d[0]+"ItemInactive";$(this).removeClass(b);$(this).addClass(c)}else{if(d[1]=="Inactive"){$(this).data("allowHover",true)}}});$(this).click(function(d){$(".olControlPanelMeasure").children().each(function(){$(this).data("allowHover",true)});var b=$(this).prop("class");var c=b.split("Item");if(c[1]=="Active"){$(this).data("allowHover",false)}})})},unEggifyIt:function(){$("#toolbar-maindiv").off("dblclick")},eggifyIt:function(){$("#toolbar-maindiv").off("dblclick").on("dblclick",function(b){if(b.altKey){var a=$("<img src='img/apic.png' width='300' height='300'></img>");a.css({position:"absolute","z-index":"2000",right:"-300px",top:"100px",opacity:"0"});$("#mapDiv").append(a);a.animate({right:"1px",opacity:"1"},500,function(){$(this).animate({right:"-300px",opacity:"0"},500,function(){$(this).empty().remove()})})}})},CLASS_NAME:"sMap.Module.MeasureDialog"});sMap.moduleConfig.MeasureDialog={activateFromStart:false,toolbarIndex:null,addToToolsMenu:false,point:true,coordsSearch:true,dialogStartPosition:[240,100],width:200+10,height:190,showMeasureAtCursor:true,style:{pointRadius:7,strokeWidth:2,strokeColor:"#00f",strokeOpacity:1,fillColor:"#00f",fillOpacity:0.5},decimals_m:0,decimals_km:3,resultDivActiveCSS:{background:"#dddddd"},resultDivUnactiveCSS:{background:"none"},projections:{"EPSG:4326":{name:"WGS84",decimals:5,easting:"Longitud:",northing:"Latitud:"},"EPSG:3006":{name:"Sweref99 TM",decimals:1,easting:"Easting:",northing:"Northing:"},"EPSG:3008":{name:"Sweref99 1330",decimals:1,easting:"Easting:",northing:"Northing:"},"EPSG:3021":{name:"RT90 2.5 V",decimals:0,easting:"Easting:",northing:"Northing:"},"EPSG:900913":{name:"Google",decimals:0,easting:"Easting:",northing:"Northing:"}}};sMap.Lang.lang.MeasureDialog={"sv-SE":{buttonText:"Mät",buttonHoverText:"Hämta koordinater, mät sträcka eller yta",headerText:"Mätverktyg",helpText:"Välj mätverktyg nedan och klicka i kartan. För linje och yta - avsluta med dubbelklick.",titleLine:"Mät sträcka",titleArea:"Mät yta",titlePoint:"Visa koordinater för punkt",labelLenght:"Längd: ",labelArea:"Yta: ",labelCoord:"Koordinatsystem",btnSearch:"Sök",btnSearchTitle:"Sök med koordinater genom att skriva in värden i fälten nedan",coordsNaN:"Enbart siffror är giltiga i fälten för koordinater.",invalidCoords:"Koordinaterna ligger inte i kartans utsträckning för valt referenssystem.",btnCloseTxt:"Stäng"},en:{buttonText:"Measure",buttonHoverText:"Get coordinates from point, measure a path or area",headerText:"Measure tool",helpText:"Choose measure tool and click in the map. For lines and areas - finish with doubleclick.",titleLine:"Measure line",titleArea:"Measure area",titlePoint:"Show coordiantes for point",labelLenght:"Length: ",labelArea:"Area: ",labelCoord:"Coordinate system",btnSearch:"Search",btnSearchTitle:"Search by coordinates by typing in values in the fields below",coordsNaN:"Only numbers are valid in the fields for coordinates.",invalidCoords:"The coordinates are out of bounds for the chosen referencesystem.",btnCloseTxt:"Close"}};sMap.Module.MousePos=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["addscaleandmousepos"],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.MousePos.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.MousePos.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=this;sMap.events.triggerEvent("addscaleandmousepos",a,{showScale:a.showScale,showMousePos:a.showMousePos,mouseChoices:a.mouseChoices})},addscaleandmousepos:function(g){var m=this,a=g.showScale===true?true:false,k=g.showMousePos===false?false:true,h=g.mouseChoices,c=$("<div id='mousepos-projdiv' />"),j=$("<span id='mousepos-coords' />"),d=$("<select id='projections' />");c.addClass("ui-widget-content");if(a==true){var l=new OpenLayers.Control.Scale();m.map.addControl(l)}if(k==true){var b=0;$.each(h,function(i,e){var n=$("<option id='proj"+b+"' value='"+i+"' >"+e.displayName+"</option>");d.append(n);b++});d.addClass("projection-list");c.append(d).append(j);$(this.div).addClass("mousepos-maindiv");$(this.div).append(c);if(this.map.getControlsByClass("OpenLayers.Control.ScaleBar").length){$(this.div).css({margin:"35px"})}$(".projection-list").change(function(){var e=$(this).val();m.changeProj(e)});$(".projection-list").val(this.map.projection).trigger("change")}},changeProj:function(d){var a=this;var c=a.map.getControlsByClass("OpenLayers.Control.MousePosition")[0];if(c&&c.length){a.map.removeControl(c)}var b=new OpenLayers.Projection(d);var e=document.getElementById("mousepos-coords");a.map.addControl(new OpenLayers.Control.MousePosition({element:e,numDigits:a.mouseChoices[b].decimals,displayProjection:b}))},CLASS_NAME:"sMap.Module.MousePos"});sMap.moduleConfig.MousePos={activateFromStart:true,containerDiv:"#mapDiv",showMousePos:true,mouseChoices:{"EPSG:3006":{displayName:"Sweref99 TM",decimals:0},"EPSG:3008":{displayName:"Sweref99 1330",decimals:0},"EPSG:4326":{displayName:"WGS84",decimals:4},"EPSG:3021":{displayName:"RT90 2.5 V",decimals:0},"EPSG:900913":{displayName:"Google",decimals:0}}};sMap.Lang.lang.MousePos={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.Opacity=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["layervisible","layerhidden","setbaselayer","delopacityrow","addopacityrow","creatingwebparams","afterapplyingwebparams"],EVENT_TRIGGERS:[],allNamesInGUI:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Opacity.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Opacity.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){var a=this;if(a.active===true){return false}this.activeBaseLayer=a.map.baseLayer.name;a.opacityDiv=a.createContent(a.opacityDiv);a.opacityDiv=a.createopacitychanger(a.opacityDiv);a.opacityDiv.dialog("open");return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){var c=this;if(!c.active){return false}if(this.savePrefChecked&&$("#opacity-prefs").is(":checked")==false){var b=c.allNamesInGUI;$.each(b,function(){var a=c.map.getLayersByName(this)[0];a.setOpacity(1)})}if(c.opacityDiv&&c.opacityDiv.dialog("isOpen")===true){return c.opacityDiv.dialog("close")}c.allNamesInGUI=[];$(c.opacityDiv).empty().remove();return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a="addtoolbutton";if(this.addToToolsMenu){a="addtomenu"}sMap.events.triggerEvent(a,this,{index:this.toolbarIndex,label:this.lang.buttonText,menuId:this.addToToolsMenu,iconCSS:"ui-icon-image",tagID:"button-opacity"})},layervisible:function(b){if(!this.active===true){return}var a=this.map.getLayersByName(b.layer.name);this.addopacityrow(a)},layerhidden:function(a){if(!this.active===true){return}this.delopacityrow(a.layer.name)},setbaselayer:function(d){var a=this;if(!a.active===true){return}var c=a.activeBaseLayer;a.delopacityrow(c);var b=a.map.getLayersByName(d.layerName);a.addopacityrow(b);a.activeBaseLayer=d.layerName},delopacityrow:function(b){var a=this.allNamesInGUI,b=(typeof(b)=="object")?b.name:b;var c=$.inArray(b,a);a.splice(c,1);$(".opacity-rowsdiv").find("#"+b).remove()},addopacityrow:function(j){var n=this,d=this.allNamesInGUI,e=this.opacityRowsDiv;for(var g=0;g<j.length;g++){var m=j[g];if(m.displayInLayerSwitcher!=true||m.visibility!=true||m.name=="selectLayer"||m.name=="poiLayer"||m.name=="theDrawLayer"){continue}var o=$.inArray(m.name,d);if(o==-1){d.push(m.name)}else{alert("Layer "+m.name+" is already in list!");continue}var k=sMap.cmd.getLayerConfig(m.name);if(!k||!(k instanceof Object)){continue}var a=k.displayName,h=OpenLayers.Util.createUniqueID(),c=1,b=100;c=m.opacity!=null?m.opacity:c;b=Math.round(c*100);var l=$("<div class='opacity-rows' id='"+m.name+"'><span class='opacity-mapname'>"+a+"</span><div class='opacity-sliderdiv' id='"+h+"'></div><span class='opacity-values'>"+b+"</span></div>");l.children("div#"+h).slider({value:b,create:function(p,i){m.setOpacity(c)},start:function(p,i){},animate:true,slide:function(q,p){var r=$(this).parent().get(0).id;var i=n.map.getLayersByName(r)[0];i.setOpacity(p.value/100);$(this).parent().children("span.opacity-values").text(p.value)},stop:function(p,i){sMap.events.triggerEvent("updatelinkentries",this,{})}});e.append(l)}},creatingwebparams:function(){var a=this,e=[];var g=sMap.db.webParams.BL?[sMap.db.webParams.BL]:[];var c=sMap.db.webParams.OL?sMap.db.webParams.OL:[];if(typeof c=="string"){c=[c]}var b=g.concat(c);$.each(b,function(){var h=sMap.map.getLayersByName(this)[0]||{};var j=h.opacity!==null&&h.opacity!==undefined?h.opacity:1;var i=Math.round(j*100);e.push(i)});var d=null;$.each(e,function(){if(this!=100){d=false;return false}});if(d!=null){sMap.db.webParams.op=e}},afterapplyingwebparams:function(){var b=sMap.db.startingWebParamsObject.OP?sMap.db.startingWebParamsObject.OP:[];if(!b.length){return}if(typeof b=="string"){b=[b]}var a=sMap.db.startingWebParamsObject.OL?sMap.db.startingWebParamsObject.OL:[];if(typeof a=="string"){a=[a]}var d=sMap.db.startingWebParamsObject.BL?[sMap.db.startingWebParamsObject.BL]:[];var c=d.concat(a);if(c.length&&b.length){$.each(c,function(e){var g=sMap.map.getLayersByName(this)[0];g.setOpacity(b[e]/100)})}},createContent:function(e){var a=this,c=this.map.layers,e=$("<div id='opacity-maindiv' />");var d=$("<div class='opacity-rowsdiv'></div>");a.opacityRowsDiv=d;a.addopacityrow(c);var b=$("<div id='opacity-btndiv'><button id='opacity-togglebtn'>"+a.lang.resetButtonText+"</button></div>");b.children("button").click(function(){$(".opacity-sliderdiv").each(function(i){var h=$(this);h.slider("value",100);h.slider("option","slide").call(h,null,{handle:$(".ui-slider-handle",h),value:100})})});e.append(d);e.append(b);b.find("button").button();if(a.savePrefChecked){var g=$("<div id='opacity-prefdiv'><label for='opacity-prefs'>"+a.lang.prefText+"</label><input id='opacity-prefs' type='checkbox' checked='"+this.savePrefChecked+"' name='savePrefs' /></div>");b.append(g)}return e},createopacitychanger:function(b){var a=this;sMap.util.createDialog(b,{titleText:a.lang.headerText,position:a.dialogStartPosition,width:a.width,height:a.height,resizable:true,onClose:function(){a.events.triggerEvent("dialogclosed",{control:a});a.deactivate.call(a)},onOpen:null});return b},CLASS_NAME:"sMap.Module.Opacity"});sMap.moduleConfig.Opacity={activateFromStart:false,dialogStartPosition:[150,80],height:268,width:380,savePrefChecked:"checked"};sMap.Lang.lang.Opacity={"sv-SE":{buttonText:"Transparens",headerText:"Ändra transparens",resetButtonText:"Sätt alla på 100",prefText:"Spara inställningar när verktyget stängs"},en:{buttonText:"Transparency",headerText:"Change transparency",resetButtonText:"Set all sliders to 100",prefText:"Save preferences when closing the tool"}};sMap.Module.OverlayToggler=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["layervisible","layerhidden"],EVENT_TRIGGERS:[],markAsActive:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.OverlayToggler.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.OverlayToggler.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},renderLayers:function(b,d){b=b||[];for(var c=0,a=b.length;c<a;c++){theId=this.nameToId(b[c]);if(d){$("#oltoggler-"+theId).addClass("ui-state-active")}else{$("#oltoggler-"+theId).removeClass("ui-state-active")}}},layervisible:function(b){var a=b.layer.name;this.renderLayers([a],true)},layerhidden:function(b){var a=b.layer.name;this.renderLayers([a],false)},activate:function(){if(this.active===true){return false}this.div.show();return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}this.div.hide();return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){$(this.div).empty().remove();this.div=null;this.div=$("<div id='oltoggler-maindiv' />");this.container=$("<table id='oltoggler-container' />");this.div.append(this.container);this.addLayers();$("#mapDiv").append(this.div);if(this.markAsActive.length){this.renderLayers(this.markAsActive,true)}},addLayers:function(){var b,a,c=sMap.config.layers.overlays||[];for(b=0,len=c.length;b<len;b++){a=c[b];this.addLayer(a)}},nameToId:function(a){return encodeURIComponent(a).replace(/%/gi,"_OO_")},idToName:function(a){return decodeURIComponent(name.replace(/_OO_/gi,"%"))},addLayer:function(a){var b="oltoggler-"+this.nameToId(a.name);var d=a.style&&a.style["default"]&&a.style["default"].externalGraphic?a.style["default"].externalGraphic:this.defaultLegendUrl;var c=$("<tr id='"+b+"'><td><img src='"+d+"'></img></td><td>"+a.displayName+"</td></tr>");this.container.append(c);if(this.maxOneOl===true){c.click(this.oneOlOnly).mouseenter(this.onRowHover).mouseleave(this.onRowHoverOut);if(this.markAsActive.length==0&&a.startVisible===true){this.markAsActive.push(a.name)}else{if(a.startVisible===true){sMap.events.triggerEvent("hidelayer",this,{layerName:a.name})}}}else{c.click(this.onRowClick).mouseenter(this.onRowHover).mouseleave(this.onRowHoverOut);if(a.startVisible===true){this.markAsActive.push(a.name)}}},oneOlOnly:function(){var e="ui-state-active",a,b=decodeURIComponent($(this).attr("id").replace("oltoggler-","").replace(/_OO_/gi,"%"));var d=$(this).siblings();$.each(d,function(i,h){var g=decodeURIComponent($(this).attr("id").replace("oltoggler-","").replace(/_OO_/gi,"%"));var j=!$(this).hasClass(e);if(j!==true){sMap.events.triggerEvent("hidelayer",this,{layerName:g})}});var c=!$(this).hasClass(e);if(c===true){a="showlayer"}else{a="hidelayer"}sMap.events.triggerEvent(a,this,{layerName:b})},onRowClick:function(){var d="ui-state-active",a,b=decodeURIComponent($(this).attr("id").replace("oltoggler-","").replace(/_OO_/gi,"%"));var c=!$(this).hasClass(d);if(c===true){a="showlayer"}else{a="hidelayer"}sMap.events.triggerEvent(a,this,{layerName:b})},onRowHover:function(){$(this).addClass("ui-state-hover")},onRowHoverOut:function(){$(this).removeClass("ui-state-hover")},CLASS_NAME:"sMap.Module.OverlayToggler"});sMap.moduleConfig.OverlayToggler={activateFromStart:true,maxOneOl:true,defaultLegendUrl:"img/eraser_cross.gif"};sMap.Lang.lang.OverlayToggler={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.Pizza=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Pizza.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Pizza.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){this.addMainControls();this.addMalmoPizza()},addMainControls:function(){var a=new OpenLayers.Control.PanZoomBar({slideFactor:150});this.map.addControl(a);$(a.div).css("cursor","pointer")},addMalmoPizza:function(d){var a=this;var b=OpenLayers.Util.createUniqueID("panbar_");var c=$("<img unselectable='on' class='unselectable pizza-icon-panbar' id='"+b+"' src='img/pizzaIcons/icon_panbar_51x51.png' />");c.css("top",this.divOffsetTop+"px");c.click(function(g){OpenLayers.Event.stop(g)});$(this.map.viewPortDiv).append(c);this.map.events.register("changebaselayer",this,function(){this.changePosition()});$(window).on("resize",function(){setTimeout(function(){a.changePosition()},1)});this.changePosition()},changePosition:function(){var m=this;var e=this.divOffsetLeft,k=this.divOffsetTop;var h={panup:[0,-3],pandown:[0,-3],panleft:[-1,-3],panright:[1,-3]};var c=["img/pizzaIcons/zoom-plus-mini.png","url('img/pizzaIcons/zoombar.png')","img/pizzaIcons/slider.png","img/pizzaIcons/zoom-minus-mini.png"];var a="13px";var j=m.map.getControlsByClass("OpenLayers.Control.PanZoomBar")[0];var b=$(j.div);var l=4;var g=4;b.css("left",l+e);b.css("top",g+k);b.children().each(function(o){$(this).attr("unselectable","on").addClass("unselectable");var i=$(this).prop("id");var n=i.split("_");n=n[n.length-1];if(o<=3){var q=sMap.util.takeAwayPx($(this).css("left"));var p=sMap.util.takeAwayPx($(this).css("top"));q+=h[n][0];p+=h[n][1];$(this).css("left",q+"px");$(this).css("top",p+"px")}});b.children().each(function(i){if(i<=3){$(this).addClass("pizza-panimg-invisible")}});var d=0;b.children().each(function(i){if(i>3){if(d==1){$(this).css({"background-image":'url("img/pizzaIcons/zoombar.png")'})}else{if(d==2){$(this).find("img").prop("src",c[d]).addClass("pizza-slider");$(this).addClass("pizza-slider")}else{$(this).find("img").prop("src",c[d])}}d+=1}});j.initialize()},maploaded:function(){this.changePosition()},CLASS_NAME:"sMap.Module.Pizza"});sMap.moduleConfig.Pizza={activateFromStart:true,divOffsetTop:7,divOffsetLeft:6};sMap.Lang.lang.Pizza={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.Popup=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["selected","beforeunselect","unselected","layerhidden"],EVENT_TRIGGERS:["beforepopupadded","popupadded","popupremoved"],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Popup.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Popup.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},selected:function(x){var d=this.map.getControlsByClass("sMap.Module.Blixten");if((d.length&&d[0].active)||($("#blixtenpopup-dialogdiv").length&&$("#blixtenpopup-dialogdiv").dialog("isOpen"))){return false}var g=x.features,q=x.selectedFeatures;if(q.length==1){var v=q[0];var o=sMap.cmd.getLayerConfig(v.layerName||(v.layer?v.layer.name:null))||{};if(v.attributes.specialForCoordinateSearch&&v.attributes.specialForCoordinateSearch===true){o.popup=o.popupCoordinates}var w=o.popup||v.layer.popupHTML||null,l=v.attributes||{};if(!w){return false}var m=this.makeHTML(l,w);var r;if(sMap.util.getGeomType(v.geometry)=="line"){if(x.xy){r=this.map.getLonLatFromPixel(new OpenLayers.Pixel(x.xy.x,x.xy.y))}else{var h=v.geometry.getVertices();var k=parseInt(h.length/2);var y=h[k];r=new OpenLayers.LonLat(y.x,y.y)}}else{if(x.xy){r=this.map.getLonLatFromPixel(new OpenLayers.Pixel(x.xy.x,x.xy.y))}else{var y=v.geometry.getCentroid();r=new OpenLayers.LonLat(y.x,y.y)}}if(o.rmBtn===true){var a="<button class='popup-rmBtn'>"+this.lang.rmBtnTxt+"</button>";m+=a}var b=new OpenLayers.Popup.FramedCloud("popup-"+v.id,r,null,m,new OpenLayers.Icon(null,new OpenLayers.Size(18,-10),new OpenLayers.Pixel(-8,3)),true,function(c){sMap.events.triggerEvent("unselect",this,{features:[v]})});b.panMapIfOutOfView=this.panMapIfOutOfView;sMap.events.triggerEvent("beforepopupadded",this,{popup:b,feature:v});this.map.addPopup(b);if(o.rmBtn===true){$(".popup-rmBtn").click(function(){sMap.events.triggerEvent("unselect",this,{features:[v]});var c=sMap.map.getLayersByName("poiLayer")[0]||null;if(c==null||c.features.length!=1){return}else{sMap.events.triggerEvent("cleanlayer",this,{layer:c})}})}v.popup=b;if($.browser.msie&&parseInt($.browser.version)<=8){sMap.db.popupPopup=b;sMap.db.setPopupSize=function(){var c=sMap.db.popupPopup;c.minSize=new OpenLayers.Size(300,120);c.maxSize=new OpenLayers.Size(this.xMaxSize,this.yMaxSize);c.updateSize()};setTimeout("sMap.db.setPopupSize();",20)}else{b.minSize=new OpenLayers.Size(300,120);b.maxSize=new OpenLayers.Size(this.xMaxSize,this.yMaxSize);$(document).ready(function(){b.updateSize()})}sMap.events.triggerEvent("popupadded",this,{popup:b,feature:v})}else{if(q.length>1){var j=this.map.popups;if(j&&j.length){for(var u=0;u<j.length;u++){j[u].destroy()}}}}if(this.minimizeBtn===true){var s=$(".olPopupCloseBox");var n=s.clone();n.prop({id:"minimize",title:this.lang.minimizeBtn});n.css({right:"20px",position:"relative",top:"0px"});n.removeClass("olPopupCloseBox").addClass("ui-button-icon-primary ui-icon ui-icon-minus");n.click(function(c){sMap.events.triggerEvent("unselected",this,{})});n.appendTo(s)}if(this.allowDrag==true&&b){var p=new OpenLayers.Control.DragPopup(b);this.map.addControl(p);b.moveTo=function(){if(p.down){OpenLayers.Popup.prototype.moveTo.apply(this,arguments)}else{OpenLayers.Popup.Anchored.prototype.moveTo.apply(this,arguments)}}}},beforeunselect:function(b){var a=this.map.popups&&this.map.popups.length?this.map.popups[0]:null;if(a){this.map.removePopup(a);a.destroy()}},unselected:function(b){var a=this.map.popups&&this.map.popups.length?this.map.popups[0]:null;if(a){this.map.removePopup(a);a.destroy()}},layerhidden:function(b){var a=this.map.popups.length?this.map.popups[0]:null;if(a){sMap.events.triggerEvent("unselect",this,{})}},makeHTML:function(a,b){return sMap.util.extractAttributes(a,b)},drawContent:function(){},CLASS_NAME:"sMap.Module.Popup"});sMap.moduleConfig.Popup={activateFromStart:true,minimizeBtn:true,allowDrag:false,xMaxSize:300,yMaxSize:300,panMapIfOutOfView:false};sMap.Lang.lang.Popup={"sv-SE":{labelText:"Tryck här",minimizeBtn:"Göm popup",rmBtnTxt:"Ta bort"},en:{labelText:"Press here",minimizeBtn:"Hide popup",rmBtnTxt:"Remove"}};sMap.Module.Print=OpenLayers.Class(sMap.Module,{layer:null,divID:"print-div",EVENT_LISTENERS:["beforeprint","afterprint"],EVENT_TRIGGERS:["beforeprint","afterprint"],dialogDiv:null,initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Print.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Print.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);this.is_chrome=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}this.createLayer();var a=this.map.getSize();this.addExtentFeature(a.h-50,a.h-50);this.createDialog();this.map.events.register("moveend",this,this.recenterExtentFeature);this.map.events.register("zoomend",this,this.recenterExtentFeature);return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}this.map.events.unregister("moveend",this,this.recenterExtentFeature);this.map.events.unregister("zoomend",this,this.recenterExtentFeature);if(this.layer){this.layer.destroy();this.layer=null}if(this.dialogDiv&&this.dialogDiv.length){this.dialogDiv.dialog("destroy");this.dialogDiv.empty().remove();this.dialogDiv=null}$("#"+this.divID).empty().remove();this.loading(false);return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){this.proxyHost=this.useProxy?(sMap.config.proxyHost||""):"";var a={index:this.toolbarIndex,hoverText:this.lang.labelText,iconCSS:"ui-icon-print",label:this.lang.btnPrint,tagID:"btn-print",menuId:this.addToToolsMenu};var b=this.addToToolsMenu?"addtomenu":"addtoolbutton";if(this.addToToolsMenu){a.label=this.lang.btnPrintInMenu}sMap.events.triggerEvent(b,this,a)},beforeprint:function(a){if(this.map.getLayersByName(this.layer.name).length){this.map.removeLayer(this.layer)}},afterprint:function(a){this.map.addLayer(this.layer);this.layer.setZIndex(699);$("#"+this.divID).empty().remove();this.loading(false);this.posting=false},loading:function(b,a){b=b||false;a=a||this.lang.textLoadingPrint;if(b===true){OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait");sMap.cmd.loading(true,{text:a})}else{OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait");sMap.cmd.loading(false)}},recenterExtentFeature:function(){this.addExtentFeature(this.width,this.height)},createLayer:function(){var a=new OpenLayers.StyleMap({"default":this.defaultStyle});this.layer=new OpenLayers.Layer.Vector("printlayer",{styleMap:a});this.map.addLayer(this.layer);this.layer.setZIndex(699)},addExtentFeature:function(b,n){this.layer.destroyFeatures();var p=this.map.getCurrentSize();var g=p.h,m=p.w;var e=b||p.h-50;var l=n||e;this.width=l;this.height=e;var c=m/2-l/2,j=g/2-e/2;var k=this.map.getLonLatFromViewPortPx(new OpenLayers.Pixel(c,j+e)),d=this.map.getLonLatFromViewPortPx(new OpenLayers.Pixel(c+l,j));var a=new OpenLayers.Bounds(k.lon,k.lat,d.lon,d.lat);var i=a.toGeometry();var o=new OpenLayers.Feature.Vector(i);this.layer.addFeatures([o])},createDialog:function(){var b=$("<div id='print-dialog' />");this.dialogDiv=b;var a=this;sMap.util.createDialog(b,{width:220,height:258,resizable:false,titleText:this.lang.dialogTitle,onClose:function(){a.deactivate()}});b.dialog("open");this.fillDialog()},fillDialog:function(){var k=this;var b=$("<div id='printwindow-tabscontainer' />");this.dialogDiv.append(b);var g=$("<ul><li><a href='#printwindow-printdiv'>"+this.lang.btnPrint+"</a></li><li><a href='#printwindow-exportdiv'>"+this.lang.btnExport+"</a></li></ul>");b.append(g);var e=$("<div id='printwindow-printdiv' class='print-tabcontent' />"),m=$("<div id='printwindow-exportdiv' class='print-tabcontent' />");b.append(e).append(m);b.tabs({select:function(o,n){if(n.tab.hash=="#printwindow-printdiv"){k.dialogDiv.dialog("option","height",258)}else{k.dialogDiv.dialog("option","height",192)}}});var a=$("<div id='print-description-header'>"+this.lang.description+"</div>"),i=$("<input type='text' id='print-description-tag' />"),c=$("<div id='print-extentslider-header'>"+this.lang.printArea+"</div>"),j=$("<div id='print-extentslider' />"),d=$("<button id='print-btnexport'>"+this.lang.btnExport+"</button>"),h=$("<button id='print-btnprint'>"+this.lang.btnPrint+"</button>");this.dialogDiv.append(c).append(j);e.append(a).append(i).append(h);m.append(d);d.button({icons:{primary:"ui-icon-document"}});h.button({icons:{primary:"ui-icon-print"}});var l=this.map.getCurrentSize();j.slider({animate:false,max:l.h-50,min:100,step:5,value:l.h-50,slide:function(o,n){k.addExtentFeature(n.value,n.value)}});this.extentSlider=j;h.click(function(){k.loading(k.lang.textLoadingPrint);k.preparePrint({type:"print"})});d.click(function(){k.loading(k.lang.textLoadingExport);k.preparePrint({type:"export"})})},preparePrint:function(a){var b=this.extentSlider.slider("option","value");$.extend(a,{val:b,headerText:$("#print-description-tag").val()||null});this.storeLayers();this.createMap(a);this.print(a)},storeLayers:function(){sMap.events.triggerEvent("beforeprint",this,{});var n=this.map.layers.slice(0),c=[];var k=null;for(var d=0,h=n.length;d<h;d++){var e=n[d];if(!e.getVisibility()){continue}if(!e.calculateInRange()){continue}if(e.features&&!e.features.length){continue}if(e.isBaseLayer===true){k=e;continue}if(e.protocol){var l=new OpenLayers.Layer.Vector(e.name,{});var g=e.features,a=[];for(var b=0,m=g.length;b<m;b++){a.push(g[b].clone())}l.styleMap=e.styleMap;l.addFeatures(a);c.push(l);continue}c.push(e.clone())}if(k){c.push(k.clone())}sMap.db.printLayers=c},createMap:function(c){var g=sMap.config;var a=g.maxExtent,e=sMap.db.printLayers,b=$("<div id='print-mapdiv' />");$("#smapDiv").append(b);b.css({width:c.val+"px",height:c.val+"px"});var d=new OpenLayers.Map("print-mapdiv",{projection:g.projection,resolutions:g.resolutions,units:"m",allOverlays:this.map.allOverlays,layers:e,maxExtent:new OpenLayers.Bounds(a.w,a.s,a.e,a.n)});this.printMap=d;if(d.allOverlays!==true){d.setBaseLayer(e[e.length-1])}this.setZoomAndCenter();b.hide()},setZoomAndCenter:function(){var b=sMap.cmd.getParamsAsObject();var a=b.ZOOM!=undefined?parseInt(b.ZOOM):0;if(a===0){this.printMap.zoomTo(1)}if(b.CENTER&&b.CENTER instanceof Array){this.printMap.setCenter(new OpenLayers.LonLat(parseFloat(b.CENTER[0]),parseFloat(b.CENTER[1])),a)}},print:function(a){a=a||{};var o=false;var e=this.printMap.layers;var b=e.length;var k="loadend";var p=this;var c=function(q){b-=1;if(q.object){q.object.events.unregister(k,p,this)}if(b<=0){var i=p.getPrintConfig(p.printMap);p.postToServer(i,a)}};var l=false,m=["Google","Vector"],g=[];for(var d=0,j=e.length;d<j;d++){var h=e[d];if(h.CLASS_NAME=="OpenLayers.Layer.Google"){alert("Google-lager stöds inte vid utskrift p.g.a. av dess begränsade API.");o=true}var n=true;if($.inArray(h.CLASS_NAME.split(".")[2],m)!==-1){g.push(h.name);n=false}if(n===false){b-=1;continue}else{h.events.register(k,this,c);l=true}this.printMap.removeLayer(h);this.printMap.addLayer(h)}if(o){sMap.events.triggerEvent("afterprint",this,{});return false}if(g.length){debug.warn("Module Print says: "+this.lang.layersNotSupported+g.join(", "))}if(l!==true){c()}},onSuccess:function(i){var b=i.url;if(i.type==="export"){location=i.url;sMap.events.triggerEvent("afterprint",this,{})}else{if(i.type==="print"){var d=$("<img id='print-image' />"),h=$("<h1 id='print-header'>"+(i.headerText||"")+"</h1>");var a=$("<div id='"+this.divID+"' />");var g=sMap.db.browser.msie?640:850,j=sMap.db.browser.msie?550:842;var l=i.val;var c=parseInt(g/2-l/2);c=c<0?0:c;a.css({"font-size":"12px",width:g+"px",height:j+"px",position:"absolute",left:"0px",top:"0px"});h.css({position:"relative",top:"100px","font-family":"arial","font-size":"36px","text-align":"center"});var k=l>g?g:l;d.css({position:"absolute",top:"200px",left:c+"px",width:k+"px"});d.load(function(m){$(window).bind("focus click",function(n){sMap.events.triggerEvent("afterprint",this,{});$(window).unbind("focus click")});window.print()});$("body").append(a);a.append(h).append(d);d.attr("src",b)}}},postToServer:function(d,b){b=b||{};if(this.posting){return false}this.posting=true;var c=this.printMap.getSize(),e=0;var a=this.privateExportFolder+"img.png";if(this.webContentRoot.slice(this.webContentRoot.length-1)=="/"){this.webContentRoot=this.webContentRoot.slice(0,this.webContentRoot.length-1)}$.ajax({type:"POST",url:this.proxyHost+this.printScriptsFolderPath+"printIt.py",context:this,data:{width:c.w,height:c.h,layers:d,outputPath:a,quality:90,headerText:b.headerText||null,webContentPath:this.webContentRoot,scale:e},success:function(h){this.printMap.destroy();$("#print-mapdiv").empty().remove();if(h.search(/error/i)!==-1){$("body").empty().append(h).css({overflow:"auto"});return false}h=h.replace(/\n/g,"");var g=this.publicExportFolder+h;OpenLayers.Util.applyDefaults(b,{url:g});this.onSuccess(b)}})},getPrintConfig:function(r){var c=[];var g=r.getSize();var m=new OpenLayers.Bounds(0,0,g.w,g.h);var D=r.layers;for(var v=0,P=D.length;v<P;v++){var a=D[v];var R=a.name;var G=sMap.cmd.getLayerConfig(R)||{};if(!a.getVisibility()){continue}if(!a.calculateInRange()){continue}var p=a.zIndex||a.getZIndex();if(R=="selectLayer"){p="699"}if(a.CLASS_NAME=="OpenLayers.Layer.Vector"&&a.features&&a.features.length){var H=a.styleMap.styles["default"].defaultStyle;var k=a.features;var l={url:H.externalGraphic||null,zIndex:p||null,layerType:"vector",layerName:G.displayName||H.name||null,legendImage:H.externalGraphic||null,fillColor:H.fillColor||null,fillOpacity:H.fillOpacity?parseInt(H.fillOpacity*255):255,graphicWidth:H.graphicWidth||null,graphicHeight:H.graphicHeight||null,strokeColor:H.strokeColor||null,strokeOpacity:H.strokeOpacity?parseInt(H.strokeOpacity*255):255,strokeWidth:H.strokeWidth||1,pointRadius:H.pointRadius||null,features:[]};var C=H.graphicXOffset?parseInt(H.graphicXOffset):0;var A=H.graphicYOffset?parseInt(H.graphicYOffset):0;var x=[];for(var M=0,q=k.length;M<q;M++){var O=k[M];var o=O.geometry;var y=o.getVertices();var w=sMap.util.getGeomType(o);var Q=y.length;var d=[];for(var K=0;K<Q;K++){var J=y[K];var I=new OpenLayers.LonLat(J.x,J.y);var h=r.getPixelFromLonLat(I);h=new OpenLayers.Pixel(h.x+C,h.y+A);if(w=="point"&&!m.containsPixel(h)){continue}d.push([h.x,h.y])}if(d.length==0){continue}var u={geomType:w,nodes:d};x.push(u)}l.features=x;c.push(l)}else{var F=a.grid||[];for(var M=0,q=F.length;M<q;M++){var z=F[M];for(var K=0,N=z.length;K<N;K++){var e=z[K];var b=a.getURL(e.bounds),B=e.position,L=a.opacity?parseInt(255*a.opacity):255;c.push({url:b,zIndex:p,x:B.x,y:B.y,opacity:L,layerType:"tile",layerName:G.displayName||a.name||null,legendImage:G.markerImage||null})}}}debug.log(c[v].zIndex)}var E=JSON.stringify(c);return E},CLASS_NAME:"sMap.Module.Print"});sMap.moduleConfig.Print={activateFromStart:false,webContentRoot:"/Library/WebServer/Documents/sMap/",publicExportFolder:"/Library/WebServer/Documents/temp/print/",privateExportFolder:"http://localhost/temp/print/",printScriptsFolderPath:"/Library/WebServer/CGI-Executables/WS/print/",defaultStyle:{pointRadius:8,strokeWidth:3,strokeColor:"#ff0000",fillColor:"#ff0000",strokeOpacity:1,fillOpacity:0.1}};sMap.Lang.lang.Print={"sv-SE":{btnPrint:"Skriv ut",btnPrintInMenu:"Skriv ut karta",dialogTitle:"Skriv ut/exportera",btnExport:"Exportera",description:"Rubrik (valfritt)",printArea:"Utskriftsområde",btnDownload:"",downloadTip:"Tryck här för att ladda ner bilden",labelText:"Skriv ut eller exportera kartan",textLoadingPrint:"Skriver ut...",textLoadingExport:"Exporterar..."},en:{btnPrint:"Print",btnPrintInMenu:"Print map",dialogTitle:"Print/Export",btnExport:"Export",description:"Header (optional)",printArea:"Print extent",btnDownload:"",downloadTip:"Press here to download the image",labelText:"Print or export the map",textLoadingPrint:"Printing...",textLoadingExport:"Exporting..."}};sMap.Module.RedirectClick=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.RedirectClick.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.RedirectClick.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a]);this.callbacks=this.callbacks||{}},activate:function(){if(this.active===true){return false}var b=this.map.getControlsByClass(this.CLASS_NAME);for(var c=0,a=b.length;c<a;c++){b[c].deactivate()}sMap.events.triggerEvent("unselect",this,{});sMap.util.showMouseMoveText(this.mouseMoveText);sMap.events.triggerEvent("deactivate",this,{module:"sMap.Module.Select"});this.handler.activate();return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}sMap.util.hideMouseMoveText();this.handler.deactivate();sMap.events.triggerEvent("activate",this,{module:"sMap.Module.Select"});return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){$.extend(this.callbacks,{done:this.onDone});this.handler=new OpenLayers.Handler.Point(this,this.callbacks,{persist:false});var a="addtoolbutton";if(this.addToToolsMenu){a="addtomenu"}sMap.events.triggerEvent(a,this,{index:this.toolbarIndex,label:this.displayName,hoverText:this.btnHover,iconCSS:this.buttonCss||"ui-icon-pencil",tagID:this.buttonId,left:this.left,right:this.right,menuId:this.addToToolsMenu})},onDone:function(c){var b=this.url;if(b){var a=parseInt(c.x),d=parseInt(c.y);b=b.replace(/\${x}/g,a).replace(/\${y}/g,d)}window.open(b,this.btnLabel);this.deactivate()},CLASS_NAME:"sMap.Module.RedirectClick"});sMap.moduleConfig.RedirectClick={activateFromStart:false,displayName:"",btnHover:null,url:null,overrideName:null,overrides:{snedbild:{},gatuvy:{}}};sMap.Lang.lang.RedirectClick={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.Report=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Report.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Report.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}this.createDialog();if(this.dialog){this.dialog.dialog("open")}else{this.createReport()}var a=this;var b=function(){a.createReport($(this).serializeArray());return false};this.onSubmit=b;this.dialog.find("form").on("submit",this.onSubmit);return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}this.dialog.find("form").off("submit",this.onSubmit);if(this.dialog){this.active=false;this.dialog.dialog("close");this.active=true}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},createDialog:function(){if(!this.formHtml){return false}var a=this;if(this.dialog){return false}this.dialog=$("<div />");this.dialog.append(this.formHtml);var b=$.extend({title:"Skapa rapport",autoOpen:false,open:function(){$(this).find("input, textarea").val(null)},close:function(){if(a.active){a.deactivate()}},buttons:[{text:this.lang.labelText,click:function(){var c=$(this).find("form").submit();$(this).dialog("close")}}]},this.dialogOptions);this.dialog.dialog(b)},createReport:function(b){b=b||[];sMap.cmd.loading(true,{bg:true});var c=this;this.winHtml=$("<div />");var g=$("<table />");for(var e=0,a=b.length;e<a;e++){var h=b[e];if(this.formLabels&&this.formLabels instanceof Object){labelText=this.formLabels[h.name]||""}if(e%2===0){row=$("<tr />");g.append(row)}row.append("<td style='min-width: 300px;'>"+labelText+h.value+"</td>")}var d=$('<button id="btn-print" style="position:absolute;padding:10px;right:40px;top: 20px;">Skriv ut</button>');this.winHtml.append(d);d.click(function(){d.remove();c.reportWin.print();c.reportWin.close()});if(g){this.winHtml.append(g)}this.exportMaps()},getLegend:function(){var l=this;var k,e=sMap.config.layers.overlays,a,m,d=$("<div />"),j=$("<table />"),g;for(var c=0,h=e.length;c<h;c++){k=e[c];g=this.map.getLayersByName(k.name).length?this.map.getLayersByName(k.name)[0].getVisibility():false;if(!g){continue}a=k.style&&k.style["default"].externalGraphic?k.style["default"].externalGraphic:null;if(k.legend&&k.legend.hover&&k.legend.hover.url){a=k.legend.hover.url}m=$("<tr><td></td><td>"+k.displayName+"</td></tr>");if(a){var b="<img src='"+a+"'></img>";m.find("td:first").append(b)}j.append(m);m.find("img").attr({height:"45",width:"45"});m.css({"font-size":"14px","font-weight":"bold"});m.find("td").css({border:"1px solid #aaa",padding:"2px 10px"})}if(j.children().length===0){return $("<div />")}d.append(j);return d},exportMaps:function(){var m=this,j=0,k="";var n=this.map.getZoom(),d=this.map.getResolutionForZoom(n);var e=this.zoomOverview,h=this.zoomOverviewRelative;if(h&&!e){e=n+h;if(e<=0){e=0}}resOverview=this.map.getResolutionForZoom(e);if(e>=n){e=n}var g=this.map.getControlsByClass("sMap.Module.SPrint");this.printControl=g.length?g[0]:null;var c=function(){var i=$.Deferred();m.printControl.core.dialog.print("Export_","PNG",{dpi:96,orientation:"Landscape",format:"A5",timeout:20000,onSuccess:function(o){i.resolve(o)},onError:function(o,q,p){i.reject(q)},onComplete:function(){sMap.cmd.loading(true,{bg:true})},scale:sMap.util.getScaleFromResolution(d),resolution:d});return i.promise()};var b=function(){var p=$.Deferred();var o=new OpenLayers.Layer.Vector("extlayer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillOpacity:0,strokeColor:"#0000FF",strokeWidth:4})})});var i=new OpenLayers.Feature.Vector(m.map.getExtent().toGeometry(),{});o.addFeatures([i]);setTimeout(function(){var q,r=false;if(m.overviewBaseLayerName){q=m.map.getLayersByName(m.overviewBaseLayerName)[0];r=m.map.baseLayer;m.map.setBaseLayer(q)}else{q=m.map.layers.baseLayer}m.printControl.core.dialog.print("Export_","PNG",{dpi:96,orientation:"Landscape",format:"A5",timeout:20000,layers:[q,o],onSuccess:function(s){p.resolve(s)},onError:function(s,u,t){p.reject(u)},onComplete:function(){if(r){m.map.setBaseLayer(r)}},scale:sMap.util.getScaleFromResolution(resOverview),resolution:resOverview})},1000);return p.promise()};var a=function(i){sMap.cmd.loading(false);debug.log(i);alert("Kunde inte skapa kartbild.\nErrormeddelande: "+i)};var l=[];c().done(function(i){l=l.concat(i);b().done(function(r){sMap.cmd.loading(false);var q,p;l=l.concat(r).reverse();var v=$("<div style='margin-top: 50px;text-align:center;'><span style='text-align:center;margin:0;'></span><span style='text-align:center;margin:0;'></span></div>");for(var t=0,o=l.length;t<o;t++){r=l[t];if(r){q=location.href.split("?")[0].replace(location.pathname,"");r=q+r;p=$('<img width="700px" style="margin-top:20px;" src="'+r+'"></img>');if(t===0){p.css("width","350px")}v.find("span:eq("+t+")").append(p)}}m.winHtml.append(v);var u=screen.height<1000?screen.height:1000;m.reportWin=window.open("","","left=200,top=10,width=800,height="+u);m.reportWin.focus();if(m.preHtml){$(m.reportWin.document.body).prepend(m.preHtml)}if($.browser.msie){m.reportWin.document.write(m.winHtml.html());var s=$(m.reportWin.document.body).find("#btn-print")[0];window.win=m.reportWin;s.onclick=function(){s.style.display="none";window.win.focus();window.win.document.close();window.win.print();return false}}else{$(m.reportWin.document.body).append(m.winHtml)}if(m.postHtml){if($.browser.msie){m.reportWin.document.write(m.postHtml)}else{$(m.reportWin.document.body).prepend(m.postHtml)}}}).fail(a)}).fail(a)},drawContent:function(){var b=this.labels instanceof Object?this.labels[sMap.langCode]:{};$.extend(this.lang,b);var e="btn-report",c=0;while($("#"+e).length>0){c+=1;e="btn-report"+c}var a={index:this.toolbarIndex,hoverText:this.lang.labelButtonHover||"",iconCSS:"ui-icon-document",label:this.lang.labelButton||"",tagID:e,menuId:this.addToToolsMenu,bindActivation:true};var d=this.addToToolsMenu?"addtomenu":"addtoolbutton";sMap.events.triggerEvent(d,this,a);this.toolbarButton=$("#"+e)},CLASS_NAME:"sMap.Module.Report"});sMap.moduleConfig.Report={activateFromStart:false,overviewBaseLayerName:null,addToToolsMenu:false,zoomOverviewRelative:-3,dialogOptions:{title:"Skapa lägeskarta"},preHtml:'<h1 style="text-align: center;">Lägeskarta</h1>',postHtml:null,formLabels:{"report-descript":"<label><strong>Ärende:</strong>&nbsp</label>","report-descript2":"<label><strong>Ärendenummer:</strong>&nbsp</label>","report-descript3":"<label><strong>Fastighet:</strong>&nbsp</label>","report-descript4":"<label><strong>Adress:</strong>&nbsp</label>"},formHtml:'<form><table><tr><td><label for="report-descript">Ärende</label></td><td><input type="text" name="report-descript" id="report-descript"></input></td></tr><tr><td><label for="report-descript2">Ärendenummer</label></td><td><input type="text" name="report-descript2" id="report-descript2"></input></td></tr><tr><td><label for="report-descript3">Fastighet</label></td><td><input type="text" name="report-descript3" id="report-descript3"></input></td></tr><tr><td><label for="report-descript4">Adress</label></td><td><input type="text" name="report-descript4" id="report-descript4"></input></td></tr></table></form>'};sMap.Lang.lang.Report={"sv-SE":{labelText:"Skapa",labelButton:"Skapa rapport",legendHeader:"Teckenförklaring "},en:{labelText:"Create",labelButton:"Create report",legendHeader:"Legend for "}};sMap.Module.ScaleBar=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.ScaleBar.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.ScaleBar.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){this.map.addControl(new OpenLayers.Control.ScaleBar({maxWidth:230,minWidth:190}));var a=$('<div id="scaleDiv" unselectable="on" class="unselectable" />');$("#mapDiv").append(a)},CLASS_NAME:"sMap.Module.ScaleBar"});sMap.moduleConfig.ScaleBar={activateFromStart:false};sMap.Lang.lang.ScaleBar={"sv-SE":{labelText:"Kilometer"},en:{labelText:"Kilometers"}};sMap.Module.ScaleSelector=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.ScaleSelector.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.ScaleSelector.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=$('<div id="scaleSelectorDiv" unselectable="on" class="unselectable" />');$(this.map.viewPortDiv).parent().append(a);this.createDropDown();this.bindEventListeners()},createDropDown:function(){var d=this;var h=$("#scaleSelectorDiv");var b=this.map.resolutions;var c="";for(var e in b){OpenLayers.DOTS_PER_INCH=96;var g=parseInt(Math.round(OpenLayers.Util.getScaleFromResolution(b[e],"m")));c=c+"<option value='"+g+"'>1:"+g+"</option>"}var a=$("<select unselectable='on' class='unselectable' name='scales' id='scaleSelectOpt'>"+c+"</select>");this.dropDownOptions=a;this.viewPortScalePostion=h;$(this.map.viewPortDiv).parent().append(this.dropDownOptions);$("#scaleSelectOpt.unselectable").change(function(){var i=d.dropDownOptions[0].selectedIndex;d.zoomToLevel(i)})},destroyDropDown:function(){this.unbindEventListeners();this.viewPortScalePostion.remove(this.dropDownOptions)},bindEventListeners:function(){this.map.events.register("zoomend",this,function(){if(this.map){var a=this.map.getZoom();this.changeScaleValue(a)}});this.map.events.register("changebaselayer",this,function(){var b=this.map.resolution;this.map.resolutions=this.map.baseLayer.resolutions;this.replaceScalesList();var a=this.keepPrevScale(b);var c=$.inArray(a,this.map.resolutions);if(c<0){c=this.map.resolutions.length-1}this.zoomToLevel(c);this.changeScaleValue(c)})},keepPrevScale:function(h){var n=this.map.resolutions;var d=0;var p=0;for(var c=0,o=n.length;c<o;c++){d=n[c];if(c==0){if(d==h){var p=d;c=o}}else{for(var b=1,m=n.length;b<m;b++){d=n[b];if(d<h){var g=n[b];var e=n[b-1];var l=Math.abs(g-h);var k=Math.abs(e-h);var a=Math.min(l,k);if(a==l){p=g}if(a==k){p=e}b=m;c=m}}}}return p},replaceScalesList:function(){$("#scaleSelectOpt").replaceWith();this.createDropDown()},unbindEventListeners:function(){this.map.events.unregister("zoomend",this,function(){});this.map.events.unregister("changebaselayer",this,function(){})},zoomToLevel:function(a){this.map.zoomTo(a)},changeScaleValue:function(b){var a=this.dropDownOptions[0];a.selectedIndex=b},CLASS_NAME:"sMap.Module.ScaleSelector"});sMap.moduleConfig.ScaleSelector={activateFromStart:false};sMap.Lang.lang.ScaleSelector={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.Search=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["addmarkerataddress","addmarkeratcoords","decidewhattodo","creatingwebparams","afterapplyingwebparams","cleanlayer"],EVENT_TRIGGERS:["addlayer","addmarkerataddress","addmarkeratcoords","decidewhattodo","searchlayer"],lastSearchedPoi:null,lastSearchedCoords:null,initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Search.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Search.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){var a=this;if(a.active===true){return false}if(a.noInput===true){a.appendAsOwnDiv=false;a.dropDownOption=false}if(a.dropDownOption===true&&a.appendAsOwnDiv===false){a.added();var b=$("#search-dropdownmenu").find("option:selected").text();a.changeCat(b)}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){$(this.searchInput).empty().remove();return sMap.Module.prototype.destroy.apply(this,arguments)},creatingwebparams:function(){var a=this;var c=$.inArray(a.poiLayer.name,sMap.db.webParams.OL||[]);if(c>-1){sMap.db.webParams.OL.splice(c,1)}var b=sMap.map.getLayersByName("poiLayer")[0]||null;if(b==null||b.features.length!=1){return}else{if(a.lastSearchedPoi!=null){sMap.db.webParams.poi=encodeURIComponent(a.lastSearchedPoi)}else{sMap.db.webParams.coords=a.lastSearchedCoords}}},addInfoMsg:function(e,b){var c=this;var a=typeof b!=="undefined"?b:c.lang.noPoiPreTxt+e+c.lang.noPoiPostTxt;var h=$("<div id='search-nopoitext'>"+a+"</div>");var g={};g[this.lang.noPoiBtnClose]=function(){$(this).dialog("close")};var d={dialogClass:"noTitleDialog",buttons:g};sMap.util.infoDialog(h,d)},bindAutocompleteToId:function(a){a.attr("placeholder",this.startText);var b=null;if(this.useProxy===true){b=sMap.config.proxyHost?sMap.config.proxyHost+encodeURIComponent(this.autoCompleteScriptUrl):this.autoCompleteScriptUrl}else{b=this.autoCompleteScriptUrl}a.autocomplete(b,{width:200,minChars:2,max:5000,selectFirst:true,matchSubset:false,encSpace:this.encSpace||null});a.result(this.resultHandler)},resultHandler:function(a){sMap.events.triggerEvent("decidewhattodo",this,{poi:a.target.value})},decidewhattodo:function(a){if(this.searchScriptUrl){sMap.events.triggerEvent("addmarkerataddress",this,{poi:a.poi})}else{sMap.events.triggerEvent("searchlayer",this,{layer:this.searchLayer,attributes:this.searchAttributes,option:"EQUAL_TO",q:a.poi})}},afterapplyingwebparams:function(){var a=sMap.cmd.getStartingParamsAsObject();if(a.POI){if(a.QL&&a.QA){sMap.events.triggerEvent("searchlayer",this,{layer:a.QL,attributes:[a.QA],option:"EQUAL_TO",q:a.POI})}else{sMap.events.triggerEvent("addmarkerataddress",this,{poi:a.POI,zoom:a.ZOOM||this.zoomLevel})}}else{if(!a.POI&&a.COORDS){var b=a.COORDS;b=b.toString();b=b.replace(","," ");this.handleCoords(b)}else{return}}},toggleOptionsDiv:function(h){var b=this;if(!b.firstTime){var j=b.optionsMenuDiv,a=$("#searchBox input");var g=a.offset(),d=a.outerWidth(),i=a.outerHeight();$(j).css({left:g.left,position:"absolute",top:g.top+i,width:d});$("#toolbar-maindiv").append(j);$("#search-dropdownmenu").change(function(){var e=$(this).find("option:selected").text();b.changeCat(e)});var c=$("#search-dropdownmenu").find("option:selected").text();b.changeCat(c);b.firstTime=1}$("#search-optionsmenu").toggle();return true},drawContent:function(){var k=this;if(k.noInput===true){return}sMap.events.triggerEvent("addtoolentry",this,{index:this.toolbarIndex,margin:10,tagID:"searchBox"});var i=$("#searchBox input");k.bindAutocompleteToId(i);if(k.dropDownOption==true){var e=k.dropDownItems,j="";for(var b in e){j=j+"<option value='"+e[b].searchBoxText+"'>"+b+"</option>"}var d=$("<select name='choices' id='search-dropdownmenu'>"+j+"</select>");k.dropDown=d;if(k.appendAsOwnDiv!=true){sMap.events.triggerEvent("addselect",k,{selectObject:d,index:k.dropDownIndex,appendToSearch:k.appendToBox})}else{sMap.events.triggerEvent("addtoolbutton",k,{index:k.dropDownIndex,on:k.toggleOptionsDiv,off:k.toggleOptionsDiv,hoverText:k.lang.hoverBtnText,iconCSS:"ui-icon-wrench",tagID:"button-searchoptions",appendToSearch:k.appendToBox});var a=k.createOptionsMenu();var c=$("<div id='search-innerdiv' class='ui-widget-content' />");var h=$("<div id='search-btnclose' class='ui-button-icon-primary ui-icon ui-icon-close' title='"+k.lang.closeTxt+"' />");var g=$("<div id='search-header'>"+k.lang.optionsHeader+"</div>");c.append(g).append(h).append(d);a.append(c);i.focus(function(){if($("#search-optionsmenu").is(":visible")){$("#button-searchoptions").click()}});h.click(function(l){$("#button-searchoptions").click()})}}},createOptionsMenu:function(){var a=$("<div id='search-optionsmenu' />");a.addClass("ui-widget ui-widget-clearfix").hide();this.optionsMenuDiv=a;return this.optionsMenuDiv},createPoiLayer:function(){var b=this.poiLayer;b.displayName=this.lang.searchLayerDisplayName;var a=new OpenLayers.Layer.Vector(b.name,{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style(b.defaultStyle)}),projection:new OpenLayers.Projection(this.map.projection),selectable:b.selectable,displayInLayerSwitcher:false});sMap.config.layers.overlays.push(b);sMap.events.triggerEvent("addlayer",this,{layer:a});return a},cleanlayer:function(a){a.layer.destroyFeatures();this.lastSearchedPoi=a.poi||null;this.lastSearchedCoords=a.coords||null},addmarkerataddress:function(d){var l=this;var c=d.poi,b=d.zoom||l.zoomLevel,i=d.setCenter===false?false:true,j=d.cleanLayer===false?false:true;var g=l.map.getLayersByName("poiLayer")[0]||null;if(!g){var g=l.createPoiLayer()}if(l.searchScriptUrl.charAt(l.searchScriptUrl.length-1)==="?"){l.searchScriptUrl=l.searchScriptUrl.substring(0,l.searchScriptUrl-1)}var h=l.searchScriptUrl+"?q="+encodeURIComponent(c);function k(n){var p=l.map,o=new OpenLayers.Format.GeoJSON(),m=o.read(n.responseText)[0];if(!m||m.length==0){l.addInfoMsg.call(l,c);return}else{l.lastSearchedCoords=null;l.lastSearchedPoi=c}var e=p.getLayersByName("poiLayer")[0]||null;if(j===true){e.destroyFeatures()}if(m.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){e.addFeatures([m]);e.setZIndex(699)}if(i===true){if(m.geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||m.geometry.CLASS_NAME=="OpenLayers.Geometry.LineString"){sMap.map.zoomToExtent(m.geometry.getBounds())}else{sMap.map.setCenter(new OpenLayers.LonLat(m.geometry.x,m.geometry.y),b)}}}var a=OpenLayers.Request.GET({url:h,callback:k})},transformCoords:function(b,g,a,h){b=b.toUpperCase();g=g.toUpperCase();var e=new Proj4js.Point(a,h);Proj4js.defs["EPSG:3008"]="+proj=tmerc +lat_0=0 +lon_0=13.5 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs";Proj4js.defs["EPSG:4326"]="+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs ";var c=new Proj4js.Proj(b);var d=new Proj4js.Proj(g);Proj4js.transform(c,d,e);return e},addmarkeratcoords:function(h){var r=this,b=r.map;var l=h.coords,g=h.zoom||r.zoomLevel,n=h.geomType||"Point",o=h.cleanLayer===false?false:true;var j=b.getLayersByName("poiLayer")[0]||null;if(!j){var j=r.createPoiLayer()}if(o===true){j.destroyFeatures()}l=typeof(l)=="string"?l.split(","):l;var i=parseFloat(l[0]),d=parseFloat(l[1]);var c=sMap.config.maxExtent;if(i>c.e||i<c.w||d>c.n||d<c.s){r.addInfoMsg.call(r,"eller de koordinater");return}else{poiCoords=l.toString();r.lastSearchedPoi=null;r.lastSearchedCoords=poiCoords}var q=h.allCoordinates,a=[],p=[];$.each(q,function(e,t){a.push(e);p.push(t[0],t[1])});var k={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:n,coordinates:[i,d]},properties:{specialForCoordinateSearch:true,code1:a[0],east1:p[0],north1:p[1],code2:a[1],east2:p[2],north2:p[3],code3:a[2],east3:p[4],north3:p[5],code4:a[3],east4:p[6],north4:p[7],code5:a[4],east5:p[8],north5:p[9]}}]};var m=new OpenLayers.Format.GeoJSON();var s=m.read(k)[0];if(s.geometry.CLASS_NAME=="OpenLayers.Geometry.Point"){j.addFeatures([s]);j.setZIndex(699)}sMap.map.setCenter(new OpenLayers.LonLat(s.geometry.x,s.geometry.y),g)},added:function(){var a=this,b=$("#search-dropdownmenu");b.addClass("search-dropdown");$(".search-dropdown").change(function(){var c=$(this).find("option:selected").text();a.changeCat(c)})},checkBounds:function(b){var a=sMap.config.maxExtent;if(b.x>a.e||b.x<a.w||b.y>a.n||b.y<a.s){return false}else{return true}},handleCoords:function(r){var l=this;var z=r.replace(",",".");var b=z.split(" ");var g=parseFloat(b[0]);var o=parseFloat(b[1]);if(isNaN(g)||isNaN(o)){l.addInfoMsg("NaN",'Enbart siffror tillåtna. Prova igen (t.ex " 100191 6214761 ")');return}var s=l.epsgCodes;var n=null;var k=[];for(var q=0;q<s.length;q++){var w=s[q];var m=sMap.util.projectPoint(w,sMap.config.projection,g,o);var a=this.checkBounds(m);if(a==true){n=w;k=[m.x,m.y];break}else{continue}}var t={};if(n==null){l.addInfoMsg("OutOfBounds",'Koordinaterna ligger inte i kartans utsträckning. Prova igen (t.ex " 100191 6214761 ")');return}else{for(var q=0;q<s.length;q++){var v=s[q];var u=sMap.util.projectPoint(sMap.config.projection,v,k[0],k[1]);var j=u.x.toFixed(2);var h=u.y.toFixed(2);t[v]=[j,h]}}sMap.events.triggerEvent("addmarkeratcoords",this,{coords:k,zoom:this.zoomLevel,epsg:n,allCoordinates:t})},changeCat:function(c){var a=this,b=a.dropDownItems[c],d=$("#searchBox input");d.val(b.searchBoxText);d.unautocomplete().off(".box");a.autoCompleteScriptUrl=b.autocompleteScript;a.searchScriptUrl=b.searchScript;if(!b.searchScript&&b.searchLayer&&b.searchAttributes){a.searchLayer=b.searchLayer;a.searchAttributes=b.searchAttributes}d.on("focus.box",function(){if($(this).val()==b.searchBoxText){$(this).val("")}}).on("focusout.box",function(){if($(this).val()==""){$(this).val(b.searchBoxText)}});if(a.appendAsOwnDiv==true){d.on("focus.box",function(){if($("#search-optionsmenu").is(":visible")){$("#button-searchoptions").click()}})}if(a.searchCatCoords==true&&c=="Koordinater"){a.addInfoMsg(" ",a.lang.helpTxt);d.on("keypress.box",function(g){if(g.keyCode==13){a.handleCoords($(this).val())}})}else{$("#searchBox input").autocomplete(a.autoCompleteScriptUrl,{width:300,minChars:2,max:5000,selectFirst:true,matchSubset:false,noResultText:a.noResultText});d.result(a.resultHandler)}},CLASS_NAME:"sMap.Module.Search"});sMap.moduleConfig.Search={activateFromStart:true,noInput:false,encSpace:null,startText:"Ange adress eller plats",autoCompleteScriptUrl:"http://kartor.smap.se/cgi-bin/search/sok.py?",searchScriptUrl:"http://kartor.smap.se/cgi-bin/search/sokexakt.py",zoomLevel:9,poiLayer:{name:"poiLayer",displayName:"",layerType:"vector",geomType:"point",selectable:true,displayInLayerSwitcher:false,defaultStyle:{externalGraphic:"img/location.png",graphicWidth:18,graphicHeight:18,graphicXOffset:-9,graphicYOffset:-9},rmBtn:true,popup:"<div class='popup-header1'>${name}</div>",popupCoordinates:"<div class='popup-header1'>Koordinat</div><div class='search-popup1'>${code1}:</div><div class='search-popup'> ${east1}, ${north1}</div><div class='search-popup1'>${code2}:</div><div class='search-popup'> ${east2}, ${north2}</div><div class='search-popup1'>${code3}:</div><div class='search-popup'> ${east3}, ${north3}</div><div class='search-popup1'>${code4}:</div><div class='search-popup'> ${east4}, ${north4}</div><div class='search-popup1'>${code5}:</div><div class='search-popup'> ${east5}, ${north5}</div>"},useProxy:true,dropDownOption:true,selId:"search-dropdownmenu",appendAsOwnDiv:true,appendToBox:true,searchCatCoords:true,epsgCodes:["EPSG:3006","EPSG:3008","EPSG:4326","EPSG:3021","EPSG:900913"],dropDownIndex:10,dropDownItems:{Koordinater:{dropDownName:"Koordinater",searchBoxText:"Sök koordinater",autocompleteScript:"http://kartor.smap.se/cgi-bin/search/sok.py?",searchScript:"http://kartor.smap.se/cgi-bin/search/sokexakt.py"},Adresser:{dropDownName:"Adresser",searchBoxText:"Ange adress",autocompleteScript:"http://kartor.smap.se/cgi-bin/search/sok.py?",searchScript:"http://kartor.smap.se/cgi-bin/search/sokexakt.py"},Fastigheter:{dropDownName:"Fastigheter",searchBoxText:"Ange fastighet",autocompleteScript:"http://kartor.smap.se/cgi-bin/search/sok.py?",searchScript:"http://kartor.smap.se/cgi-bin/search/sokexakt.py"}}};sMap.Lang.lang.Search={"sv-SE":{noPoiBtnClose:"Stäng",hoverBtnText:"Sökalternativ",closeTxt:"Stäng",optionsHeader:"Sökalternativ",noPoiPreTxt:"Den adress ( ",noPoiPostTxt:" ) som länkar till kartan är felaktigt angiven! Vänligen meddela den som är ansvarig för den sida du aktiverade kartan från.",helpTxt:'Separera med mellanslag, t.ex. "12.70 56.05". Både komma och punkt fungerar som decimalavskiljare. Sök med "enter".',searchLayerDisplayName:"Sökning"},en:{noPoiBtnClose:"Close",hoverBtnText:"Searchoptions",closeTxt:"Close",optionsHeader:"Searchoptions",noPoiPreTxt:"The address ( ",noPoiPostTxt:" ) that links to the map is not correctly written! Please contact the administrator for the page you activated the map from.",helpTxt:'Seperate the coordinates with space, e.g "12.70 56.05". Both comma and period work as decimaldelimiters. Search with "enter".',searchLayerDisplayName:"Search result"}};sMap.Module.Select=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["select","unselect","fetchselectfeatures","layerhidden","afterprint","fetchedfeatures","selectboxmode","selectclickmode"],EVENT_TRIGGERS:["selected","unselected","beforeselect","beforeunselect","getfeatures","fetchselectfeatures"],handlers:{},clickedOnDialogRow:false,selectLayer:null,initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Select.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Select.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}switch(this.handlerType){case ("box"):this.bindBox();break;default:this.bindClick()}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}if(this.addSelectWithKey){var b=this.map.getControlsByClass("OpenLayers.Control.Navigation")[0];b.enableZoomBox()}for(var a in this.handlers){this.handlers[a].deactivate()}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){this.map.removeLayer(this.selectLayer);this.selectLayer.destroy();var a=$("#select-selectdialog");if(a.length){a.dialog("destroy");a.empty().remove();a=null}return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){this.addSelectLayer()},afterprint:function(a){this.selectLayer.setZIndex(this.zIndex)},layerhidden:function(a){sMap.events.triggerEvent("unselect",this,{})},addSelectLayer:function(){this.selectLayer=new OpenLayers.Layer.Vector("selectLayer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style(this.defaultStyle),select:new OpenLayers.Style(this.selectStyle)}),rendererOptions:{yOrdering:true,zIndexing:true}});this.map.addLayer(this.selectLayer);this.selectLayer.setZIndex(this.zIndex);this.selectLayerStyleMap={};OpenLayers.Util.applyDefaults(this.selectLayerStyleMap,this.selectLayer.styleMap)},selectclickmode:function(a){this.bindClick()},bindClick:function(){if(this.handlers.box){this.handlers.box.deactivate()}this.handlers.click=this.handlers.click||new OpenLayers.Handler.Click(this,{click:this.onClick},this.handlerOptions.click);this.handlers.click.activate()},selectboxmode:function(a){this.bindBox()},bindBox:function(){if(this.handlers.click){this.handlers.click.deactivate()}this.handlers.box=this.handlers.box||new OpenLayers.Handler.ModBox(this,{done:this.onBoxEnd},this.handlerOptions.box);this.handlers.box.activate()},onClick:function(h){var l=h.xy.x,k=h.xy.y,b=this.clickRadius;var d=h.shiftKey,m=this.addSelectWithKey,i=this.dialogIfMany;sMap.events.triggerEvent("beforeselect",this,{xy:h.xy,add:(m&&d),dialog:!d});var c=new OpenLayers.Pixel(l-b,k+b),j=new OpenLayers.Pixel(l+b,k-b);var g=this.map.getLonLatFromViewPortPx(c),n=this.map.getLonLatFromViewPortPx(j);var a=new OpenLayers.Bounds(g.lon,g.lat,n.lon,n.lat);sMap.events.triggerEvent("fetchselectfeatures",this,{bounds:a,add:(m&&d),dialog:!d})},onBoxEnd:function(g){var d=this.handlers.box.dragHandler.keyMaskPressed,a=null,j=this.addSelectWithKey,h=this.dialogIfMany;if(g.CLASS_NAME=="OpenLayers.Pixel"){var b=this.clickRadius;var c=new OpenLayers.Pixel(g.x-b,g.y+b),i=new OpenLayers.Pixel(g.x+b,g.y-b);var e=this.map.getLonLatFromViewPortPx(c),k=this.map.getLonLatFromViewPortPx(i);a=new OpenLayers.Bounds(e.lon,e.lat,k.lon,k.lat)}else{if(g.CLASS_NAME=="OpenLayers.Bounds"){var c=new OpenLayers.Pixel(g.left,g.bottom),i=new OpenLayers.Pixel(g.right,g.top);var e=this.map.getLonLatFromViewPortPx(c),k=this.map.getLonLatFromViewPortPx(i);a=new OpenLayers.Bounds(e.lon,e.lat,k.lon,k.lat)}}sMap.events.triggerEvent("fetchselectfeatures",this,{bounds:a,add:(j&&d),dialog:!d})},fetchselectfeatures:function(a){this.add=a.add;this.useDialog=a.dialog||false;sMap.events.triggerEvent("getfeatures",this,{options:{filter:a.filter||null,bounds:a.bounds||null,select:true}})},fetchedfeatures:function(a){var b=a.features;if(a.select&&b.length){if(this.forceOne&&this.forceOne===true){b=[sMap.util.getNearestFeature(b,a.bounds.getCenterLonLat())]}sMap.events.triggerEvent("select",this,{features:b,add:this.add,dialog:this.useDialog})}else{sMap.events.triggerEvent("unselect",this,{})}},select:function(c){var b=c.features;if(!b.length){return false}if(c.add===true){var a=this.toggleSelection(b);b=a.select;sMap.events.triggerEvent("unselect",this,{features:a.unselect})}else{sMap.events.triggerEvent("unselect",this,{doNotDestroy:c.doNotDestroy})}if($("#select-selectdialog").length){$("#select-selectdialog").dialog("close")}if(c.dialog===true&&b.length>1){this.createChoiceDialog(b,{add:c.add})}else{this.selectFeatures(b,{add:c.add})}debug.log("Number of selected features: "+this.selectLayer.features.length)},toggleSelection:function(e){var b=[],j=[],g=null,h=this.selectLayer.features;for(var d=0,a=h.length;d<a;d++){g=h[d]}for(var d=0,a=e.length;d<a;d++){g=e[d];var c=this.featureInArray(h,g);if(c===-1){b.push(g)}else{j.push(g)}}return{select:b,unselect:j}},featureInArray:function(d,e){var b;for(var c=0,a=d.length;c<a;c++){b=d[c];if(this.featureIsSame(b,e)){return c}}return -1},featureIsSame:function(b,c){var a=false;if(b.geometry&&b.data&&c.geometry&&c.data){a=(b.geometry.toString()==c.geometry.toString()&&b.data.toString()==c.data.toString())}return a},unselect:function(k){var g=k.features,c=k.doNotDestroy||false;selectLayer=this.selectLayer;if(!g){g=selectLayer.features}if(g.length){var j=null,h=g.slice();sMap.events.triggerEvent("beforeunselect",this,{features:g});for(var d=0,a=h.length;d<a;d++){j=h[d];var b=j.popup||null;this.renderAsUnselected(j,{doNotDestroy:c});j.popup=b}sMap.events.triggerEvent("unselected",this,{features:g,selectedFeatures:this.selectLayer.features})}},renderAsUnselected:function(j,e){e=e||{};var c=e.doNotDestroy||false;if(j){var b=this.selectLayer;j.layer=b;var h=b.features;for(var g=0,a=h.length;g<a;g++){var d=h[g];if(!d||!j){break}if(this.featureIsSame(d,j)){if(c===true){b.removeFeatures([d])}else{b.destroyFeatures([d]);j.destroy()}}}}},selectFeatures:function(d,b){b=b||{};if(d.length==0){return}var e=b.add||false;for(var c=0,a=d.length;c<a;c++){this.renderAsSelected(d[c])}sMap.events.triggerEvent(this.selectedEvent||"selected",this,{features:d,selectedFeatures:this.selectLayer.features,add:e,xy:b.xy||(this.handlers.click&&this.handlers.click.evt?this.handlers.click.evt.xy:null)})},renderAsSelected:function(e){var b=this.selectLayer;e.oldStyle={};OpenLayers.Util.applyDefaults(e.oldStyle,e.style);var d=sMap.cmd.getLayerConfig(e.layerName);var h=$.extend({},this.selectStyle);var c=$.extend(h,(d&&d.style&&d.style.select?d.style.select:{}));c.graphicZIndex=this.zIndex;if(c.rules){var g=new OpenLayers.Style(c);g.addRules(c.rules);var a=g.createSymbolizer(e);$.extend(c,a||{});g=null}e.style=c;b.addFeatures([e]);b.setZIndex(this.zIndex);b.drawFeature(e,c)},getVisibleLayersConfig:function(b){var e=[];for(var d=0,a=b.length;d<a;d++){var c=this.map.getLayersByName(b[d].name)[0];if(c&&c.CLASS_NAME=="OpenLayers.Layer.WMS"&&c.calculateInRange()&&c.getVisibility()===true){e.push(b[d])}}return e},createChoiceDialog:function(d,b){var o=this;b=b||{};this.clickedOnDialogRow=false;this.fDict={};if(d.length){var c=$("#select-selectdialog");var e=sMap.util.getMapOrigo();var k=e.left+50,g=e.top+3,l=false;if(!c.length){c=$("<div id='select-selectdialog'></div>");l=true}else{c.children().remove()}var s=(this.maxLength>d.length)?d.length:this.maxLength,j=0,p=this.selectLayer.features;var v=$("<table />");c.append(v);for(var q=0;q<s;q++){var u=d[q];var w=u.layerName,h=OpenLayers.Util.createUniqueID("selectrowfeature_");this.fDict[h]=u;var n=sMap.cmd.getLayerConfig(w),r;if(n){r=n.style||null;if(r){r=r["default"]}else{r=n.defaultStyle}}var a=r?r.externalGraphic:null;var m=$("<tr id='"+h+"' unselectable='on' class='unselectable selectdialog-rowtag'><td class='selectmany-td-first'><img src='"+a+"'></img></td><td>"+n.displayName+"</td></tr>");v.append(m);j+=1;$(m).hover(function(B){$(this).addClass("selectdialog-rowtag-hover");var A=$(this).attr("id");var y=o.fDict[A];var C=y.geometry.getCentroid();var t=o.map.getViewPortPxFromLonLat(new OpenLayers.LonLat(C.x,C.y));o.selectFeatures([y],{add:b.add,xy:new OpenLayers.Pixel(t.x,t.y)});if(o.fitBoundsIfNotContained){var x=y.geometry.getBounds(),z=o.map.getExtent();var i=z.containsBounds(x);if(i===false){o.map.zoomToExtent(x)}}},function(y,t){$(this).removeClass("selectdialog-rowtag-mousedown");$(this).removeClass("selectdialog-rowtag-hover");var x=$(this).attr("id");var i=o.fDict[x];if(o.clickedOnDialogRow!==true){o.unselect({features:[i],doNotDestroy:true})}});$(m).click(function(i){o.clickedOnDialogRow=true;$(this).removeClass("selectdialog-rowtag-mousedown");$("#select-selectdialog").dialog("close");$(this).siblings().each(function(){var x=$(this).attr("id");var t=o.fDict[x];t.destroy()})});$(m).mousedown(function(i){$(this).addClass("selectdialog-rowtag-mousedown")})}if(l===true){sMap.util.createDialog(c,{title:this.lang.chooseFeature,width:"auto",close:function(){$(this).dialog("destroy")},height:"auto",minHeight:100,maxHeight:400,position:[k,g],modal:false});$("#select-selectdialog").parent().attr("id","select-dialogparent")}$(document).ready(function(){$("#select-selectdialog").dialog("open")});c.css("overflow-x","hidden")}},CLASS_NAME:"sMap.Module.Select"});sMap.moduleConfig.Select={activateFromStart:true,fitBoundsIfNotContained:true,defaultStyle:{pointRadius:18,strokeWidth:4,strokeColor:"#00ffff",fillColor:"#00ffff",strokeOpacity:1,fillOpacity:0.7,graphicZIndex:499},selectStyle:{pointRadius:8,strokeWidth:4,strokeColor:"#00ffff",fillColor:"#00ffff",strokeOpacity:1,fillOpacity:0.7,graphicZIndex:499},zIndex:499,multiple:true,forceOne:true,handlerType:"click",addSelectWithKey:true,dialogIfMany:true,handlerOptions:{click:{keyMask:OpenLayers.Handler.MOD_CTRL},box:{keyMask:OpenLayers.Handler.MOD_CTRL}},clickRadius:8,maxLength:20};sMap.Lang.lang.Select={"sv-SE":{chooseFeature:"Välj ett objekt"},en:{chooseFeature:"Select one feature"}};sMap.Module.SelectResult=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["select","unselect","layerhidden","createreport"],EVENT_TRIGGERS:["select","unselect","selected","createreport"],initialize:function(b){b=b||{};this.EVENT_LISTENERS=sMap.Module.SelectResult.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.SelectResult.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,b);sMap.Module.prototype.initialize.apply(this,[b]);this.cols=[];for(var a=0;a<this.colModel.length;a++){this.cols[a]=this.colModel[a].name}},activate:function(){if(this.active===true){return false}if(!this.dialogDiv){this.dialogDiv=this.makeDialogContent();this.dialogDiv=this.makeDialog(this.dialogDiv);this.createGrid()}if(!(typeof selectLayer=="undefined")){this.populateGrid(selectLayer.features)}this.dialogDiv.dialog("open");return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}if(this.dialogDiv&&this.dialogDiv.dialog("isOpen")===true){return this.dialogDiv.dialog("close")}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=this.addToToolsMenu?"addtomenu":"addtoolbutton";if(this.addToToolsMenu){sMap.events.triggerEvent("addtomenu",this,{index:this.toolbarIndex,iconCSS:"ui-icon-calculator",menuId:this.addToToolsMenu,label:this.lang.buttonText,tagID:"button-selectresult"})}else{sMap.events.triggerEvent(a,this,{index:this.toolbarIndex,label:a=="addtomenu"?this.lang.buttonText:null,hoverText:this.lang.buttonText,iconCSS:"ui-icon-calculator",tagID:"button-selectresult"})}},select:function(a){if(a.caller.MODULE_NAME&&$.inArray(a.caller.MODULE_NAME,this._noListenMods)===-1){if(selectLayer.features.length>1&&this.active!==true){this.activate()}else{this.populateGrid(selectLayer.features)}}},unselect:function(a){if(a.caller.CLASS_NAME=="OpenLayers.Popup.FramedCloud"){this.populateGrid(selectLayer.features)}},layerhidden:function(a){this.populateGrid(selectLayer.features)},createGrid:function(){var a=this;$("#resulttable").jqGrid({datatype:"local",height:this.gridHeight,autowidth:true,colNames:this.lang.colNames,colModel:this.colModel,rowNum:this.rowNum,grouping:true,groupingView:{groupField:["layername"],groupText:["<b>{0} - {1} "+this.lang.items+"</b>"],groupColumnShow:[false]},multiselect:true,deselectAfterSort:false,onSelectRow:function(c,b){if(b){sMap.events.triggerEvent("select",this,{features:[a.fDict[c]],add:true})}else{sMap.events.triggerEvent("unselect",this,{features:[a.fDict[c]],doNotDestroy:true})}},onSelectAll:function(d,b){if(b){sMap.events.triggerEvent("unselect",this,{doNotDestroy:true});for(var c=0;c<d.length;c++){sMap.events.triggerEvent("select",this,{features:[a.fDict[d[c]]],add:true})}a.zoomFeatures()}else{sMap.events.triggerEvent("unselect",this,{doNotDestroy:true})}},ondblClickRow:function(b){var c=a.fDict[b];sMap.map.zoomToExtent(c.geometry.getBounds());if(a.selectOnDblClick){sMap.events.triggerEvent("selected",this,{features:[a.fDict[b]],selectedFeatures:[a.fDict[b]]})}},onRightClickRow:function(b){}})},populateGrid:function(h){var a=$("#resulttable"),n=this.cols,d=false;a.clearGridData();this.fDict={};for(var g=0;g<h.length;g++){var p=sMap.cmd.getLayerConfig(h[g].layerName)||{};var o=p.selectAttributes?p.selectAttributes:[];if(p.report){d=true}var k={};for(var b=0;b<n.length;b++){if(n[b]=="layername"){k[n[b]]=p.displayName}else{if(o[b-1]){k[n[b]]=sMap.util.extractAttributes(h[g].attributes,o[b-1])}}}a.jqGrid("addRowData",g+1,k);this.fDict[g+1]=h[g]}a.jqGrid("groupingGroupBy","layername");for(var c=0;c<h.length;c++){a.jqGrid("setSelection",(c+1),false)}var e=$("#SelectResultReportButton");if(d){e.css("display","inline-block");if(sMap.db.browser.msie&&(parseInt(sMap.db.browser.version)<8)){e.css("display","inline")}}else{e.hide()}var m=$("#SelectResultZoomButton");if(h.length>0){m.css("display","inline-block");if(sMap.db.browser.msie&&(parseInt(sMap.db.browser.version)<8)){m.css("display","inline")}}else{m.hide()}this.resizeGrid()},resizeGrid:function(){var a=$("#resulttable"),b=$("#SelectResultDialogDiv").innerWidth();b=b>100?b:this.width;a.jqGrid("setGridWidth",b-30,true)},makeDialogContent:function(){var b=$("<div id='SelectResultDialogDiv' class='selectresultDiv' />");var a="<table id='resulttable'></table>";b.html(a);var c=$("<div id='SelectResultZoomButton'>"+this.lang.zoomButtonText+"</div>");c.button();b.append(c);c.click(this.zoomFeatures);c.hide();c.width(150);var d=$("<div id='SelectResultReportButton'>"+this.lang.reportButtonText+"</div>");d.button();d.width(150);b.append(d);d.click(function(){sMap.events.triggerEvent("createreport",this,{features:selectLayer.features})});d.hide();return b},createreport:function(k){var j=k.features,d="",b="";for(var h=0;h<j.length;h++){var c=j[h].layerName;var g=sMap.cmd.getLayerConfig(c)||{};var a=g.report?g.report:null;if(a){d=g.report.linkURL;b+=j[h].attributes[g.report.IDattribute]+","}}b=b.substring(0,b.length-1);if(d){window.open(d+b)}else{alert(this.lang.noSelectedFeaturesText)}},zoomFeatures:function(){var b=selectLayer.features;var c=new OpenLayers.Bounds();for(var a=0;a<b.length;a++){c.extend(b[a].geometry.getBounds())}if(c.left==c.right){sMap.map.setCenter(new OpenLayers.LonLat(c.left,c.top),this.pointZoomLevel)}else{sMap.map.zoomToExtent(c)}},makeDialog:function(b){var a=this;b.dialog({autoOpen:false,title:this.lang.headerText,position:this.dialogStartPosition,width:this.width,height:this.height,resizable:true,close:function(){a.deactivate.call(a)},open:null,resizeStop:this.resizeGrid});return b},CLASS_NAME:"sMap.Module.SelectResult"});sMap.moduleConfig.SelectResult={activateFromStart:false,_noListenMods:[],toolbarIndex:8,addToToolsMenu:false,dialogStartPosition:[50,150],height:500,width:360,gridHeight:380,colModel:[{name:"layername",index:"layername",width:150},{name:"name",index:"name",width:150,sortable:false},{name:"info",index:"info",width:100,sortable:false}],rowNum:50,pointZoomLevel:7,selectOnDblClick:false};sMap.Lang.lang.SelectResult={"sv-SE":{buttonText:"Urvalstabell",headerText:"Urvalstabell",reportButtonText:"Skapa rapport",zoomButtonText:"Zooma valda",colNames:["Lagernamn","Namn","Mer info"],items:"objekt",noSelectedFeaturesText:"Inga objekt valda!"},en:{buttonText:"Select result",headerText:"Select result",reportButtonText:"Create report",zoomButtonText:"Zoom selected",colNames:["Layername","Name","More info"],items:"item(s)",noSelectedFeaturesText:"No selected features!"}};sMap.Module.SelectTool=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.SelectTool.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.SelectTool.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}sMap.events.triggerEvent("selectboxmode",this,{});return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}sMap.events.triggerEvent("selectclickmode",this,{});return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=this.addToToolsMenu?"addtomenu":"addtoolbutton";sMap.events.triggerEvent(a,this,{index:this.toolbarIndex,label:a=="addtomenu"?this.lang.buttonText:null,hoverText:this.lang.buttonText,iconCSS:"btnselectbox",tagID:"button-selecttool"})},CLASS_NAME:"sMap.Module.SelectTool"});sMap.moduleConfig.SelectTool={activateFromStart:false,toolbarIndex:11,addToToolsMenu:false};sMap.Lang.lang.SelectTool={"sv-SE":{buttonText:"Välj objekt"},en:{buttonText:"Select objects"}};sMap.Module.SimpleSelect=OpenLayers.Class(sMap.Module,{hover:false,EVENT_LISTENERS:["layervisible","layerhidden","unselect","select","unselect"],EVENT_TRIGGERS:["select","unselect"],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.SimpleSelect.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.SimpleSelect.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}this.selectControl.activate();return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}this.selectControl.deactivate();return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=this.getLayers();this.selectControl=new OpenLayers.Control.SelectFeature([],{clickout:true,toggle:false,multiple:false,hover:this.hover,toggleKey:"ctrlKey",multipleKey:"shiftKey",onSelect:this.onSelect,onUnselect:this.onUnselect,selectedFeatures:[],layers:a});this.map.addControl(this.selectControl)},getLayers:function(){var b=this.map.layers,d=null,e=[];for(var c=0,a=b.length;c<a;c++){d=b[c];if(d.selectable&&d.CLASS_NAME=="OpenLayers.Layer.Vector"){e.push(d)}}return e},onSelect:function(a){this.selectedFeatures.push(a);sMap.events.triggerEvent("selected",this,{features:[a],selectedFeatures:this.selectedFeatures})},onUnselect:function(c){var d=this.selectedFeatures||[],e=false;for(var b=0,a=d.length;b<a;b++){if(d[b].fid==c.fid){e=true;break}}if(e){this.selectedFeatures.splice(b,1)}sMap.events.triggerEvent("unselected",this,{features:[c],selectedFeatures:this.selectedFeatures})},select:function(d){var b=d.features||[];if(b.length){for(var c=0,a=b.length;c<a;c++){this.selectControl.select(b[c])}}},unselect:function(d){var c=d.features||this.getSelectedFeatures();if(c.length){for(var b=0,a=c.length;b<a;b++){this.selectControl.unselect(c[b])}}else{this.selectControl.unselectAll();sMap.events.triggerEvent("unselected",this,{features:[],selectedFeatures:[]})}},layervisible:function(b){var a=this.getLayers();this.selectControl.setLayer(a)},layerhidden:function(b){var a=this.getLayers();this.selectControl.setLayer(a)},getSelectedFeatures:function(b){var e=this.selectControl.layers||[this.selectControl.layer];var c,d=[];for(var a=0;a<e.length;++a){c=e[a];d=d.concat(c.selectedFeatures)}return d},CLASS_NAME:"sMap.Module.SimpleSelect"});sMap.moduleConfig.SimpleSelect={activateFromStart:true};sMap.Lang.lang.SimpleSelect={"sv-SE":{labelText:"Tryck här"},en:{labelText:"Press here"}};sMap.Module.SPrint=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:[],EVENT_TRIGGERS:[],core:null,initialize:function(a){a=a||{};this.core=new sMap.Module.SPrint.Core(this);this.EVENT_LISTENERS=sMap.Module.SPrint.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.SPrint.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}this.core.activate();return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}if(this.core.deactivate()){return sMap.Module.prototype.deactivate.apply(this,arguments)}else{return true}},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},toggleDialog:function(){if(this.active!==true){this.activate()}this.core.toggleDialog()},drawContent:function(){if(this.addToToolsMenu){sMap.events.triggerEvent("addtomenu",this,{index:this.toolbarIndex,iconCSS:"ui-icon-print",menuId:this.addToToolsMenu,label:this.lang.buttonText,tagID:"button-sprint"})}else{sMap.events.triggerEvent("addtoolbutton",this,{index:this.toolbarIndex,iconCSS:"ui-icon-print",label:this.lang.buttonText,tagID:"button-sprint"})}},CLASS_NAME:"sMap.Module.SPrint"});sMap.moduleConfig.SPrint={activateFromStart:false,DOTS_PER_INCH:96,usePrintMask:true,printCopyrightNotice:'<div id="print-dialog-userconditions" class="ui-dialog-content ui-widget-content" scrolltop="0" scrollleft="0" style="width: auto; min-height: 0px; height: 183px;">För utdrag från kartan/flygfotot till tryck eller annan publicering, krävs tillstånd från Malmö Stadsbyggnadskontor. Vid frågor om tillstånd, användningsområden eller kartprodukter kontaktas Stadsbyggnadskontorets kartförsäljning: 040-34 24 35 eller <a href="mailto:sbk.sma@malmo.se?subject=Best%E4lla karta">sbk.sma@malmo.se</a>.<br><strong>Accepterar du villkoren?</strong></div>'};sMap.Lang.lang.SPrint={"sv-SE":{buttonText:"Skriv ut"},en:{buttonText:"Print"}};(function(){var a=function(b){this.module=b;this.format=new OpenLayers.Format.GeoJSON();this.dialog=new sMap.Module.SPrint.PrintControlDialog(this)};a.host="XXX";a.bind=function(b,c){return function(){return c.apply(b,arguments)}};a.prototype.activate=function(){this.dialog.dialog.dialog("open");this.dialogClosed=false};a.prototype.deactivate=function(){if(this.dialogClosed===true){return false}this.dialogClosed=true;if(this.dialog.dialog.dialog("isOpen")){this.dialog.dialog.dialog("close")}return true};a.prototype.toggleDialog=function(){var b=this.dialog.dialog.dialog("isOpen");if(b){this.dialog.dialog.dialog("close")}else{this.dialog.dialog.dialog("open")}},a.prototype.getUrlWithProxy=function(b){if(sMap.config.proxyHost!=null){return sMap.config.proxyHost+encodeURIComponent(b)}else{return b}};a.prototype.remoteQueryFail=function(c,e,d){var b="Kommunikation med server misslyckades, felmeddelande: \n"+e+"\n";if(c!=null){if(c.status!=null){b+="Status: "+c.status+"\n"}if(c.responseText!=null){b+="Response text: "+c.responseText+"\n"}}alert(b)};a.prototype.exampleServerCall=function(b){var c=a.host+"XXX_setThisOne";var d=this.getUrlWithProxy(c);$.ajax({url:d,dataType:"text",context:this,data:b.data,cache:false,success:function(e){b.success.call(b.context,features)},error:function(e,h,g){this.remoteQueryFail(e,h,g)}})};sMap.Module.SPrint.Core=a}());(function(){var b=sMap.Module.SPrint.Core;var a=function(c){this.core=c;this.dialog=$("<div></div>");this.dialog.load("modules/Module/SPrint/PrintControlDialog.html",b.bind(this,this.init))};a.prototype.setCurrentScale=function(){var e=this.map.getScale(),d=this.map.getResolution();var c=parseInt(Math.round(e))+":"+d;$(".sprint-selectscale").val(c).change()};a.prototype.acceptCopyright=function(e,g){e=e||false;var c=e?"Print_":"Export_";var d=this;$("<div>"+this.core.module.printCopyrightNotice+"</div>").dialog({title:"Användarvillkor",autoOpen:true,modal:true,close:function(){$(this).dialog("destroy").empty().remove()},buttons:[{text:"Nej",click:function(){$(this).dialog("close")}},{text:"Jag accepterar",click:function(){$(this).dialog("close");d.print(c,g,{orientation:$(".sprint-orientation:visible:checked").val()||"Portrait",format:$(".sprint-paperformat:visible").val()||"A4"})}}]})};a.prototype.init=function(){var c=this;this.map=this.core.module.map;OpenLayers.DOTS_PER_INCH=this.core.module.DOTS_PER_INCH||OpenLayers.DOTS_PER_INCH;this.dialog.find("input[name='sprint_Export_radLandscape'], input[name='sprint_Print_radLandscape'], #sprint_Export_slctPrintFormat, #sprint_Print_slctPrintFormat").change(function(){c.showExtent()});var e=function(){$(this).prev().click()};this.dialog.find("input[type='checkbox'], input[type='radio']").each(function(){$(this).next().click(e)});this.dialog.dialog({title:"Utskrift",width:370,resizable:false,closeOnEscape:false,open:function(j,i){c.updateScales();c.showExtent();c.setCurrentScale();c.map.events.register("zoomend",c,c.setCurrentScale);c.map.events.register("changebaselayer",c,c.updateScales);c.map.events.register("zoomend",c,c.showExtent);c.map.events.register("moveend",c,c.showExtent)},beforeClose:b.bind(this,this.beforeDialogclose),close:b.bind(this,this.onDialogclose),autoOpen:false});this.tabs=$("#SPrintTabs").tabs({activate:function(i,j){c.showExtent();c.setCurrentScale()}});var g=this;$("#sprint_Print_chkUseMask").click(function(){g.toggleMaskEditing()});if(!this.core.module.usePrintMask){$("#sprint_Print_chkUseMask").hide();$("#sprint_Print_chkUseMaskLbl").hide()}$("#sprint_Print_btnDraw").button();$("#sprint_Print_btnDraw").click(function(){g.toggleDraw()});$("#sprint_Print_btnDraw").hide();$("#sprint_Print_btnClear").button();$("#sprint_Print_btnClear").click(function(){g.clearDraw()});$("#sprint_Print_btnClear").hide();$("#sprint_Print_btnPrint").button();$("#sprint_Print_btnPrint").click(function(){g.acceptCopyright(true,"PDF")});$("#sprint_Export_btnExport").button();$("#sprint_Export_btnExport").click(function(){g.acceptCopyright(false,$("#sprint_Export_slctImageFormat").val())});$("#sprint_Export_btnPreview").button();$("#sprint_Export_btnPreview").click(function(){g.print("Export_","PDF",{orientation:$(".sprint-orientation:visible:checked").val()||"Portrait"})});this.updateScales();var h=this.getCurrentScale(),d=this.map.getResolution();$(".sprint-selectscale").val(h+":"+d);$(".sprint-selectscale").change(function(){var i=$(this).val();if(typeof(i)==="string"&&i.length>0){c.showExtent(parseInt(i.split(":")[0]))}});if(!Array.prototype.indexOf){Array.prototype.indexOf=function(m,n){for(var l=(n||0),k=this.length;l<k;l++){if(this[l]===m){return l}}return -1}}};a.prototype.updateScales=function(){$(".sprint-selectscale").empty();var j,h,g,d=this.map.baseLayer.resolutions||this.map.resolutions||[];for(var e=0,c=d.length;e<c;e++){g=d[e];j=parseInt(Math.round(sMap.util.getScaleFromResolution(g)));h=$('<option value="'+j+":"+g+'">1:'+j+"</option>");$(".sprint-selectscale").each(function(){$(this).append(h.clone())})}this.setCurrentScale()};a.prototype.toggleMaskEditing=function(){if($("#sprint_Print_btnDraw").is(":visible")){$("#sprint_Print_btnDraw").hide();$("#sprint_Print_btnClear").hide();this.maskEditingLayer.setVisibility(false)}else{$("#sprint_Print_btnDraw").show();$("#sprint_Print_btnClear").show();this.addMaskEditingLayer()}};a.prototype.addMaskEditingLayer=function(){if(!this.maskEditingLayer){this.maskEditingLayer=new OpenLayers.Layer.Vector("sprint_maskeditlayer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillOpacity:0,fillColor:"#FFF",strokeWidth:1,strokeOpacity:1,strokeColor:"#F00"}),temporary:new OpenLayers.Style({fillOpacity:0,fillColor:"#FFF",strokeWidth:1,strokeOpacity:1,strokeColor:"#F00"})})});this.map.addLayer(this.maskEditingLayer);this.maskEditingLayer.events.register("featureadded",this,function(c){this.toggleDraw()});this.drawPolygon=new OpenLayers.Control.DrawFeature(this.maskEditingLayer,OpenLayers.Handler.Polygon,{title:"Rita",multi:true});this.map.addControl(this.drawPolygon)}else{this.maskEditingLayer.setVisibility(true)}};a.prototype.toggleDraw=function(){if(this.drawPolygon.active){this.drawPolygon.deactivate()}else{this.drawPolygon.activate()}};a.prototype.clearDraw=function(){this.maskEditingLayer.removeAllFeatures()};a.prototype.addMaskLayer=function(){if(this.maskEditingLayer.features.length>0){if(!this.maskLayer){this.maskLayer=new OpenLayers.Layer.Vector("sprint_masklayer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillOpacity:1,fillColor:"#ffffff",strokeWidth:1,strokeOpacity:1,strokeColor:"#ffffff"})})});this.map.addLayer(this.maskLayer)}var c=this.subtract(this.extentLayer.features[0],this.maskEditingLayer.features);this.maskLayer.addFeatures([c])}};a.prototype.subtract=function(g,e){var c=new OpenLayers.Geometry.Polygon(g.geometry.components);var h=new OpenLayers.Feature.Vector(c);for(var d=0;d<e.length;d++){c.addComponent(e[d].geometry.components[0].components[0])}return h};a.prototype.showExtent=function(t){if(!t||typeof(t)!=="number"){t=this.printScale||this.map.getScale()}this.printScale=t;var p,o=true,g=$("#sprint_Print_btnPrint").is(":visible");i,n;o=$(".sprint-orientation:visible:checked").val();o=o&&typeof(o)==="string"?o.toUpperCase()==="PORTRAIT":true;p=$(".sprint-paperformat:visible").val()||"A4";if(!this.extentLayer){this.extentLayer=new OpenLayers.Layer.Vector("sprint_extentlayer",{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillOpacity:0.1,fillColor:"#00F",strokeWidth:1,strokeOpacity:0.8,strokeColor:"#00F"})})});this.map.addLayer(this.extentLayer)}else{this.extentLayer.destroyFeatures()}var i,n;switch(p){case"A3":if(g){if(o===true){i=758*(96/72);n=1067*(96/72)}else{i=1107*(96/72);n=718*(96/72)}}else{if(o===true){i=842*(96/72);n=1191*(96/72)}else{i=1191*(96/72);n=842*(96/72)}}break;case"A4":if(g){if(o===true){i=511*(96/72);n=718*(96/72)}else{i=758*(96/72);n=471*(96/72)}}else{if(o===true){i=595*(96/72);n=842*(96/72)}else{i=842*(96/72);n=595*(96/72)}}break;case"A5":if(g){if(o===true){i=337*(96/72);n=471*(96/72)}else{i=511*(96/72);n=297*(96/72)}}else{if(o===true){i=393*(96/72);n=538*(96/72)}else{i=525*(96/72);n=393*(96/72)}}break}var d=t/this.map.getScale();i*=d;n*=d;var h=OpenLayers.Geometry.Point,s=this.map.getCenter();var c=this.map.getViewPortPxFromLonLat(s);var e=c.x-i/2,m=c.x+i/2,q=c.y-n/2,l=c.y+n/2;var r=this.map.getLonLatFromPixel(new OpenLayers.Pixel(e,q)),u=this.map.getLonLatFromPixel(new OpenLayers.Pixel(m,l));var k=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new h(r.lon,r.lat),new h(u.lon,r.lat),new h(u.lon,u.lat),new h(r.lon,u.lat),new h(r.lon,r.lat)])]);var j=new OpenLayers.Feature.Vector(k);this.extentLayer.addFeatures([j])};a.prototype.layout=function(c,e){e=e||{};var i=e.format||"A4";var d=e.orientation?e.orientation:"Portrait";var h="NoArrow";var g="NoBar";i=i||$("#sprint_"+c+"slctPrintFormat").val();d=d||$("input[name=sprint_"+c+"radLandscape]:radio:checked").val();if($("#sprint_"+c+"chkNorthArrow:checked").val()!==undefined){h="Arrow"}if($("#sprint_"+c+"chkScaleBar:checked").val()!==undefined){g="Bar"}return[i,d,h,g].join("_")};a.prototype.getCurrentScale=function(){return parseInt(Math.round(OpenLayers.Util.getScaleFromResolution(sMap.map.resolutions[sMap.map.zoom],sMap.map.getUnits())))};a.prototype.print=function(w,r,d){d=d||{};sMap.events.triggerEvent("beforeprint",this,{});var h=d.onSuccess||null,i=d.onError||null,s=d.onComplete||null,c=d.orientation||"Portrait";if($("#sprint_Print_chkUseMask:checked").val()!==undefined){this.addMaskLayer()}if(this.maskEditingLayer){this.maskEditingLayer.setVisibility(false)}if(this.extentLayer){this.map.removeLayer(this.extentLayer)}this.service=w;var m=this;var t=d.map||this.core.module.map;sMap.cmd.loading(true,{bg:true});var e=$.extend({units:t.getUnits(),srs:t.baseLayer.projection.getCode(),layout:this.layout(w,d),dpi:d.dpi||$("#sprint_"+w+"slctResolution:visible").val()||96},null);if(w=="Print_"){e=$.extend({mapTitle:$("#sprint_txtHeader").val(),comment:$("#sprint_txtAreaDescription").val()},e)}var p=[];var j=d.layers||t.layers.concat();j.sort(m.compare);j.splice(j.indexOf(t.baseLayer),1);j.unshift(t.baseLayer);var o=[];$.each(j,function(y,z){if(z.getVisibility()===true){var x=m.encodeLayer(z);x&&p.push(x);if(z.attribution){o.push($(z.attribution).text())}}});e.layers=p;var u,v;if(d.scale&&d.resolution){u=d.scale;v=d.resolution}else{var l=$(".sprint-selectscale:visible").val();u=parseInt(l.split(":")[0]);v=parseFloat(l.split(":")[1])}$.extend({distinct:function(y){var x=[];$.each(y,function(A,z){if($.inArray(z,x)==-1){x.push(z)}});return x}});var q=[];q.push($.extend({center:[t.center.lon,t.center.lat],scale:u,rotation:0,clientResolution:v,copy:$.distinct(o).join(", ")},null));if(w=="Export_"&&r!="PDF"){q[0]=$.extend({printformat:r},q[0])}e.pages=q;var n=w.substring(0,w.length-1).toLowerCase();if($("#sprint_Print_chkPdfUrl:checked").val()!==undefined){var k=JSON.stringify(e),g=location.protocol+"//"+location.host+"/print-servlet/"+n+"/print.pdf?spec="+k;g=g.replace(/å/g,"%E5");g=g.replace(/ä/g,"%E4");g=g.replace(/ö/g,"%F6");g=g.replace(/Å/g,"%C5");g=g.replace(/Ä/g,"%C4");g=g.replace(/Ö/g,"%D6");g=g.replace(/©/g,"%A9");$("<div><div id='print-dialog-pdflink' class='ui-dialog-content ui-widget-content' scrolltop='0' scrollleft='0' style='width: auto; min-height: 0px; height: auto;'><input type='text' readonly value='"+g+"' /></div></div>").dialog({title:"Länk till pdf",autoOpen:true,modal:true,close:function(){$(this).dialog("destroy").empty().remove()}});sMap.cmd.loading(false)}else{$.ajax({type:"POST",url:"/print-servlet/"+n+"/create.json",timeout:d.timeout||20000,data:JSON.stringify(e),contentType:"application/json; charset=UTF-8",dataType:"json",context:this,success:function(x){var y=x.getURL;if(h){h.call(this,y)}else{m.download(y)}},error:function(x,z,y){if(i){i.call(this,x,z,y)}else{alert("printexception "+z+": "+y)}},complete:function(){sMap.cmd.loading(false);if(s){s.call(this)}}})}if(this.maskLayer){this.maskLayer.destroyFeatures();this.map.removeLayer(this.maskLayer);this.maskLayer.destroy();this.maskLayer=null}if(this.extentLayer){this.map.addLayer(this.extentLayer)}if(this.maskEditingLayer){this.maskEditingLayer.setVisibility(true)}};a.prototype.compare=function(d,c){if(d.getZIndex()<c.getZIndex()){return -1}if(d.getZIndex()>c.getZIndex()){return 1}return 0};a.prototype.download=function(c){if($.browser.opera){window.open(c)}else{window.location.href=c}};a.prototype.encodeLayer=function(d){var e=this;var g;for(var h in e.encoders.layers){if(OpenLayers.Layer[h]&&d instanceof OpenLayers.Layer[h]){g=e.encoders.layers[h].call(e,d);break}}return(g&&g.type)?g:null};a.prototype.encoders={layers:{Layer:function(d){var c={};if(d.options&&d.options.maxScale){c.minScaleDenominator=d.options.maxScale}if(d.options&&d.options.minScale){c.maxScaleDenominator=d.options.minScale}return c},WMS:function(e){var d=sMap.cmd.getLayerConfig(e.name);var c=this.encoders.layers.HTTPRequest.call(this,e);$.extend(c,{type:"WMS",layers:[e.params.LAYERS].join(",").split(","),format:e.params.FORMAT,styles:[e.params.STYLES].join(",").split(",")});var h;for(var g in e.params){h=g.toLowerCase();if(!e.DEFAULT_PARAMS[h]&&"layers,styles,width,height,srs".indexOf(h)==-1){if(!c.customParams){c.customParams={}}c.customParams[g]=e.params[g]}}c.baseURL=d.printURL?d.printURL:c.baseURL;c.format=d.printFormat?d.printFormat:c.format;c.layers=d.printLayers?[d.printLayers]:c.layers;if(d.printParamDPI){c.customParams.DPI=$("#sprint_"+this.service+"slctResolution").val()}return c},OSM:function(d){var c=this.encoders.layers.TileCache.call(this,d);return $.extend(c,{type:"OSM",baseURL:c.baseURL.substr(0,c.baseURL.indexOf("$")),extension:"png"})},TMS:function(d){var c=this.encoders.layers.TileCache.call(this,d);return $.extend(c,{type:"TMS",format:d.type})},TileCache:function(d){var c=this.encoders.layers.HTTPRequest.call(this,d);return $.extend(c,{type:"TileCache",layer:d.layername,maxExtent:d.maxExtent.toArray(),tileSize:[d.tileSize.w,d.tileSize.h],extension:d.extension,resolutions:d.serverResolutions||d.resolutions})},WMTS:function(d){var c=this.encoders.layers.HTTPRequest.call(this,d);return $.extend(c,{type:"WMTS",layer:d.layer,version:d.version,requestEncoding:d.requestEncoding,tileOrigin:[d.tileOrigin.lon,d.tileOrigin.lat],tileSize:[d.tileSize.w,d.tileSize.h],style:d.style,formatSuffix:d.formatSuffix,dimensions:d.dimensions,params:d.params,maxExtent:(d.tileFullExtent!=null)?d.tileFullExtent.toArray():d.maxExtent.toArray(),matrixSet:d.matrixSet,zoomOffset:d.zoomOffset,resolutions:d.serverResolutions||d.resolutions})},KaMapCache:function(d){var c=this.encoders.layers.KaMap.call(this,d);return $.extend(c,{type:"KaMapCache",group:d.params.g,metaTileWidth:d.params.metaTileSize["w"],metaTileHeight:d.params.metaTileSize["h"]})},KaMap:function(d){var c=this.encoders.layers.HTTPRequest.call(this,d);return $.extend(c,{type:"KaMap",map:d.params.map,extension:d.params.i,group:d.params.g||"",maxExtent:d.maxExtent.toArray(),tileSize:[d.tileSize.w,d.tileSize.h],resolutions:d.serverResolutions||d.resolutions})},HTTPRequest:function(d){var c=this.encoders.layers.Layer.call(this,d);return $.extend(c,{baseURL:this.getAbsoluteUrl(d.url instanceof Array?d.url[0]:d.url),opacity:(d.opacity!=null)?d.opacity:1,singleTile:d.singleTile})},Image:function(d){var c=this.encoders.layers.Layer.call(this,d);return $.extend(c,{type:"Image",baseURL:this.getAbsoluteUrl(d.getURL(d.extent)),opacity:(d.opacity!=null)?d.opacity:1,extent:d.extent.toArray(),pixelSize:[d.size.w,d.size.h],name:d.name})},Vector:function(q){if(!q.features.length){return}var p=[];var s={};var e=q.features;var t=new OpenLayers.Format.GeoJSON();var g=new OpenLayers.Format.JSON();var d=1;var n={};var u,c,m,o,h;for(var l=0,r=e.length;l<r;++l){u=e[l];c=u.style||q.style||q.styleMap.createSymbolizer(u,u.renderIntent);m=g.write(c);o=n[m];if(o){h=o}else{if(c.fillColor){c.fillColor=this.to16Bit(c.fillColor)}if(c.strokeColor){c.strokeColor=this.to16Bit(c.strokeColor)}if(c.fontColor){c.fontColor=this.to16Bit(c.fontColor)}n[m]=h=d++;if(c.externalGraphic){c.externalGraphic=this.getAbsoluteUrl(c.externalGraphic);s[h]=$.extend({externalGraphic:c.externalGraphic},c)}else{s[h]=c}}var j=t.extract.feature.call(t,u);delete j.properties.style;j.properties=OpenLayers.Util.extend({_gx_style:h},j.properties);p.push(j)}var k=this.encoders.layers.Layer.call(this,q);return $.extend(k,{type:"Vector",styles:s,styleProperty:"_gx_style",geoJson:{type:"FeatureCollection",features:p},name:q.name,opacity:(q.opacity!=null)?q.opacity:1})},Markers:function(k){var d=[];for(var h=0,l=k.markers.length;h<l;h++){var j=k.markers[h];var m=new OpenLayers.Geometry.Point(j.lonlat.lon,j.lonlat.lat);var c={externalGraphic:j.icon.url,graphicWidth:j.icon.size.w,graphicHeight:j.icon.size.h,graphicXOffset:j.icon.offset.x,graphicYOffset:j.icon.offset.y};var n=new OpenLayers.Feature.Vector(m,{},c);d.push(n)}var g=new OpenLayers.Layer.Vector(k.name);g.addFeatures(d);var e=this.encoders.layers.Vector.call(this,g);g.destroy();return e}},legends:{gx_wmslegend:function(l,d){var g=this.encoders.legends.base.call(this,l);var m=[];for(var h=1,j=l.items.getCount();h<j;++h){var c=l.items.get(h).url;if(l.useScaleParameter===true&&c.toLowerCase().indexOf("request=getlegendgraphic")!=-1){var k=c.split("?");var e={};(function(){var i,o=/\+/g,n=/([^&=]+)=?([^&]*)/g,p=function(q){return decodeURIComponent(q.replace(o," "))};while(i=n.exec(k[1])){urlParams[p(i[1])]=p(i[2])}})();e.SCALE=d;c=k[0]+"?"+$.param(e)}m.push(this.getAbsoluteUrl(c))}g[0].classes[0]={name:"",icons:m};return g},gx_urllegend:function(d){var c=this.encoders.legends.base.call(this,d);c[0].classes.push({name:"",icon:this.getAbsoluteUrl(d.items.get(1).url)});return c},base:function(c){return[{name:c.getLabel(),classes:[]}]}}};a.prototype.to16Bit=function(c){var d=new RegExp("^#([0-9a-f]{3})$");if(c.match(d)){var e=[c.substring(1,2),c.substring(2,3),c.substring(3,4)];c="#"+e.join("0")+"0"}return c};a.prototype.getAbsoluteUrl=function(e){var d;var c=parseInt($.browser.version,10);if($.browser.msie&&(c===6||c===7||c===8)){d=document.createElement("<a href='"+e+"'/>");d.style.display="none";document.body.appendChild(d);d.href=d.href;document.body.removeChild(d)}else{d=document.createElement("a");d.href=e}return d.href};a.prototype.beforeDialogclose=function(c){if(this.maskEditingLayer&&this.maskEditingLayer.visibility){$("#sprint_Print_chkUseMask").prop("checked",false);this.toggleMaskEditing()}};a.prototype.onDialogclose=function(c){this.core.module.deactivate();this.map.events.unregister("zoomend",this,this.showExtent);this.map.events.unregister("zoomend",this,this.setCurrentScale);this.map.events.unregister("changebaselayer",this,this.updateScales);this.map.events.unregister("moveend",this,this.showExtent);this.extentLayer.destroyFeatures();this.map.removeLayer(this.extentLayer);this.extentLayer.destroy();this.extentLayer=null;return true};sMap.Module.SPrint.PrintControlDialog=a}());sMap.Module.Toolbar=OpenLayers.Class(sMap.Module,{buttonsConfig:{},appendIsPresent:false,functionIsBound:false,EVENT_LISTENERS:["addtoolbutton","addtoolbuttontogglegroup","addtoolbuttonradiogroup","addtoolentry","removeitem","addselect"],EVENT_TRIGGERS:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.Toolbar.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.Toolbar.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.extend(this,a);sMap.Module.prototype.initialize.apply(this,[a]);$(this.div).empty().remove();this.div=null},activate:function(){if(this.active===true){return false}return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){var a=this;$(this.toolbarDiv).children().find(".toolbar-button").each(function(){var c=$(this).data("caller");var b=a.map.getControlsByClass(c)[0];if(b){b.destroy()}});$(this.toolbarDiv).empty().remove();$(this.div).remove();sMap.events.triggerEvent("removetoolbardiv",this,{});return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){sMap.events.triggerEvent("addtoolbardiv",this,{height:this.height});this.toolbarDiv=$("<div id='toolbar-maindiv' />");$("#toolbarDiv").append(this.toolbarDiv).addClass("ui-widget-header");this.toolbarDiv.addClass("ui-widget-header");if(this.addLogotype){var a=$("<div id='toolbar-logo' class='toolbar-logo' ></div>");var b=$("<img src='"+this.logoImgURL+"' alt='"+this.lang.logoAltText+"' width='"+this.logoWidth+"' onclick='window.open(\""+this.logoLinkURL+'","homepage");\'>');a.append(b);this.toolbarDiv.append(a)}if(this.title){var c=$("<div id='toolbar-title' class='toolbar-title'></div>");c.html(this.title);if(this.titleCss){c.css(this.titleCss)}this.toolbarDiv.append(c)}},addtoolbutton:function(a){this._addtoolbutton(a);this.redrawPosition()},addselect:function(a){this._addselect(a);this.redrawPosition()},addtoolentry:function(c){var a=$("<div class='toolbar-entry-cont'><input class='toolbar-entry' type='text'></input></div>");a.data("index",c.index);var b=c.margin||(this.toolbarDiv.children().length==0?this.buttonMarginInitial:this.buttonMargin);this.toolbarDiv.append(a);if(c.tagID){a.prop("id",c.tagID)}this.redrawPosition();this.fixCSS()},addtoolbuttontogglegroup:function(a){this._addtoolbuttontogglegroup(a);this.redrawPosition();this.fixCSS()},addtoolbuttonradiogroup:function(a){this._addtoolbuttonradiogroup(a);this.redrawPosition();this.fixCSS()},removeitem:function(d){var c=d.item;if(c[0].tagName.toUpperCase()=="label"){var b=c.prop("for");c.siblings("#"+b).button("destroy").empty().remove()}else{if(c.is("input:checkbox")){var b=c.prop("id");var a=c.siblings("label[for='"+b+"']");c.button("destroy");a.empty().remove()}else{if(c.is("div.ui-buttonset")){c.buttonset("destroy")}}}c.empty().remove();if(d.doNotRedrawPosition!==true){this.redrawPosition()}this.fixCSS()},redrawPosition:function(){var a=this,c=a.toolbarDiv.children("div.ui-buttonset, .toolbar-entry-cont, label, select");if(c.length<=1){return false}var b=[];$.each(c,function(e,h){var g=$(this);if(typeof g.data("index")==="undefined"){return true}var d={};if(a.appendIsPresent===g.data("index")&&typeof g.data("append")==="undefined"){g.data("index",a.appendIsPresent+1)}d.arrPlace=e;d.sortIndex=g.data("index");b.push(d)});b.sort(function(e,d){return parseFloat(e.sortIndex)-parseFloat(d.sortIndex)});$.each(b,function(d,g){var e=this["arrPlace"];a.toolbarDiv.append($(c[e]))})},fixCSS:function(){var b=$("#toolbar-maindiv").children(".toolbar-entry-cont, label, div.ui-buttonset");var a=this;b.each(function(){a.fixTagCSS.call(a,$(this))})},fixTagCSS:function(a){if(sMap.db.browser.msie){var c=a.length?a[0].tagName.toUpperCase()=="INPUT":false;var b=this.toolbarDiv.find("input:text").length>0;if(parseInt(sMap.db.browser.version)==7){if(a.button&&a.buttonLabel){a=a.buttonLabel}else{}}}},_addtoolbutton:function(d){d.toggle=d.toggle==undefined?true:d.toggle;if(d.bindActivation!==false&&!(d.on||d.off)){d.bindActivation=true}var c=this;var a=this.makeButton(d);var e=a.button,h=a.buttonLabel;h.data("index",d.index);e.attr("unselectable","on").addClass("unselectable");h.attr("unselectable","on").addClass("unselectable");if(d.appendToSearch==true){var i=$("#searchBox").data("index");h.data("index",i);h.data("append",true);$("#searchBox").data("append",true);c.appendIsPresent=i;var g=2}else{var g=this.toolbarDiv.children().length==0?this.buttonMarginInitial:this.buttonMargin}g=d.margin||g;this.toolbarDiv.append(e).append(h);e.button({text:!d.label?false:true,icons:{primary:d.iconCSS}});this.fixCSS()},_addselect:function(b){var c=b.selectObject;c.attr("unselectable","on").addClass("unselectable");var a=b.caller;c.data("caller",a.CLASS_NAME);if(b.appendToSearch==true){var e=$("#searchBox").data("index");c.data("index",e);c.data("append",true);var d=2}else{var d=this.toolbarDiv.children().length==0?this.buttonMarginInitial:this.buttonMargin;c.data("index",b.index)}this.toolbarDiv.append(c);this.fixCSS()},makeButton:function(c){var b=c.caller;var g=c.hoverText?c.hoverText:"";var d=$("<input type='checkbox' id='"+c.tagID+"' />"),e=$("<label for='"+c.tagID+"' title='"+g+"'>"+c.label+"</label>");d.data("funcOn",c.on||b.activate);d.data("funcOff",c.off||b.deactivate);d.data("caller",b.CLASS_NAME);if(c.bindActivation===true&&b.events){b.events.register("activate",this,function(){this.renderButtonAsActive(d)});b.events.register("deactivate",this,function(){var h=d.prop("checked");if(h){this.renderButtonAsInactive(d)}})}var a=this;d.click(function(h){if(!$(this).prop("checked")){if(c.toggle!==false){var i=$(this).data("funcOff").call(b);if(!i){a.renderButtonAsActive($(this))}else{a.renderButtonAsInactive($(this))}}}else{var i=$(this).data("funcOn").call(b);if(!i){a.renderButtonAsInactive($(this))}else{a.renderButtonAsActive($(this))}}});return{button:d,buttonLabel:e}},renderButtonAsActive:function(c){c.prop("checked",true);var b=c.prop("id");var a=c.siblings("label[for='"+b+"']");a.addClass(this.toolbarButtonActiveCSSClass)},renderButtonAsInactive:function(c){c.prop("checked",false);var b=c.prop("id");var a=c.siblings("label[for='"+b+"']");a.removeClass(this.toolbarButtonActiveCSSClass);a.removeClass("ui-state-focus")},_addtoolbuttontogglegroup:function(d){var k=d.buttons,j=$("<div />"),c=null,g=null;var h=this.toolbarDiv.children().length==0?this.buttonMarginInitial:this.buttonMargin;this.toolbarDiv.append(j);for(var e=0,a=k.length;e<a;e++){g=k[e];g.caller=d.caller;c=this.makeButton(g);j.append(c.button).append(c.buttonLabel);c.button.button({text:!g.label?false:true,icons:{primary:g.iconCSS}})}j.buttonset();j.data("index",d.index);$(j).css({position:"relative",display:"inline"});this.fixCSS()},_addtoolbuttonradiogroup:function(d){var k=d.buttons,j=$("<div />"),c=null,g=null;var h=this.toolbarDiv.children().length==0?this.buttonMarginInitial:this.buttonMargin;this.toolbarDiv.append(j);for(var e=0,a=k.length;e<a;e++){g=k[e];g.caller=d.caller;c=this.makeRadioButton(g);j.append(c.button).append(c.buttonLabel);c.button.button({text:!g.label?false:true,icons:{primary:g.iconCSS||null}})}j.buttonset();j.data("index",d.index);this.fixCSS()},makeRadioButton:function(c){var d=$("<input type='radio' id='"+c.tagID+"' name='radio' />"),e=$("<label for='"+c.tagID+"'>"+c.label+"</label>");var b=c.caller;d.data("funcOn",c.on||b.activate);d.data("funcOff",c.off||b.deactivate);d.data("caller",b.CLASS_NAME);if(c.bindActivation===true&&b.events){b.events.register("activate",this,function(){var g=d.prop("checked")===true;if(g){this.renderButtonAsActive(d)}});b.events.register("deactivate",this,function(){var g=d.prop("checked")===true;if(g){this.renderButtonAsInactive(d)}})}var a=this;d.click(function(g){var h=d.parent().find("input[checked!=true]");h.each(function(){$(this).prop("checked",false).removeClass("ui-state-active");$(this).data("funcOff").call(b)});if($(this).prop("checked")===true){if(c.toggle!==false){$(this).data("funcOn").call(b)}}});return{button:d,buttonLabel:e}},CLASS_NAME:"sMap.Module.Toolbar"});sMap.moduleConfig.Toolbar={activateFromStart:false,height:38,toolbarButtonActiveCSSClass:"ui-state-active",side:"left",buttonMargin:15,buttonMarginInitial:10,addLogotype:false,logoImgURL:"http://kartor.kristianstad.se/img/bild/Kristianstad_logo_endastvapen_rgb.gif",logoLinkURL:"http://www.kristianstad.se",logoWidth:60,title:""};sMap.Lang.lang.Toolbar={"sv-SE":{test:"Test",logoAltText:"Länk till hemsidan"},en:{test:"Test",logoAltText:"Link to homepage"}};sMap.Module.ToolsMenu=OpenLayers.Class(sMap.Module,{EVENT_LISTENERS:["addtomenu","removebtnfromtoolsmenu"],EVENT_TRIGGERS:[],modulesInToolsMenu:[],addTheseToMenu:[],toolsMenuDivs:[],initialize:function(a){a=a||{};this.EVENT_LISTENERS=sMap.Module.ToolsMenu.prototype.EVENT_LISTENERS.concat(sMap.Module.prototype.EVENT_LISTENERS);this.EVENT_TRIGGERS=sMap.Module.ToolsMenu.prototype.EVENT_TRIGGERS.concat(sMap.Module.prototype.EVENT_TRIGGERS);OpenLayers.Util.applyDefaults(this,a);sMap.Module.prototype.initialize.apply(this,[a])},activate:function(){if(this.active===true){return false}var a=this;$.each(a.toolsMenuDivs,function(b,c){a.drawToolsMenu(c.menu,c.id)});$.each(a.addTheseToMenu,function(b,c){a.addtooltotoolsmenu(c.btn,c.config)});setTimeout(function(){var b=$(".toolsmenu-mainbutton");b.each(function(){$(this).removeClass("ui-state-active")})},20);return sMap.Module.prototype.activate.apply(this,arguments)},deactivate:function(){if(this.active!==true){return false}$(".toolsmenu-dropdown").each(function(){$(this).empty().remove()});return sMap.Module.prototype.deactivate.apply(this,arguments)},destroy:function(){return sMap.Module.prototype.destroy.apply(this,arguments)},drawContent:function(){var a=this,b=a.menuBtns;$.each(b,function(e,h){var c="button-toolsmenu"+h.menuId;sMap.events.triggerEvent("addtoolbutton",a,{index:h.toolBarIndex||1,label:h.lblText||a.lang.labelText,iconCSS:"ui-icon-triangle-1-s",tagID:c});var d=$("label[for='"+c+"']");d.addClass("toolsmenu-mainbutton");if(h.marginRight){d.css("margin-right",h.marginRight)}var j=a.createToolsMenu(c,h.menuId);j.attr("unselectable","on").addClass("unselectable");var g={menu:j,id:h.menuId};a.toolsMenuDivs.push(g)});var a=this;$(window).resize(function(){setTimeout(function(){a.positionDropDowns()},200)})},drawToolsMenu:function(c,b){var a=c;$("#toolbar-maindiv").append(a)},positionDropDowns:function(){$(".toolsmenu-dropdown").each(function(){var c=$(this);var d="button-toolsmenu"+c.attr("id").replace("toolsmenu-dropdown","");var b=$("label[for='"+d+"']");var e=b.offset(),a=b.outerHeight();$(c).css({left:e.left,position:"absolute",top:b.position().top+a-3})})},createToolsMenu:function(h,g){var c=this,e="toolsmenu-dropdown"+g;var a=$("<div id='"+e+"' />"),b=$("label[for='"+h+"']");a.addClass("toolsmenu-dropdown ui-widget-content ui-state-default");var d=$("label[for='"+h+"']").width();a.css("min-width",d+"px");a.hide();b.click(function(i){if($("#"+e).is(":visible")){c.renderBtnAsInactive($("#"+h));$("#"+e).hide();i.preventDefault()}else{c.renderBtnAsActive($("#"+h));$("#"+e).show();i.preventDefault()}});b.hover(function(){c.renderBtnAsActive($("#"+h));$("#"+e).show()},function(){a.hover(function(){c.renderBtnAsActive($("#"+h));$("#"+e).show()},function(){c.renderBtnAsInactive($("#"+h));$("#"+e).hide()})});b.mouseleave(function(i){c.renderBtnAsInactive($("#"+h));$("#"+e).hide()});return a},drawPosition:function(h){var b=this,e=h.children(".toolsmenu-rows");if(e.length<=1){return false}for(var d=e.length-1;d>=0;d--){var g=$(e[d]);var c=g.children("label").data("index");if(c!=d){if(c>=(e.length)){h.append(g)}var a=$(e[c]).children("div.ui-buttonset, input:text, label");if(a.data("index")===c){a.data("index",c+1)}}e=h.children(".toolsmenu-rows")}},renderBtnAsActive:function(c){c.prop("checked",true);var b=c.prop("id");var a=c.siblings("label[for='"+b+"']");a.addClass(this.toolbarBtnActiveCSSClass)},renderBtnAsInactive:function(c){c.prop("checked",false);var b=c.prop("id");var a=c.siblings("label[for='"+b+"']");a.removeClass(this.toolbarBtnActiveCSSClass)},removebtnfromtoolsmenu:function(g){var b=this,a=g.lblToDel;var d=$.inArray(a,b.modulesInToolsMenu);if(d==-1){return}b.modulesInToolsMenu.splice(d,1);var h=$(".toolsmenu-dropdown").children(".toolsmenu-rows").find("label[for='"+a+"']");h.siblings("#"+a).button("destroy").empty().remove();h.empty().remove();if(g.doNotRedrawPosition!==true){var c=$(".toolsmenu-dropdown");$.each(c,function(){b.drawPosition($(this))})}},makeBtn:function(c){var a=this,b=c.caller,g=c.hoverText?c.hoverText:"";var e=$("<input type='checkbox' id='"+c.tagID+"' />"),d=$("<label for='"+c.tagID+"' title='"+g+"'>"+c.label+"</label>");e.data("funcOn",c.on||b.activate);e.data("funcOff",c.off||b.deactivate);e.data("caller",b.CLASS_NAME);d.data("index",c.index);if(c.bindActivation===true&&b.events){b.events.register("activate",this,function(){var h=e;var i=h.prop("checked")?true:false;if(i){a.renderBtnAsActive(h)}});b.events.register("deactivate",this,function(){var h=e;var i=h.prop("checked");if(i){a.renderBtnAsInactive(h)}})}e.click(function(h){if(!$(this).prop("checked")){if(c.toggle!==false){var i=$(this).data("funcOff").call(b);if(!i){a.renderBtnAsActive($(this))}else{a.renderBtnAsInactive($(this))}}}else{var i=$(this).data("funcOn").call(b);if(!i){a.renderBtnAsInactive($(this))}else{a.renderBtnAsActive($(this))}}});return{button:e,buttonLabel:d}},doubleCheck:function(b){var c=this.modulesInToolsMenu,a=$.inArray(b,c);if(a!=-1){return false}else{c[c.length]=b;return b}},addtomenu:function(b){var a=this;var d=a.doubleCheck(b.tagID);if(d===false){return false}b.toggle=b.toggle==undefined?true:b.toggle;if(b.bindActivation!==false&&!(b.on||b.off)){b.bindActivation=true}var c=a.makeBtn(b);if(a.active===true){a.addtooltotoolsmenu(c,b)}else{var e={btn:c,config:b};a.addTheseToMenu.push(e)}},addtooltotoolsmenu:function(d,c){var b=$("#toolsmenu-dropdown"+c.menuId).length?$("#toolsmenu-dropdown"+c.menuId):$("#toolsmenu-dropdown"+this.menuBtns[0].menuId);var g=d.button,e=d.buttonLabel,a=$("<div class='toolsmenu-rows' />");a.append(g).append(e);b.append(a);g.button({text:!c.label?false:true,icons:{primary:c.iconCSS}});a.children(".ui-button").css({display:"block",margin:"0"});this.drawPosition(b)},CLASS_NAME:"sMap.Module.ToolsMenu"});sMap.moduleConfig.ToolsMenu={activateFromStart:true,toolbarBtnActiveCSSClass:"ui-state-active",menuBtns:[{menuId:5,lblText:"sMap++",toolBarIndex:2}]};sMap.Lang.lang.ToolsMenu={"sv-SE":{labelText:"Fler verktyg",noToolsText:"Inga verktyg"},en:{labelText:"More tools",noToolsText:"No tools"}};